---
- name: Data Collection for CIS 1.1.1.4
  hosts: all
  become: yes
  gather_facts: no
  vars:
    cis_reference: "CIS RHEL 8 Benchmark v4.0.0 checkpoint 1.1.1.4"
    req_1: "Run script to verify hfsplus kernel module is NOT available in the filesystem"
    req_2: "If req_1 returns output, verify hfsplus kernel module is NOT loaded"
    req_3: "If req_1 returns output, verify hfsplus kernel module is blacklisted and configured to not load"
    req_4: "OVERALL Verify: Ensure hfsplus kernel module is not available"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        data_3: ""
        task_1_name: "Not executed"
        task_2_name: "Not executed"
        task_3_name: "Not executed"
        task_1_cmd: "N/A"
        task_2_cmd: "N/A"
        task_3_cmd: "N/A"
        task_1_rc: -1
        task_2_rc: -1
        task_3_rc: -1
        status_1: "UNKNOWN"
        status_2: "NA"
        status_3: "NA"
        status_4: "UNKNOWN"
        rationale_1: "Not evaluated"
        rationale_2: "Task skipped - req_1 returned no output"
        rationale_3: "Task skipped - req_1 returned no output"
        rationale_4: "Not evaluated"

    # Requirement 1: Run script to verify hfsplus kernel module is NOT available in the filesystem
    - name: "Req 1 - Create temporary audit script"
      copy:
        dest: "/tmp/cis_audit_script_1.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_mod_name="hfsplus" l_mod_type="fs"
             while IFS= read -r l_mod_path; do
                if [ -d "$l_mod_path/${l_mod_name//-/\/}" ] &&  \
                [ -n "$(ls -A "$l_mod_path/${l_mod_name//-/\/}")" ]; then
                   printf '%s\n' "$l_mod_name exists in $l_mod_path"
                fi
             done < <(readlink -e /usr/lib/modules/**/kernel/$l_mod_type \
             || readlink -e /lib/modules/**/kernel/$l_mod_type)
          }
          {% endraw %}
      register: script_created_1
      ignore_errors: true
      failed_when: false

    - name: "Req 1 - Execute audit script"
      shell: "/tmp/cis_audit_script_1.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: "Req 1 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_script_1.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 1 details and determine status
      set_fact:
        task_1_name: "Check if hfsplus module exists in filesystem"
        task_1_cmd: "CIS audit script (see above)"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim == '') else 'FAIL') | trim }}"
        rationale_1: "PASS when script returns NO output (module not found) OR if the module is built into the kernel (also returns no output), FAIL when script returns any output indicating the module exists as a loadable module"

    # Requirement 2: If req_1 returns output, verify hfsplus kernel module is NOT loaded
    - name: "Req 2 - Check if hfsplus module is loaded"
      shell: |
        lsmod | grep 'hfsplus'
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: data_1 | trim != ''

    - name: Store requirement 2 details and determine status
      set_fact:
        task_2_name: "Check if hfsplus module is loaded"
        task_2_cmd: "lsmod | grep 'hfsplus'"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: "{{ ('PASS' if (result_2.stdout | default('') | trim == '') else 'FAIL') | trim }}"
        rationale_2: "PASS when command returns NO output (module not loaded), FAIL when output shows the module is loaded"
      when: data_1 | trim != ''

    # Requirement 3: If req_1 returns output, verify hfsplus kernel module is blacklisted and configured to not load
    - name: "Req 3 - Check if hfsplus module is blacklisted"
      shell: |
        modprobe --showconfig | grep -P -- '\b(install|blacklist)\h+hfsplus\b'
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: data_1 | trim != ''

    - name: Store requirement 3 details and determine status
      set_fact:
        task_3_name: "Check if hfsplus module is blacklisted"
        task_3_cmd: |
          modprobe --showconfig | grep -P -- '\b(install|blacklist)\h+hfsplus\b'
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: >
          {{ (
            'PASS' if (
              result_3.stdout | default('') | trim | length > 0 and
              'blacklist hfsplus' in result_3.stdout and
              ('install hfsplus /bin/false' in result_3.stdout or 'install hfsplus /bin/true' in result_3.stdout)
            ) else 'FAIL'
          ) | trim }}
        rationale_3: "PASS when output contains BOTH 'blacklist hfsplus' AND ( 'install hfsplus /bin/false' OR 'install hfsplus /bin/true' ), FAIL otherwise"
      when: data_1 | trim != ''

    # Requirement 4: OVERALL Verify
    - name: Determine overall compliance status
      set_fact:
        status_4: >
          {{ (
            'PASS' if (
              status_1 | trim == 'PASS' or
              (status_1 | trim == 'FAIL' and status_2 | trim == 'PASS' and status_3 | trim == 'PASS')
            ) else 'FAIL'
          ) | trim }}
        rationale_4: "PASS when (req_1=PASS) OR (req_1=FAIL AND req_2=PASS AND req_3=PASS), FAIL otherwise"

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.1.1.4"
          - "========================================================"
          - "Reference: {{ cis_reference }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('NA') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('NA') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - "========================================================"