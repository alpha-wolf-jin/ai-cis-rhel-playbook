---
- name: Data Collection for CIS 1.7.1
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    kcs_article: "CIS RHEL 8 Benchmark v4.0.0 checkpoint 1.7.1"
    req_1: |
      Run the following script to verify MOTD files do not contain system information: [script]. Rationale: PASS when the script output indicates 'No MOTD files include system information' or lists files for manual review, FAIL when the script output indicates any MOTD file includes system information (\v, \r, \m, \s, or OS name).
    req_2: "OVERALL Verify: Ensure /etc/motd is configured. Rationale: PASS when req_1=PASS, FAIL otherwise"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: "Not collected yet"
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        data_2: "Not collected yet"
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Run the following script to verify MOTD files do not contain system information: [script]. Rationale: PASS when the script output indicates 'No MOTD files include system information' or lists files for manual review, FAIL when the script output indicates any MOTD file includes system information (\v, \r, \m, \s, or OS name).
    - name: "Req 1 - Create temporary audit script"
      copy:
        dest: "/tmp/cis_audit_1.7.1.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_output="" l_output2=""
             a_files=()
             for l_file in /etc/motd{,.d/*}; do
                if grep -Psqi -- "(\\\v|\\\r|\\\m|\\\s|\b$(grep ^ID= /etc/os-release | cut -d= -f2 | sed -e 's/"//g')\b)" "$l_file"; then
                   l_output2="$l_output2\n - File: \"$l_file\" includes system information"
                else
                   a_files+=("$l_file")
                fi
             done
             if [ "${#a_files[@]}" -gt 0 ]; then
                echo -e "\n-  ** Please review the following files and verify their contents follow local site policy **\n"
                printf '%s\n' "${a_files[@]}"
             elif [ -z "$l_output2" ]; then
                echo -e "- ** No MOTD files with any size were found. Please verify this conforms to local site policy ** -"
             fi
             if [ -z "$l_output2" ]; then
                l_output=" - No MOTD files include system information"
                echo -e "\n- Audit Result:\n  ** PASS **\n$l_output\n"
             else
                echo -e "\n- Audit Result:\n  ** FAIL **\n - Reason(s) for audit failure:\n$l_output2\n"
             fi
          }
          {% endraw %}
      register: script_created_1
      ignore_errors: true
      failed_when: false

    - name: "Req 1 - Execute audit script"
      shell: "/tmp/cis_audit_1.7.1.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: "Req 1 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_1.7.1.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Execute CIS audit script for MOTD files"
        task_1_cmd: "/tmp/cis_audit_1.7.1.sh"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if ('No MOTD files include system information' in result_1.stdout or 'Please review the following files' in result_1.stdout or 'No MOTD files with any size were found' in result_1.stdout) else 'FAIL') | trim }}"
        rationale_1: "{{ 'PASS when script output indicates No MOTD files include system information or lists files for manual review, FAIL when script indicates any MOTD file includes system information' | trim }}"

    # Requirement 2: OVERALL Verify: Ensure /etc/motd is configured. Rationale: PASS when req_1=PASS, FAIL otherwise
    - name: "Req 2 - Check /etc/motd configuration"
      shell: |
        if [ -f /etc/motd ]; then
          echo "/etc/motd exists"
        else
          echo "/etc/motd does not exist"
        fi
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Check /etc/motd configuration"
        task_2_cmd: "Check if /etc/motd exists"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: "{{ status_1 | trim }}"
        rationale_2: "{{ 'PASS when req_1=PASS, FAIL otherwise' | trim }}"

    # Final report - MUST include Status and Rationale for each requirement
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.7.1"
          - "========================================================"
          - "Reference: CIS RHEL 8 Benchmark v4.0.0 checkpoint 1.7.1"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - "========================================================"