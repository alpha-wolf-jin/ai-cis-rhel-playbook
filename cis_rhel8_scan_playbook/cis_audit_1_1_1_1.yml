---
- name: Data Collection for CIS 1.1.1.1
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.1.1"
    req_1: "Run the provided CIS audit script to verify Ensure cramfs kernel module is not available. Verify the cramfs kernel module is not available on the system or has been disabled."

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1

    # Requirement 1: Execute CIS audit script for cramfs module
    - name: Req 1 - Execute CIS audit script for cramfs module availability
      copy:
        dest: "/tmp/cis_audit_1.1.1.1.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_mod_name="cramfs" l_mod_type="fs"
             while IFS= read -r l_mod_path; do
                if [ -d "$l_mod_path/${l_mod_name//-/\/}" ] &&  \
                [ -n "$(ls -A "$l_mod_path/${l_mod_name//-/\/}")" ]; then
                   printf '%s\n' "$l_mod_name exists in $l_mod_path"
                fi
             done < <(readlink -e /usr/lib/modules/**/kernel/$l_mod_type \
             || readlink -e /lib/modules/**/kernel/$l_mod_type)
          }
          {% endraw %}
      register: script_create_1
      ignore_errors: true

    - name: Req 1 - Execute the audit script
      shell: "/tmp/cis_audit_1.1.1.1.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_1.1.1.1.sh"
        state: absent
      ignore_errors: true

    # Conditional checks if cramfs module exists
    - name: Req 1 - Check if cramfs module is loaded (conditional)
      shell: |
        lsmod | grep 'cramfs'
      args:
        executable: /bin/bash
      register: result_1_lsmod
      ignore_errors: true
      changed_when: false
      when: result_1.stdout | default('') | trim != ''

    - name: Req 1 - Check if cramfs module is loadable (conditional)
      shell: |
        modprobe --showconfig | grep -P -- '\b(install|blacklist)\h+cramfs\b'
      args:
        executable: /bin/bash
      register: result_1_modprobe
      ignore_errors: true
      changed_when: false
      when: result_1.stdout | default('') | trim != ''

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Execute CIS audit script for cramfs module availability"
        task_1_cmd: "Temporary script /tmp/cis_audit_1.1.1.1.sh"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: |
          Script output: {{ result_1.stdout | default('') | trim }}
          {% if result_1_lsmod is defined %}
          lsmod output: {{ result_1_lsmod.stdout | default('') | trim }}
          {% endif %}
          {% if result_1_modprobe is defined %}
          modprobe output: {{ result_1_modprobe.stdout | default('') | trim }}
          {% endif %}
        status_1: >-
          {% set script_output = result_1.stdout | default('') | trim %}
          {% if script_output == '' %}
            PASS
          {% else %}
            {% set lsmod_output = result_1_lsmod.stdout | default('') | trim if result_1_lsmod is defined else '' %}
            {% set modprobe_output = result_1_modprobe.stdout | default('') | trim if result_1_modprobe is defined else '' %}
            {% if lsmod_output == '' and ('blacklist cramfs' in modprobe_output) and ('install cramfs /bin/false' in modprobe_output or 'install cramfs /bin/true' in modprobe_output) %}
              PASS
            {% else %}
              FAIL
            {% endif %}
          {% endif %}
        rationale_1: >-
          {% set script_output = result_1.stdout | default('') | trim %}
          {% if script_output == '' %}
            PASS: cramfs kernel module is not available on the system
          {% else %}
            {% set lsmod_output = result_1_lsmod.stdout | default('') | trim if result_1_lsmod is defined else '' %}
            {% set modprobe_output = result_1_modprobe.stdout | default('') | trim if result_1_modprobe is defined else '' %}
            {% if lsmod_output == '' and ('blacklist cramfs' in modprobe_output) and ('install cramfs /bin/false' in modprobe_output or 'install cramfs /bin/true' in modprobe_output) %}
              PASS: cramfs module exists but is not loaded and is blacklisted/disabled
            {% else %}
              FAIL: cramfs module exists and {% if lsmod_output != '' %}is loaded{% else %}is not blacklisted/disabled properly (lsmod output: '{{ lsmod_output }}', modprobe output: '{{ modprobe_output }}'){% endif %}
            {% endif %}
          {% endif %}

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.1.1.1"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.1.1"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - "========================================================"