---
- name: Data Collection for CIS 5.1.6
  hosts: all
  become: yes
  gather_facts: false
  vars:
    cis_checkpoint: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.6"
    req_1: "Run the provided CIS audit script to verify Ensure sshd access is configured"
    req_2: "OVERALL Verify: Ensure sshd access is configured"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Execute CIS audit script for general sshd access configuration
    - name: Req 1 - Execute CIS audit script for general sshd access configuration
      copy:
        dest: "/tmp/cis_audit_5.1.6_general.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash

          source /etc/crypto-policies/back-ends/opensshserver.config
          source /etc/sysconfig/sshd
          sshd -T $OPTIONS $CRYPTO_POLICY | grep -Pi -- '^\h*(allow|deny)(users|groups)\h+\H+'
          {% endraw %}
      register: script_create_1
      ignore_errors: true

    - name: Req 1 - Execute the audit script
      shell: "/tmp/cis_audit_5.1.6_general.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_5.1.6_general.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Execute CIS audit script for general sshd access configuration"
        task_1_cmd: "Run script: /tmp/cis_audit_5.1.6_general.sh"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% set output = result_1.stdout | default('') | trim %}
          {% if output != '' and (output is regex('^\s*allowusers\s+') or 
                                  output is regex('^\s*allowgroups\s+') or 
                                  output is regex('^\s*denyusers\s+') or 
                                  output is regex('^\s*denygroups\s+')) %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_1: "PASS when script output shows at least one allowusers, allowgroups, denyusers, or denygroups line; FAIL when no lines found"

    # Check for Match blocks in sshd_config as per CIS procedure
    - name: Check if sshd config has Match blocks
      shell: |
        grep -q '^Match' /etc/ssh/sshd_config && echo "MATCH_BLOCKS_EXIST" || echo "NO_MATCH_BLOCKS"
      register: match_check
      ignore_errors: true
      changed_when: false

    # Requirement for match block auditing (conditional)
    - name: Req 1b - Audit match blocks for sshuser example (if Match blocks exist)
      copy:
        dest: "/tmp/cis_audit_5.1.6_match.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash

          source /etc/crypto-policies/back-ends/opensshserver.config
          source /etc/sysconfig/sshd
          sshd -T $OPTIONS $CRYPTO_POLICY -C user=sshuser | grep -Pi -- '^\h*(allow|deny)(users|groups)\h+\H+'
          {% endraw %}
      register: script_create_match
      ignore_errors: true
      when: match_check.stdout == "MATCH_BLOCKS_EXIST"

    - name: Req 1b - Execute the match block audit script
      shell: "/tmp/cis_audit_5.1.6_match.sh"
      args:
        executable: /bin/bash
      register: result_match
      ignore_errors: true
      changed_when: false
      when: match_check.stdout == "MATCH_BLOCKS_EXIST"

    - name: Req 1b - Remove temporary match audit script
      file:
        path: "/tmp/cis_audit_5.1.6_match.sh"
        state: absent
      ignore_errors: true
      when: match_check.stdout == "MATCH_BLOCKS_EXIST"

    - name: Store match block audit details
      set_fact:
        match_audit_data: "{{ result_match.stdout | default('') | trim }}"
        match_blocks_exist: "{{ match_check.stdout == 'MATCH_BLOCKS_EXIST' }}"
      when: match_check.stdout == "MATCH_BLOCKS_EXIST"

    # Requirement 2: OVERALL Verify
    - name: Store requirement 2 details
      set_fact:
        task_2_name: "OVERALL Verify: Ensure sshd access is configured"
        task_2_cmd: "Evaluate overall compliance based on requirement 1"
        task_2_rc: 0
        data_2: "Based on requirement 1 result"
        status_2: "{{ status_1 | default('UNKNOWN') | trim }}"
        rationale_2: "PASS when req_1 shows at least one allow/deny line for users or groups, FAIL otherwise"

    # Build report message
    - name: Build compliance report message
      set_fact:
        report_message: |
          ========================================================
                  COMPLIANCE REPORT - CIS 5.1.6
          ========================================================
          Reference: {{ cis_checkpoint }}
          ========================================================

          REQUIREMENT 1 - {{ req_1 }}:
            Task: {{ task_1_name }}
            Command: {{ task_1_cmd }}
            Exit code: {{ task_1_rc }}
            Data: {{ data_1 | default('') | trim }}
            Status: {{ status_1 | default('UNKNOWN') | trim }}
            Rationale: {{ rationale_1 | default('Not evaluated') | trim }}

          REQUIREMENT 2 - {{ req_2 }}:
            Task: {{ task_2_name }}
            Command: {{ task_2_cmd }}
            Exit code: {{ task_2_rc }}
            Data: {{ data_2 | default('') | trim }}
            Status: {{ status_2 | default('UNKNOWN') | trim }}
            Rationale: {{ rationale_2 | default('Not evaluated') | trim }}

          {% if match_blocks_exist is defined and match_blocks_exist %}
          MATCH BLOCK AUDIT (Conditional):
            Match blocks detected in /etc/ssh/sshd_config
            Match block audit output for user=sshuser: {{ match_audit_data | default('') | trim }}

          {% endif %}
          ========================================================
          OVERALL COMPLIANCE:
            Result: {{ status_2 | default('UNKNOWN') | trim }}
            Rationale: PASS when req_1 shows at least one allow/deny line for users or groups, FAIL otherwise
          ========================================================

    # Final report
    - name: Generate compliance report
      debug:
        msg: "{{ report_message }}"