---
- name: Data Collection for CIS 6.2.3.1
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    kcs_article: "CIS RHEL 8 Benchmark v4.0.0 checkpoint 6.2.3.1"
    req_1: "Run the following script"
    req_2: "OVERALL Verify: Ensure access to all logfiles has been configured"

  tasks:
    # CIS RHEL 8 Benchmark v4.0.0, checkpoint 6.2.3.1
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Run the following script
    - name: Req 1 - Create temporary audit script
      copy:
        dest: "/tmp/cis_audit_6.2.3.1.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             a_output=(); a_output2=()
             f_file_test_chk()
             {
                a_out2=()  
                maxperm="$( printf '%o' $(( 0777 & ~$perm_mask)) )"  
                [ $(( $l_mode & $perm_mask )) -gt 0 ] && \
                   a_out2+=("   o Mode: \"$l_mode\" should be \"$maxperm\" or more restrictive")
                [[ ! "$l_user" =~ $l_auser ]] && \
                   a_out2+=("   o Owned by: \"$l_user\" and should be owned by \"${l_auser//|/ or }\"")
                [[ ! "$l_group" =~ $l_agroup ]] && \
                   a_out2+=("   o Group owned by: \"$l_group\" and should be group owned by \"${l_agroup//|/ or }\"")
                [ "${#a_out2[@]}" -gt 0 ] && a_output2+=(" - File: \"$l_fname\" is:" "${a_out2[@]}")
             }
             while IFS= read -r -d $'\0' l_file; do
                while IFS=: read -r l_fname l_mode l_user l_group; do
                   if grep -Pq -- '\/(apt)\h*$' <<< "$(dirname "$l_fname")"; then
                      perm_mask='0133' l_auser="root" l_agroup="(root|adm)"; f_file_test_chk  
                   else
                      case "$(basename "$l_fname")" in
                         lastlog | lastlog.* | wtmp | wtmp.* | wtmp-* | btmp | btmp.* | btmp-* | README)
                            perm_mask='0113' l_auser="root" l_agroup="(root|utmp)"  
                            f_file_test_chk ;;
                         cloud-init.log* | localmessages* | waagent.log*)
                            perm_mask='0133' l_auser="(root|syslog)" l_agroup="(root|adm)"  
                            f_file_test_chk ;;
                         secure{,*.*,.*,-*} | auth.log | syslog | messages)
                            perm_mask='0137' l_auser="(root|syslog)" l_agroup="(root|adm)"  
                            f_file_test_chk ;;
                         SSSD | sssd)
                            perm_mask='0117' l_auser="(root|SSSD)" l_agroup="(root|SSSD)"  
                            f_file_test_chk ;;
                         gdm | gdm3)
                            perm_mask='0117' l_auser="root" l_agroup="(root|gdm|gdm3)"  
                            f_file_test_chk ;;
                         *.journal | *.journal~)
                            perm_mask='0137' l_auser="root" l_agroup="(root|systemd-journal)" 
                            f_file_test_chk ;;
                         *)
                            perm_mask='0137' l_auser="(root|syslog)" l_agroup="(root|adm)"  
                            if [ "$l_user" = "root" ] || ! grep -Pq -- "^\h*$(awk -F: '$1=="'"$l_user"'" {print $7}' /etc/passwd)\b" /etc/shells; then
                               ! grep -Pq -- "$l_auser" <<< "$l_user" && l_auser="(root|syslog|$l_user)"  
                               ! grep -Pq -- "$l_agroup" <<< "$l_group" && l_agroup="(root|adm|$l_group)"  
                            fi
                            f_file_test_chk ;;
                      esac
                   fi
                done < <(stat -Lc '%n:%#a:%U:%G' "$l_file")
             done < <(find -L /var/log -type f \( -perm /0137 -o ! -user root -o ! -group root \) -print0)
             if [ "${#a_output2[@]}" -le 0 ]; then
                a_output+=("  - All files in \"/var/log/\" have appropriate permissions and ownership")
                printf '\n%s' "- Audit Result:" "  ** PASS **" "${a_output[@]}" ""  
             else
                printf '\n%s' "- Audit Result:" "  ** FAIL **" " - Reason(s) for audit failure:" "${a_output2[@]}" ""
             fi
          }
          {% endraw %}
      register: script_create
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Execute audit script
      shell: "/tmp/cis_audit_6.2.3.1.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_6.2.3.1.sh"
        state: absent
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Execute CIS audit script for logfile permissions"
        task_1_cmd: "/tmp/cis_audit_6.2.3.1.sh"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% set output = result_1.stdout | default('') | trim %}
          {% if output is search('\*\* PASS \*\*') and output is search('All files in "/var/log/" have appropriate permissions and ownership') %}
            PASS
          {% elif output is search('\*\* FAIL \*\*') %}
            FAIL
          {% else %}
            UNKNOWN
          {% endif %}
        rationale_1: |
          PASS when the script output contains '** PASS **' and the line 'All files in \"/var/log/\" have appropriate permissions and ownership', FAIL when the script output contains '** FAIL **' and lists specific files with incorrect permissions or ownership.

    # Requirement 2: OVERALL Verify: Ensure access to all logfiles has been configured
    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Overall verification based on requirement 1 result"
        task_2_cmd: "N/A (derived from requirement 1)"
        task_2_rc: "{{ task_1_rc | default(-1) }}"
        data_2: "{{ data_1 | default('') | trim }}"
        status_2: >-
          {% if status_1 | default('UNKNOWN') | trim == 'PASS' %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_2: "PASS when req_1=PASS, FAIL otherwise"
      when: data_1 is defined

    # Final report
    - name: Generate compliance report
      debug:
        msg: |
          ========================================================
                  COMPLIANCE REPORT - CIS 6.2.3.1
          ========================================================
          Reference: CIS RHEL 8 Benchmark v4.0.0 checkpoint 6.2.3.1
          ========================================================

          REQUIREMENT 1 - {{ req_1 }}:
            Task: {{ task_1_name | default('Task not recorded') }}
            Command: {{ task_1_cmd | default('N/A') }}
            Exit code: {{ task_1_rc | default(-1) }}
            Data: {{ (data_1 | default('') | trim)[:200] }}{% if (data_1 | default('') | length) > 200 %}... (truncated){% endif %}
            Status: {{ status_1 | default('UNKNOWN') | trim }}
            Rationale: {{ rationale_1 | default('Not evaluated') | trim }}

          REQUIREMENT 2 - {{ req_2 }}:
            Task: {{ task_2_name | default('Task not recorded') }}
            Command: {{ task_2_cmd | default('N/A') }}
            Exit code: {{ task_2_rc | default(-1) }}
            Data: {{ (data_2 | default('') | trim)[:200] }}{% if (data_2 | default('') | length) > 200 %}... (truncated){% endif %}
            Status: {{ status_2 | default('UNKNOWN') | trim }}
            Rationale: {{ rationale_2 | default('Not evaluated') | trim }}

          ========================================================
          OVERALL COMPLIANCE:
            Result: {{ status_2 | default('UNKNOWN') | trim }}
            Rationale: {{ rationale_2 | default('Not evaluated') | trim }}
          ========================================================