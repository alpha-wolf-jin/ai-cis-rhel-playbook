---
- name: Data Collection for CIS 1.7.3
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.7.3"
    req_1: "Check the contents of /etc/issue.net"
    req_2: "Check that /etc/issue.net does NOT contain OS information or escape sequences"
    req_3: "OVERALL Verify: Ensure /etc/issue.net is configured"
    
    # Define what "site policy" means for the organization
    # These are example values - in a real scenario, these would be defined based on organization policy
    site_policy_required_keywords: ["Organization", "monitoring", "authorized", "legal"]
    site_policy_prohibited_keywords: ["release", "version", "patch", "Kernel", "built"]

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1

    # Requirement 1: Check the contents of /etc/issue.net
    - name: Req 1 - Check /etc/issue.net contents
      shell: |
        cat /etc/issue.net
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check /etc/issue.net contents"
        task_1_cmd: "cat /etc/issue.net"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% set content = result_1.stdout | default('') | trim %}
          {% if result_1.rc == 0 %}
            {% if content != '' %}
              {% set has_required = false %}
              {% set has_prohibited = false %}
              
              {# Check for required keywords (organization-specific) #}
              {% for keyword in site_policy_required_keywords %}
                {% if keyword | lower in content | lower %}
                  {% set has_required = true %}
                {% endif %}
              {% endfor %}
              
              {# Check for prohibited OS/patch info #}
              {% for keyword in site_policy_prohibited_keywords %}
                {% if keyword | lower in content | lower %}
                  {% set has_prohibited = true %}
                {% endif %}
              {% endfor %}
              
              {# Also check for common OS identifiers that might not be in prohibited list #}
              {% if "linux" in content | lower or "red hat" in content | lower or "rhel" in content | lower %}
                {% set has_prohibited = true %}
              {% endif %}
              
              {# Check if content appears to be a valid warning banner (not just a placeholder) #}
              {% if has_required and not has_prohibited %}
                PASS
              {% else %}
                FAIL
              {% endif %}
            {% else %}
              FAIL
            {% endif %}
          {% else %}
            FAIL
          {% endif %}
        rationale_1: >-
          {% set content = result_1.stdout | default('') | trim %}
          {% if result_1.rc == 0 %}
            {% if content != '' %}
              {% set has_required = false %}
              {% set has_prohibited = false %}
              
              {% for keyword in site_policy_required_keywords %}
                {% if keyword | lower in content | lower %}
                  {% set has_required = true %}
                {% endif %}
              {% endfor %}
              
              {% for keyword in site_policy_prohibited_keywords %}
                {% if keyword | lower in content | lower %}
                  {% set has_prohibited = true %}
                {% endif %}
              {% endfor %}
              
              {% if "linux" in content | lower or "red hat" in content | lower or "rhel" in content | lower %}
                {% set has_prohibited = true %}
              {% endif %}
              
              {% if has_required and not has_prohibited %}
                PASS: File exists and content appears to match organization site policy (contains required keywords like 'Organization', 'monitoring' and does not contain prohibited OS/patch information)
              {% elif not has_required %}
                FAIL: File exists but does not contain required organization keywords (expected: {{ site_policy_required_keywords | join(', ') }})
              {% else %}
                FAIL: File exists but contains prohibited OS/patch information
              {% endif %}
            {% else %}
              FAIL: File exists but is empty (no warning banner configured)
            {% endif %}
          {% else %}
            FAIL: Cannot read /etc/issue.net (file may not exist or permissions issue)
          {% endif %}

    # Requirement 2: Check that /etc/issue.net does NOT contain OS information or escape sequences
    - name: Req 2 - Check for OS info and escape sequences
      shell: |
        # Use bash to execute the complex grep command
        /bin/bash -c 'grep -E -i "(\\\v|\\\r|\\\m|\\\s|\$(grep "^ID=" /etc/os-release | cut -d= -f2 | sed -e "s/\"//g"))" /etc/issue.net'
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Check for OS info and escape sequences"
        task_2_cmd: |
          grep -E -i "(\\\v|\\\r|\\\m|\\\s|\$(grep "^ID=" /etc/os-release | cut -d= -f2 | sed -e "s/\"//g"))" /etc/issue.net
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% if result_2.stdout | default('') | trim == '' %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_2: >-
          {% if result_2.stdout | default('') | trim == '' %}
            PASS: No OS info or escape sequences found in /etc/issue.net
          {% else %}
            FAIL: OS info or escape sequences found in /etc/issue.net
          {% endif %}

    # Requirement 3: Overall verification
    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Overall verification"
        task_3_cmd: "N/A"
        task_3_rc: 0
        data_3: ""
        status_3: >-
          {% if status_1 | default('FAIL') | trim == 'PASS' and status_2 | default('FAIL') | trim == 'PASS' %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_3: >-
          {% if status_1 | default('FAIL') | trim == 'PASS' and status_2 | default('FAIL') | trim == 'PASS' %}
            PASS: Both requirement 1 and requirement 2 passed
          {% else %}
            FAIL: One or more requirements failed
          {% endif %}

    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.7.3"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.7.3"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name }}"
          - "  Command: {{ task_1_cmd }}"
          - "  Exit code: {{ task_1_rc }}"
          - "  Data: {{ data_1 }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name }}"
          - "  Command: {{ task_2_cmd }}"
          - "  Exit code: {{ task_2_rc }}"
          - "  Data: {{ data_2 }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name }}"
          - "  Command: {{ task_3_cmd }}"
          - "  Exit code: {{ task_3_rc }}"
          - "  Data: {{ data_3 }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - "========================================================"