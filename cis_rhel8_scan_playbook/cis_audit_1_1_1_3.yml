---
- name: Data Collection for CIS 1.1.1.3
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.1.3"
    req_1: "Run the provided CIS audit script to verify Ensure hfs kernel module is not available. Verify the hfs kernel module is not available on the system or has been disabled."
    req_2: "OVERALL Verify: Ensure hfs kernel module is not available."

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Run CIS audit script for hfs module
    - name: Req 1 - Create CIS audit script for hfs module
      copy:
        dest: "/tmp/cis_audit_hfs.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_mod_name="hfs" l_mod_type="fs"
             while IFS= read -r l_mod_path; do
                if [ -d "$l_mod_path/${l_mod_name//-/\/}" ] &&  \
                [ -n "$(ls -A "$l_mod_path/${l_mod_name//-/\/}")" ]; then
                   printf '%s\n' "$l_mod_name exists in $l_mod_path"
                fi
             done < <(readlink -e /usr/lib/modules/**/kernel/$l_mod_type \
             || readlink -e /lib/modules/**/kernel/$l_mod_type)
          }
          {% endraw %}
      register: script_create_1
      ignore_errors: true

    - name: Req 1 - Execute CIS audit script for hfs module
      shell: "/tmp/cis_audit_hfs.sh"
      args:
        executable: /bin/bash
      register: script_result_1
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Check if hfs module is loaded (if script returned something)
      shell: lsmod | grep 'hfs'
      args:
        executable: /bin/bash
      register: lsmod_result_1
      ignore_errors: true
      changed_when: false
      when: script_result_1.stdout | trim != ''

    - name: Req 1 - Check if hfs module is loadable (if script returned something)
      shell: modprobe --showconfig | grep -P -- '\b(install|blacklist)\h+hfs\b'
      args:
        executable: /bin/bash
      register: modprobe_result_1
      ignore_errors: true
      changed_when: false
      when: script_result_1.stdout | trim != ''

    - name: Req 1 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_hfs.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Execute CIS audit script and check hfs module status"
        task_1_cmd: |
          /tmp/cis_audit_hfs.sh; [if output] lsmod | grep 'hfs'; modprobe --showconfig | grep -P '\b(install|blacklist)\h+hfs\b'
        task_1_rc: "{{ script_result_1.rc | default(-1) }}"
        data_1: |
          script output: {{ script_result_1.stdout | default('') | trim }}
          lsmod output: {{ lsmod_result_1.stdout | default('Not run (no output from script)') | trim }}
          modprobe output: {{ modprobe_result_1.stdout | default('Not run (no output from script)') | trim }}
        status_1: >-
          {% set script_out = script_result_1.stdout | default('') | trim %}
          {% if script_out == '' %}
            PASS
          {% else %}
            {% set lsmod_out = lsmod_result_1.stdout | default('') | trim %}
            {% set modprobe_out = modprobe_result_1.stdout | default('') | trim %}
            {% if lsmod_out == '' and 'blacklist hfs' in modprobe_out and ('install hfs /bin/false' in modprobe_out or 'install hfs /bin/true' in modprobe_out) %}
              PASS
            {% else %}
              FAIL
            {% endif %}
          {% endif %}
        rationale_1: >-
          {% set script_out = script_result_1.stdout | default('') | trim %}
          {% if script_out == '' %}
            PASS: hfs module is not available on the system or built into kernel
          {% else %}
            {% set lsmod_out = lsmod_result_1.stdout | default('') | trim %}
            {% set modprobe_out = modprobe_result_1.stdout | default('') | trim %}
            {% if lsmod_out == '' and 'blacklist hfs' in modprobe_out and ('install hfs /bin/false' in modprobe_out or 'install hfs /bin/true' in modprobe_out) %}
              PASS: hfs module is available but not loaded and disabled via modprobe config
            {% else %}
              FAIL: hfs module is available and either loaded or not properly disabled
            {% endif %}
          {% endif %}

    # Requirement 2: OVERALL Verify
    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Overall verification based on requirement 1"
        task_2_cmd: "N/A"
        task_2_rc: 0
        data_2: "Overall status based on requirement 1 result"
        status_2: "{{ status_1 }}"
        rationale_2: "Overall compliance is determined by requirement 1. PASS when requirement 1 passes, FAIL otherwise."

    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.1.1.3"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.1.3"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_2 | trim }}"
          - "  Rationale: Overall compliance determined by requirement 2 which reflects requirement 1 status. PASS when hfs module is not available or properly disabled, FAIL otherwise."
          - "========================================================"