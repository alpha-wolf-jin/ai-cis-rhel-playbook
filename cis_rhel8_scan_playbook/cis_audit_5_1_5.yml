---
- name: Data Collection for CIS 5.1.5
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.5"
    req_1: "Run the provided CIS audit script to verify SSH public host key files are mode 0644 or more restrictive, owned by the root user, and owned by the root group"
    req_2: "Overall Verify: Ensure access to SSH public host key files is configured"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        data_1: ""
        status_1: "UNKNOWN"
        rationale_1: "Not evaluated"
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        data_2: ""
        status_2: "UNKNOWN"
        rationale_2: "Not evaluated"

    - name: Req 1 - Execute CIS audit script for SSH public host key files
      copy:
        dest: "/tmp/cis_audit_5.1.5.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             a_output=(); a_output2=()
             l_pmask="0133"; l_maxperm="$( printf '%o' $(( 0777 & ~$l_pmask )) )"
             f_file_chk()
             {
                while IFS=: read -r l_file_mode l_file_owner l_file_group; do
                   a_out2=()
                   if [ $(( $l_file_mode & $l_pmask )) -gt 0 ]; then
                      a_out2+=("    Mode: \"$l_file_mode\" should be mode: \"$l_maxperm\" or more restrictive")
                   fi
                   if [ "$l_file_owner" != "root" ]; then
                      a_out2+=("    Owned by: \"$l_file_owner\" should be owned by: \"root\"")
                   fi
                   if [ "$l_file_group" != "root" ]; then
                      a_out2+=("    Owned by group \"$l_file_group\" should be group owned by group: \"root\"")
                   fi
                   if [ "${#a_out2[@]}" -gt "0" ]; then
                      a_output2+=("  - File: \"$l_file\"" "${a_out2[@]}")
                   else
                      a_output+=("  - File: \"$l_file\"" \
                      "    Correct: mode: \"$l_file_mode\", owner: \"$l_file_owner\" and group owner: \"$l_file_group\" configured")
                   fi
                done < <(stat -Lc '%#a:%U:%G' "$l_file")
             }
             while IFS= read -r -d $'\0' l_file; do
                if ssh-keygen -lf &>/dev/null "$l_file"; then
                   file "$l_file" | grep -Piq -- '\bopenssh\h+([^#\n\r]+\h+)?public\h+key\b' && f_file_chk
                fi
             done < <(find -L /etc/ssh -xdev -type f -print0 2>/dev/null)
             if [ "${#a_output2[@]}" -le 0 ]; then
                [ "${#a_output[@]}" -le 0 ] && a_output+=("  - No openSSH public keys found")
                printf '%s\n' "" "- Audit Result:" "  ** PASS **" "${a_output[@]}" ""
             else
                printf '%s\n' "" "- Audit Result:" "  ** FAIL **" " - Reason(s) for audit failure:" "${a_output2[@]}"
                [ "${#a_output[@]}" -gt 0 ] && printf '%s\n' "" "- Correctly set:" "${a_output[@]}" ""
             fi
          }
          {% endraw %}
      register: script_create_1
      ignore_errors: true

    - name: Req 1 - Execute the audit script
      shell: "/tmp/cis_audit_5.1.5.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_5.1.5.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Execute CIS audit script for SSH public host key files"
        task_1_cmd: "/tmp/cis_audit_5.1.5.sh"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if ('** PASS **' in (result_1.stdout | default(''))) else 'FAIL') | trim }}"
        rationale_1: "PASS when script output shows '** PASS **' or indicates compliance, FAIL when script output shows '** FAIL **' or indicates non-compliance"

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Overall Verify SSH public host key file configuration"
        task_2_cmd: "N/A"
        task_2_rc: "0"
        data_2: "Requirement based on requirement 1 status"
        status_2: "{{ status_1 | default('UNKNOWN') | trim }}"
        rationale_2: "PASS when req_1=PASS, FAIL otherwise"

    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 5.1.5"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.5"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: Overall compliance is determined by requirement 2 status, which is based on requirement 1. PASS when req_1=PASS, FAIL otherwise"
          - "========================================================"