---
- name: Data Collection for CIS Benchmark 5.1.7 - Ensure sshd Banner is configured
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.7"
    req_1: "Run CIS audit script to verify Banner is set"
    req_2: "If match set statements are used, run additional audit for match block"
    req_3: "Run script to verify banner file contents match site policy"
    req_4: "Run command to verify no unwanted content in banner file"
    req_5: "OVERALL Verify: Ensure sshd Banner is configured"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        data_3: ""
        data_4: ""
        status_1: "UNKNOWN"
        status_2: "UNKNOWN"
        status_3: "UNKNOWN"
        status_4: "UNKNOWN"
        status_5: "UNKNOWN"
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1
        rationale_1: "Not evaluated"
        rationale_2: "Not evaluated"
        rationale_3: "Not evaluated"
        rationale_4: "Not evaluated"
        rationale_5: "Not evaluated"

    # Req 1 - Run CIS audit script to verify Banner is set
    - name: "Req 1 - Execute CIS audit script for Banner check"
      copy:
        dest: "/tmp/cis_audit_5.1.7_req1.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          source /etc/crypto-policies/back-ends/opensshserver.config 2>/dev/null
          source /etc/sysconfig/sshd 2>/dev/null
          sshd -T $OPTIONS $CRYPTO_POLICY | grep -Pi -- '^banner\h+\/\H+'
          {% endraw %}
      register: script_create_1
      ignore_errors: true

    - name: "Req 1 - Execute the audit script"
      shell: "/tmp/cis_audit_5.1.7_req1.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: "Req 1 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_5.1.7_req1.sh"
        state: absent
      ignore_errors: true

    - name: "Store requirement 1 details"
      set_fact:
        task_1_name: "Execute CIS audit script for Banner check"
        task_1_cmd: |
          source /etc/crypto-policies/back-ends/opensshserver.config 2>/dev/null; source /etc/sysconfig/sshd 2>/dev/null; sshd -T $OPTIONS $CRYPTO_POLICY | grep -Pi -- '^banner\h+\/\H+'
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% if result_1.stdout is defined and result_1.stdout | trim != '' %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_1: >-
          {% if result_1.stdout is defined and result_1.stdout | trim != '' %}
            PASS when script output shows Banner path (non-empty)
          {% else %}
            FAIL when no output or error
          {% endif %}

    # Req 2 - If match set statements are used, run additional audit for match block
    # Only execute if req_1 passed (banner is configured)
    - name: "Req 2 - Execute CIS audit script for match block check (user=root)"
      copy:
        dest: "/tmp/cis_audit_5.1.7_req2.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          source /etc/crypto-policies/back-ends/opensshserver.config 2>/dev/null
          source /etc/sysconfig/sshd 2>/dev/null
          sshd -T $OPTIONS $CRYPTO_POLICY -C user=root | grep -Pi -- '^banner\h+\/\H+'
          {% endraw %}
      register: script_create_2
      ignore_errors: true
      when: status_1 == 'PASS'

    - name: "Req 2 - Execute the audit script"
      shell: "/tmp/cis_audit_5.1.7_req2.sh"
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false
      when: status_1 == 'PASS'

    - name: "Req 2 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_5.1.7_req2.sh"
        state: absent
      ignore_errors: true
      when: status_1 == 'PASS'

    - name: "Store requirement 2 details"
      set_fact:
        task_2_name: "Execute CIS audit script for match block check"
        task_2_cmd: |
          source /etc/crypto-policies/back-ends/opensshserver.config 2>/dev/null; source /etc/sysconfig/sshd 2>/dev/null; sshd -T $OPTIONS $CRYPTO_POLICY -C user=root | grep -Pi -- '^banner\h+\/\H+'
        task_2_rc: >-
          {% if status_1 == 'PASS' %}
            {{ result_2.rc | default(-1) }}
          {% else %}
            -1
          {% endif %}
        data_2: >-
          {% if status_1 == 'PASS' %}
            {{ result_2.stdout | default('') | trim }}
          {% else %}
            ''
          {% endif %}
        status_2: >-
          {% if status_1 == 'PASS' %}
            {% if result_2.stdout is defined and result_2.stdout | trim != '' %}
              PASS
            {% else %}
              FAIL
            {% endif %}
          {% else %}
            NA
          {% endif %}
        rationale_2: >-
          {% if status_1 == 'PASS' %}
            {% if result_2.stdout is defined and result_2.stdout | trim != '' %}
              PASS when match block output shows consistent Banner setting
            {% else %}
              FAIL when match block output differs from general Banner setting
            {% endif %}
          {% else %}
            NA: Banner not set, match block check not applicable
          {% endif %}

    # Req 3 - Run script to verify banner file contents match site policy
    # Only execute if req_1 passed (banner is configured)
    - name: "Req 3 - Execute script to check banner file contents"
      copy:
        dest: "/tmp/cis_audit_5.1.7_req3.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          source /etc/crypto-policies/back-ends/opensshserver.config 2>/dev/null
          source /etc/sysconfig/sshd 2>/dev/null
          [ -e "$(sshd -T $OPTIONS $CRYPTO_POLICY | awk '$1 == "banner" {print $2}')" ] && cat "$(sshd -T $OPTIONS $CRYPTO_POLICY | awk '$1 == "banner" {print $2}')"
          {% endraw %}
      register: script_create_3
      ignore_errors: true
      when: status_1 == 'PASS'

    - name: "Req 3 - Execute the audit script"
      shell: "/tmp/cis_audit_5.1.7_req3.sh"
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      changed_when: false
      when: status_1 == 'PASS'

    - name: "Req 3 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_5.1.7_req3.sh"
        state: absent
      ignore_errors: true
      when: status_1 == 'PASS'

    - name: "Store requirement 3 details"
      set_fact:
        task_3_name: "Execute script to check banner file contents"
        task_3_cmd: >-
          {% raw %}
          source /etc/crypto-policies/back-ends/opensshserver.config 2>/dev/null; source /etc/sysconfig/sshd 2>/dev/null; [ -e "$(sshd -T $OPTIONS $CRYPTO_POLICY | awk '$1 == "banner" {print $2}')" ] && cat "$(sshd -T $OPTIONS $CRYPTO_POLICY | awk '$1 == "banner" {print $2}')"
          {% endraw %}
        task_3_rc: >-
          {% if status_1 == 'PASS' %}
            {{ result_3.rc | default(-1) }}
          {% else %}
            -1
          {% endif %}
        data_3: >-
          {% if status_1 == 'PASS' %}
            {{ result_3.stdout | default('') | trim }}
          {% else %}
            ''
          {% endif %}
        status_3: >-
          {% if status_1 == 'PASS' %}
            {% if result_3.stdout is defined and result_3.stdout | trim != '' %}
              UNKNOWN
            {% else %}
              FAIL
            {% endif %}
          {% else %}
            NA
          {% endif %}
        rationale_3: >-
          {% if status_1 == 'PASS' %}
            {% if result_3.stdout is defined and result_3.stdout | trim != '' %}
              Banner file contents displayed (manual verification needed to ensure it matches site policy)
            {% else %}
              FAIL: Banner file does not exist or cannot be read
            {% endif %}
          {% else %}
            NA: Banner not set, banner file check not applicable
          {% endif %}

    # Req 4 - Run command to verify no unwanted content in banner file
    # Fix the syntax error by using the exact command from the audit procedure with proper formatting
    - name: "Req 4 - Execute command to check for unwanted content in banner file"
      copy:
        dest: "/tmp/cis_audit_5.1.7_req4.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          # Run the exact command from CIS audit procedure
          grep -Psi -- "(\\\v|\\\r|\\\m|\\\s|\b$(grep '^ID=' /etc/os-release | cut -d= -f2 | sed -e 's/"//g')\b)" "$(sshd -T | awk '$1 == "banner" {print $2}')"
          {% endraw %}
      register: script_create_4
      ignore_errors: true
      when: status_1 == 'PASS'

    - name: "Req 4 - Execute the audit script"
      shell: "/tmp/cis_audit_5.1.7_req4.sh"
      args:
        executable: /bin/bash
      register: result_4
      ignore_errors: true
      changed_when: false
      when: status_1 == 'PASS'

    - name: "Req 4 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_5.1.7_req4.sh"
        state: absent
      ignore_errors: true
      when: status_1 == 'PASS'

    - name: "Store requirement 4 details"
      set_fact:
        task_4_name: "Check for unwanted content in banner file"
        task_4_cmd: >-
          {% raw %}
          grep -Psi -- "(\\\v|\\\r|\\\m|\\\s|\b$(grep '^ID=' /etc/os-release | cut -d= -f2 | sed -e 's/"//g')\b)" "$(sshd -T | awk '$1 == "banner" {print $2}')"
          {% endraw %}
        task_4_rc: >-
          {% if status_1 == 'PASS' %}
            {{ result_4.rc | default(-1) }}
          {% else %}
            -1
          {% endif %}
        data_4: >-
          {% if status_1 == 'PASS' %}
            {{ result_4.stdout | default('') | trim }}
          {% else %}
            ''
          {% endif %}
        status_4: >-
          {% if status_1 == 'PASS' %}
            {% if result_4.stdout is defined %}
              {% if result_4.stdout | trim == '' %}
                PASS
              {% else %}
                FAIL
              {% endif %}
            {% else %}
              UNKNOWN
            {% endif %}
          {% else %}
            NA
          {% endif %}
        rationale_4: >-
          {% if status_1 == 'PASS' %}
            {% if result_4.stdout is defined %}
              {% if result_4.stdout | trim == '' %}
                PASS: No unwanted content found in banner file
              {% else %}
                FAIL: Unwanted content detected in banner file
              {% endif %}
            {% else %}
              UNKNOWN: Could not determine banner file content
            {% endif %}
          {% else %}
            NA: Banner not set, unwanted content check not applicable
          {% endif %}

    # Req 5 - Overall verification (based on req_1)
    - name: "Store requirement 5 details"
      set_fact:
        task_5_name: "Overall verification"
        task_5_cmd: "N/A - Derived from requirement 1 status"
        task_5_rc: 0
        data_5: "N/A"
        status_5: "{{ status_1 | trim }}"
        rationale_5: >-
          {% if status_1 == 'PASS' %}
            PASS: Banner is configured as required
          {% else %}
            FAIL: Banner is not configured as required
          {% endif %}

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 5.1.7"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Task: {{ task_4_name | default('Task not recorded') }}"
          - "  Command: {{ task_4_cmd | default('N/A') }}"
          - "  Exit code: {{ task_4_rc | default(-1) }}"
          - "  Data: {{ data_4 | default('') | trim }}"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 5 - {{ req_5 }}:"
          - "  Task: {{ task_5_name | default('Task not recorded') }}"
          - "  Command: {{ task_5_cmd | default('N/A') }}"
          - "  Exit code: {{ task_5_rc | default(-1) }}"
          - "  Data: {{ data_5 | default('') | trim }}"
          - "  Status: {{ status_5 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_5 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_5 | trim }}"
          - "  Rationale: {{ rationale_5 | trim }}"
          - "========================================================"