---
- name: Data Collection for CIS Checkpoint 1.1.1.11
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.1.11"
    req_1: "Run the provided CIS audit script to verify Ensure unused filesystems kernel modules are not available. Verify filesystem kernel modules that are not in use on the system are disabled. Review currently loaded kernel modules to ensure they are needed and conform to local site policy."
    req_2: "OVERALL Verify: Ensure unused filesystems kernel modules are not available"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        data_1: ""
        status_1: "UNKNOWN"
        rationale_1: "Not evaluated"
        task_2_name: "N/A"
        task_2_cmd: "N/A"
        task_2_rc: -1
        data_2: ""
        status_2: "UNKNOWN"
        rationale_2: "Not evaluated"

    # Requirement 1: Execute the complete CIS audit script
    - name: Req 1 - Create complete CIS audit script for checkpoint 1.1.1.11
      copy:
        dest: "/tmp/cis_audit_1.1.1.11.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash

          {
             a_check=() a_output=() a_module=() a_output2=() a_output3=()
             l_search="$(readlink -e /usr/lib/modules/ || readlink -e /lib/modules/)"
             IFS=$'\n' read -r -d '' -a a_mounted < <(findmnt -Dkerno fstype \
             | sort -u && printf '\0' )
             IFS=$'\n' read -r -d '' -a a_lsmod < <(lsmod | awk '{print $1}' && printf '\0' )
             IFS=$'\n' read -r -d '' -a a_showconfig < <(modprobe --showconfig | \
             grep -Pi -- '^\h*(blacklist|install)\h+' && printf '\0')
             while IFS= read -r -d $'\0' l_module_dir; do
                if [ ! "$(basename "$l_module_dir")" = "nls" ]; then
                   while IFS= read -r -d $'\0' l_module_file; do
                      l_mname="$(basename "$l_module_file" | cut -d'.' -f1)"
                      if [ -f "$l_module_file" ] && ! grep -Psiq -- '\b'"$l_mname"'\b' <<< "${a_module[*]}"; then
                         a_module+=("$l_mname")
                      fi
                   done < <(find -L "$l_module_dir" -mindepth 1 -maxdepth 1 -type f -print0)
                fi
             done < <(find "$l_search"/**/kernel/fs/ -mindepth 1 -maxdepth 1 -type d ! -empty -print0)
             for l_module in "${a_module[@]}"; do
                if grep -Psoiq -- '\b'"$l_module"'\b' <<< "${a_mounted[*]}"; then
                   a_output+=("  - \"$l_module\"")
                elif grep -Psoiq -- '\b'"$l_module"'\b' <<< "${a_lsmod[*]}"; then
                   a_output2+=("  - \"$l_module\"")
                elif ! grep -Psioq -- '\binstall\h+'"${l_module//-/_}"'\h+\H+\b' <<< "${a_showconfig[*]}" || \
                ! grep -Psioq -- '\bblacklist\h+'"${l_module//-/_}"'\b' <<< "${a_showconfig[*]}"; then
                   a_output3+=("  - \"$l_module\"")
                fi
             done
             [ "${#a_output[@]}" -gt 0 ] && printf '%s\n' "" \
             "- There are \"${#a_output[@]}\" kernel modules currently mounted:" "${a_output[@]}"
             [ "${#a_output2[@]}" -gt 0 ] && printf '%s\n' "" \
             "- There are \"${#a_output2[@]}\" kernel modules currently loaded:" "${a_output2[@]}"
             [ "${#a_output3[@]}" -gt 0 ] && printf '%s\n' "" \
             "- There are \"${#a_output3[@]}\" Kernel modules currently loadable:" "${a_output3[@]}"
          }
          {% endraw %}
      register: script_create_1
      ignore_errors: true

    - name: Req 1 - Execute the complete CIS audit script
      shell: "/tmp/cis_audit_1.1.1.11.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Req 1 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_1.1.1.11.sh"
        state: absent
      ignore_errors: true

    - name: Req 1 - Store requirement 1 details
      set_fact:
        task_1_name: "Execute complete CIS audit script for checkpoint 1.1.1.11"
        task_1_cmd: "/tmp/cis_audit_1.1.1.11.sh"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: |
          {{ (result_1.stdout | default('')) + (result_1.stderr | default('') | replace('\n', ' ')) | trim }}
        status_1: >-
          {% set rc = result_1.rc | default(-1) %}
          {% set output = result_1.stdout | default('') | trim %}
          {% if rc == 0 %}
            {% if 'Kernel modules currently loadable' in output %}
              FAIL
            {% else %}
              PASS
            {% endif %}
          {% else %}
            UNKNOWN
          {% endif %}
        rationale_1: >-
          {% set rc = result_1.rc | default(-1) %}
          {% set output = result_1.stdout | default('') | trim %}
          {% set error = result_1.stderr | default('') | trim %}
          {% if rc == 0 %}
            {% if 'Kernel modules currently loadable' in output %}
              FAIL: Found filesystem kernel modules that are loadable and not properly blacklisted/disabled
            {% else %}
              PASS: All unused filesystem kernel modules are properly blacklisted or disabled
            {% endif %}
          {% else %}
            UNKNOWN: Audit script failed to execute (exit code {{ rc }}). Error: {{ error }}
          {% endif %}

    # Requirement 2: Overall verification
    - name: Req 2 - Store requirement 2 details
      set_fact:
        task_2_name: "Overall compliance check"
        task_2_cmd: "N/A"
        task_2_rc: "0"
        data_2: "Derived from requirement 1 audit results"
        status_2: >-
          {% if status_1 | trim == 'UNKNOWN' %}
            UNKNOWN
          {% else %}
            {{ status_1 | trim }}
          {% endif %}
        rationale_2: >-
          {% if status_1 | trim == 'UNKNOWN' %}
            UNKNOWN: Cannot determine overall compliance due to audit script failure in requirement 1
          {% elif status_1 | trim == 'PASS' %}
            PASS: All requirements met - unused filesystem kernel modules are not available
          {% else %}
            FAIL: Unused filesystem kernel modules are available (not blacklisted or disabled)
          {% endif %}

    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.1.1.11"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.1.11"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_2 | trim }}"
          - "  Rationale: {{ ('PASS when req_1=PASS, FAIL otherwise' if status_1|trim == 'PASS' else ('UNKNOWN: Audit script failed' if status_1|trim == 'UNKNOWN' else 'FAIL: Requirement 1 failed')) | trim }}"
          - "========================================================"