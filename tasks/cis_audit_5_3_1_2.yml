---
- name: Initialize meta data variables
  set_fact:
    kcs_article: CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.3.1.2
    req_1: 'Verify the installed version of authselect using command: rpm -q authselect'
    req_2: 'OVERALL Verify: Ensure latest version of authselect is installed'

- name: Initialize data variables
  set_fact:
    task_1_name: "Not executed"
    task_1_cmd: "N/A"
    task_1_rc: -1
    task_2_name: "Not executed"
    task_2_cmd: "N/A"
    task_2_rc: -1
    data_1: ""
    data_2: ""
    status_1: "UNKNOWN"
    status_2: "UNKNOWN"
    rationale_1: "Not evaluated"
    rationale_2: "Not evaluated"

    # Requirement 1: Check authselect version
- name: "Req 1 - Check authselect version"
  shell: rpm -q authselect
  args:
    executable: /bin/bash
  register: result_1
  ignore_errors: true
  changed_when: false

- name: Store requirement 1 details
  set_fact:
    task_1_name: "Check authselect version"
    task_1_cmd: "rpm -q authselect"
    task_1_rc: "{{ result_1.rc | default(-1) }}"
    data_1: "{{ result_1.stdout | default('') | trim }}"
    status_1: >-
      {% set output = result_1.stdout | default('') | trim %}
      {% if output != '' %}
        {% set version_match = output | regex_search('authselect-([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)') %}
        {% if version_match %}
          {% set version_parts = version_match.split('-') %}
          {% set main_version = version_parts[1] %}
          {% set release = version_parts[2] | int %}
          {% set major = main_version.split('.')[0] | int %}
          {% set minor = main_version.split('.')[1] | int %}
          {% set patch = main_version.split('.')[2] | int %}
          {# Compare with 1.2.6-2 #}
          {% if (major > 1) or 
                (major == 1 and minor > 2) or
                (major == 1 and minor == 2 and patch > 6) or
                (major == 1 and minor == 2 and patch == 6 and release >= 2) %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        {% else %}
          FAIL
        {% endif %}
      {% else %}
        FAIL
      {% endif %}
    rationale_1: >-
      {% set output = result_1.stdout | default('') | trim %}
      {% if output != '' %}
        {% set version_match = output | regex_search('authselect-([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)') %}
        {% if version_match %}
          {% set version_parts = version_match.split('-') %}
          {% set main_version = version_parts[1] %}
          {% set release = version_parts[2] | int %}
          {% set major = main_version.split('.')[0] | int %}
          {% set minor = main_version.split('.')[1] | int %}
          {% set patch = main_version.split('.')[2] | int %}
          {% if (major > 1) or 
                (major == 1 and minor > 2) or
                (major == 1 and minor == 2 and patch > 6) or
                (major == 1 and minor == 2 and patch == 6 and release >= 2) %}
            PASS: Installed version ({{ output }}) is >= authselect-1.2.6-2
          {% else %}
            FAIL: Installed version ({{ output }}) is < authselect-1.2.6-2
          {% endif %}
        {% else %}
          FAIL: Could not extract version from output: {{ output }}
        {% endif %}
      {% else %}
        FAIL: No output from command (authselect may not be installed)
      {% endif %}

    # Requirement 2: Overall verify (depends on requirement 1)
- name: Store requirement 2 details
  set_fact:
    task_2_name: "Overall verify authselect version"
    task_2_cmd: "N/A (depends on requirement 1)"
    task_2_rc: 0
    data_2: "{{ data_1 }}"
    status_2: "{{ status_1 | trim }}"
    rationale_2: "{{ 'PASS: Requirement 1 passed' if (status_1 | trim) == 'PASS' else 'FAIL: Requirement 1 failed' }}"

- name: Generate compliance report
  debug:
    msg:
    - "========================================================"
    - "        COMPLIANCE REPORT - CIS 5.3.1.2"
    - "========================================================"
    - "Reference: {{ kcs_article }}"
    - "========================================================"
    - ""
    - "REQUIREMENT 1 - {{ req_1 }}:"
    - "  Task: {{ task_1_name }}"
    - "  Command: {{ task_1_cmd }}"
    - "  Exit code: {{ task_1_rc }}"
    - "  Data: {{ data_1 }}"
    - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
    - ""
    - "REQUIREMENT 2 - {{ req_2 }}:"
    - "  Task: {{ task_2_name }}"
    - "  Command: {{ task_2_cmd }}"
    - "  Exit code: {{ task_2_rc }}"
    - "  Data: {{ data_2 }}"
    - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
    - ""
    - "========================================================"
    - "OVERALL COMPLIANCE:"
    - "  Result: {{ status_2 | trim }}"
    - "  Rationale: {{ rationale_2 | trim }}"
    - "========================================================"

- name: Set HTML Report Params
  set_fact:
    audit_result: '{{ audit_result | default([]) + [{ ''status_5_3_1_2'': status_2 | trim }] }}'
