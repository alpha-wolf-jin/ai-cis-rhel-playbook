---
- - name: Initialize meta data variables
    set_fact:
      cis_reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.7.3
      req_1: 'Check the contents of the remote login warning banner file using command:
        cat /etc/issue.net'
      req_2: 'Verify the remote login warning banner does not contain prohibited system
        information using command: grep -E -i ''(\\\v|\\\r|\\\m|\\\s|$(grep ''^ID=''
        /etc/os-release | cut -d= -f2 | sed -e ''s/\"//g''))'' /etc/issue.net

        '
      req_3: 'OVERALL Verify: Ensure remote login warning banner is configured properly'
  - name: Initialize data variables
    set_fact:
      task_1_name: Not executed
      task_1_cmd: N/A
      task_1_rc: -1
      task_2_name: Not executed
      task_2_cmd: N/A
      task_2_rc: -1
      task_3_name: Not executed
      task_3_cmd: N/A
      task_3_rc: -1
  - name: Req 1 - Check remote login warning banner contents
    shell: 'cat /etc/issue.net

      '
    args:
      executable: /bin/bash
    register: result_1
    ignore_errors: true
    changed_when: false
  - name: Req 2 - Check for prohibited strings in /etc/issue.net
    shell: '{% raw %}

      grep -E -i "(\\\v|\\\r|\\\m|\\\s|$(grep ''^ID='' /etc/os-release | cut -d= -f2
      | sed -e ''s/"//g''))" /etc/issue.net

      {% endraw %}

      '
    args:
      executable: /bin/bash
    register: result_2
    ignore_errors: true
    changed_when: false
  - name: Store requirement 1 details
    set_fact:
      task_1_name: Check remote login warning banner contents
      task_1_cmd: cat /etc/issue.net
      task_1_rc: '{{ result_1.rc | default(-1) }}'
      data_1: '{{ result_1.stdout | default('''') | trim }}'
      status_1: "{% set output = result_1.stdout | default('') | trim %} {% if output\
        \ != '' %}\n  UNKNOWN\n{% else %}\n  FAIL\n{% endif %}"
      rationale_1: "{% set output = result_1.stdout | default('') | trim %} {% if\
        \ output != '' %}\n  UNKNOWN: Manual verification required - verify contents\
        \ match site policy (must include organization's name and monitoring policies)\n\
        {% else %}\n  FAIL: File /etc/issue.net is empty or does not exist\n{% endif\
        \ %}"
  - name: Store requirement 2 details
    set_fact:
      task_2_name: Check for prohibited strings in /etc/issue.net
      task_2_cmd: 'grep -E -i ''(\\\v|\\\r|\\\m|\\\s|$(grep ''^ID='' /etc/os-release
        | cut -d= -f2 | sed -e ''s/\"//g''))'' /etc/issue.net

        '
      task_2_rc: '{{ result_2.rc | default(-1) }}'
      data_2: '{{ result_2.stdout | default('''') | trim }}'
      status_2: "{% set output = result_2.stdout | default('') | trim %} {% set rc\
        \ = result_2.rc | default(-1) %} {% if output == '' and rc == 1 %}\n  PASS\n\
        {% else %}\n  FAIL\n{% endif %}"
      rationale_2: "{% set output = result_2.stdout | default('') | trim %} {% set\
        \ rc = result_2.rc | default(-1) %} {% if output == '' and rc == 1 %}\n  PASS:\
        \ No prohibited strings found in /etc/issue.net\n{% else %}\n  FAIL: Prohibited\
        \ strings found in /etc/issue.net: {{ output }}\n{% endif %}"
  - name: Req 3 - Overall verification
    set_fact:
      task_3_name: Overall verification
      task_3_cmd: N/A - Combined check
      task_3_rc: 0
      data_3: 'Requirement 1 status: {{ status_1 | default(''UNKNOWN'') }}, Requirement
        2 status: {{ status_2 | default(''UNKNOWN'') }}'
      status_3: "{% if (status_1 | default('FAIL') | trim != 'FAIL') and (status_2\
        \ | default('FAIL') | trim == 'PASS') %}\n  PASS\n{% else %}\n  FAIL\n{% endif\
        \ %}"
      rationale_3: "{% if (status_1 | default('FAIL') | trim != 'FAIL') and (status_2\
        \ | default('FAIL') | trim == 'PASS') %}\n  PASS: Remote login warning banner\
        \ exists and contains no prohibited strings\n{% else %}\n  FAIL: Either banner\
        \ is missing/empty or contains prohibited strings\n{% endif %}"
  - name: Generate compliance report
    debug:
      msg:
      - ========================================================
      - '        COMPLIANCE REPORT - CIS 1.7.3'
      - ========================================================
      - 'Reference: {{ cis_reference }}'
      - ========================================================
      - ''
      - 'REQUIREMENT 1 - {{ req_1 }}:'
      - '  Task: {{ task_1_name | default(''Task not recorded'') }}'
      - '  Command: {{ task_1_cmd | default(''N/A'') }}'
      - '  Exit code: {{ task_1_rc | default(-1) }}'
      - '  Data: {{ data_1 | default('''') | trim }}'
      - '  Status: {{ status_1 | default(''UNKNOWN'') | trim }}'
      - '  Rationale: {{ rationale_1 | default(''Not evaluated'') | trim }}'
      - ''
      - 'REQUIREMENT 2 - {{ req_2 | trim }}:'
      - '  Task: {{ task_2_name | default(''Task not recorded'') }}'
      - '  Command: {{ task_2_cmd | default(''N/A'') | trim }}'
      - '  Exit code: {{ task_2_rc | default(-1) }}'
      - '  Data: {{ data_2 | default('''') | trim }}'
      - '  Status: {{ status_2 | default(''UNKNOWN'') | trim }}'
      - '  Rationale: {{ rationale_2 | default(''Not evaluated'') | trim }}'
      - ''
      - 'REQUIREMENT 3 - {{ req_3 }}:'
      - '  Task: {{ task_3_name | default(''Task not recorded'') }}'
      - '  Command: {{ task_3_cmd | default(''N/A'') }}'
      - '  Exit code: {{ task_3_rc | default(-1) }}'
      - '  Data: {{ data_3 | default('''') | trim }}'
      - '  Status: {{ status_3 | default(''UNKNOWN'') | trim }}'
      - '  Rationale: {{ rationale_3 | default(''Not evaluated'') | trim }}'
      - ''
      - ========================================================
      - 'OVERALL COMPLIANCE:'
      - '  Result: {{ status_3 | default(''UNKNOWN'') | trim }}'
      - '  Rationale: {{ rationale_3 | default(''Not evaluated'') | trim }}'
      - ========================================================
  - name: Set HTML Report Params
    set_fact:
      audit_result: '{{ audit_result | default([]) + [{ ''status_1_7_3'': status_3
        | trim }] }}'

