---
- name: Initialize meta data variables
  set_fact:
    kcs_article: CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.8
    req_1: Verify sshd Banner parameter is configured
    req_2: If Match blocks are used, verify Banner parameter for specific user context
    req_3: Verify configured Banner file exists and display contents
    req_4: Verify Banner file does not contain escape sequences or OS identification
    req_5: 'OVERALL Verify: Ensure sshd Banner is configured'
    test_user: root

- name: Initialize data variables
  set_fact:
    task_1_name: "Not executed"
    task_1_cmd: "N/A"
    task_1_rc: -1
    task_2_name: "Not executed"
    task_2_cmd: "N/A"
    task_2_rc: -1
    task_3_name: "Not executed"
    task_3_cmd: "N/A"
    task_3_rc: -1
    task_4_name: "Not executed"
    task_4_cmd: "N/A"
    task_4_rc: -1

    # Requirement 1: Verify sshd Banner parameter is configured
- name: Req 1 - Check sshd Banner configuration
  shell: |
    sshd -T | grep -Pi -- '^banner\h+\/\H+'
  args:
    executable: /bin/bash
  register: result_1
  ignore_errors: true
  changed_when: false

- name: Store requirement 1 details
  set_fact:
    task_1_name: "Check sshd Banner configuration"
    task_1_cmd: |
      sshd -T | grep -Pi -- '^banner\h+\/\H+'
    task_1_rc: "{{ result_1.rc | default(-1) }}"
    data_1: "{{ result_1.stdout | default('') | trim }}"
    status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim != '') else 'FAIL') | trim }}"
    rationale_1: "{{ ('PASS when command returns a line starting with banner followed by whitespace and absolute file path, FAIL when no output returned' if (result_1.stdout | default('') | trim != '') else 'FAIL: No banner configuration found') | trim }}"

    # Requirement 2: If Match blocks are used, verify Banner parameter for specific user context
- name: Req 2 - Check for Match blocks in sshd_config
  shell: |
    grep -q '^Match' /etc/ssh/sshd_config && echo "true" || echo "false"
  args:
    executable: /bin/bash
  register: match_blocks_check
  ignore_errors: true
  changed_when: false

- name: Req 2 - Check Banner with user context if Match blocks exist
  shell: |
    {% raw %}
    if [ "$match_blocks_exist" = "true" ]; then
      sshd -T -C user={{ test_user }} | grep -Pi -- '^banner\h+\/\H+'
    else
      echo "No Match blocks to test"
    fi
    {% endraw %}
  args:
    executable: /bin/bash
  register: result_2
  ignore_errors: true
  changed_when: false
  vars:
    match_blocks_exist: "{{ match_blocks_check.stdout | default('false') | trim }}"

- name: Store requirement 2 details
  set_fact:
    task_2_name: "Check Banner with user context if Match blocks exist"
    task_2_cmd: |
      {% if match_blocks_check.stdout | default('false') | trim == 'true' %}sshd -T -C user={{ test_user }} | grep -Pi -- '^banner\h+\/\H+'{% else %}No Match blocks found{% endif %}
    task_2_rc: "{{ result_2.rc | default(-1) }}"
    data_2: "{{ result_2.stdout | default('') | trim }}"
    status_2: >-
      {% set match_blocks = match_blocks_check.stdout | default('false') | trim %}
      {% set output = result_2.stdout | default('') | trim %}
      {% if match_blocks == 'false' %}
        PASS
      {% elif match_blocks == 'true' and output != '' and output != 'No Match blocks to test' %}
        PASS
      {% elif match_blocks == 'true' and output == '' %}
        FAIL
      {% else %}
        FAIL
      {% endif %}
    rationale_2: >-
      {% set match_blocks = match_blocks_check.stdout | default('false') | trim %}
      {% set output = result_2.stdout | default('') | trim %}
      {% if match_blocks == 'false' %}
        PASS: No Match blocks found in sshd_config
      {% elif match_blocks == 'true' and output != '' and output != 'No Match blocks to test' %}
        PASS: Banner path found for user context
      {% elif match_blocks == 'true' and output == '' %}
        FAIL: No banner configuration found for user context while Match blocks exist
      {% else %}
        FAIL: Unknown condition
      {% endif %}

    # Requirement 3: Verify configured Banner file exists and display contents
- name: Req 3 - Create script to check Banner file existence and contents
  copy:
    dest: "/tmp/check_banner_file.sh"
    mode: '0700'
    content: |
      {% raw %}
      #!/usr/bin/env bash
      banner_file=$(sshd -T | awk '$1 == "banner" {print $2}')
      if [ -e "$banner_file" ]; then
          cat "$banner_file"
      fi
      {% endraw %}
  register: script_create_3
  ignore_errors: true

- name: Req 3 - Execute Banner file check script
  shell: "/tmp/check_banner_file.sh"
  args:
    executable: /bin/bash
  register: result_3
  ignore_errors: true
  changed_when: false

- name: Req 3 - Remove temporary script
  file:
    path: "/tmp/check_banner_file.sh"
    state: absent
  ignore_errors: true

- name: Store requirement 3 details
  set_fact:
    task_3_name: "Verify configured Banner file exists and display contents"
    task_3_cmd: "Check if banner file exists and display contents"
    task_3_rc: "{{ result_3.rc | default(-1) }}"
    data_3: "{{ result_3.stdout | default('') | trim }}"
    status_3: "{{ ('PASS' if (result_3.rc | default(1) == 0 and result_3.stdout | default('') != '') else 'FAIL') | trim }}"
    rationale_3: "{{ ('PASS when banner file exists and contents can be displayed' if (result_3.rc | default(1) == 0 and result_3.stdout | default('') != '') else 'FAIL: Banner file does not exist or cannot be read') | trim }}"

    # Requirement 4: Verify Banner file does not contain escape sequences or OS identification
- name: Req 4 - Create script to check Banner file for escape sequences
  copy:
    dest: "/tmp/check_banner_escape.sh"
    mode: '0700'
    content: |
      {% raw %}
      #!/usr/bin/env bash
      banner_file=$(sshd -T | awk '$1 == "banner" {print $2}')
      os_id=$(grep '^ID=' /etc/os-release | cut -d= -f2 | sed -e 's/"//g')
      grep -Psi -- "(\\\v|\\\r|\\\m|\\\s|\b$os_id\b)" "$banner_file"
      {% endraw %}
  register: script_create_4
  ignore_errors: true

- name: Req 4 - Execute escape sequence check script
  shell: "/tmp/check_banner_escape.sh"
  args:
    executable: /bin/bash
  register: result_4
  ignore_errors: true
  changed_when: false

- name: Req 4 - Remove temporary script
  file:
    path: "/tmp/check_banner_escape.sh"
    state: absent
  ignore_errors: true

- name: Store requirement 4 details
  set_fact:
    task_4_name: "Verify Banner file does not contain escape sequences or OS identification"
    task_4_cmd: "Check banner file for escape sequences and OS identification"
    task_4_rc: "{{ result_4.rc | default(-1) }}"
    data_4: "{{ result_4.stdout | default('') | trim }}"
    status_4: "{{ ('PASS' if (result_4.stdout | default('') == '') else 'FAIL') | trim }}"
    rationale_4: "{{ ('PASS when no escape sequences or OS ID found in banner file' if (result_4.stdout | default('') == '') else 'FAIL: Escape sequences or OS ID found in banner file') | trim }}"

    # Requirement 5: OVERALL Verify
- name: Store requirement 5 details
  set_fact:
    status_5: >-
      {% if status_1 | default('FAIL') == 'PASS' and 
            status_3 | default('FAIL') == 'PASS' and 
            status_4 | default('FAIL') == 'PASS' %}
        PASS
      {% else %}
        FAIL
      {% endif %}
    rationale_5: >-
      {% if status_1 | default('FAIL') == 'PASS' and 
            status_3 | default('FAIL') == 'PASS' and 
            status_4 | default('FAIL') == 'PASS' %}
        PASS: req_1=PASS AND req_3=PASS AND req_4=PASS
      {% else %}
        FAIL: One or more requirements failed (req_1: {{ status_1 | default('FAIL') }}, req_3: {{ status_3 | default('FAIL') }}, req_4: {{ status_4 | default('FAIL') }})
      {% endif %}

    # Final report
- name: Generate compliance report
  debug:
    msg:
    - "========================================================"
    - "        COMPLIANCE REPORT - CIS 5.1.8"
    - "========================================================"
    - "Reference: {{ kcs_article }}"
    - "========================================================"
    - ""
    - "REQUIREMENT 1 - {{ req_1 }}:"
    - "  Task: {{ task_1_name | default('Task not recorded') }}"
    - "  Command: {{ task_1_cmd | default('N/A') }}"
    - "  Exit code: {{ task_1_rc | default(-1) }}"
    - "  Data: {{ data_1 | default('') | trim }}"
    - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
    - ""
    - "REQUIREMENT 2 - {{ req_2 }}:"
    - "  Task: {{ task_2_name | default('Task not recorded') }}"
    - "  Command: {{ task_2_cmd | default('N/A') }}"
    - "  Exit code: {{ task_2_rc | default(-1) }}"
    - "  Data: {{ data_2 | default('') | trim }}"
    - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
    - ""
    - "REQUIREMENT 3 - {{ req_3 }}:"
    - "  Task: {{ task_3_name | default('Task not recorded') }}"
    - "  Command: {{ task_3_cmd | default('N/A') }}"
    - "  Exit code: {{ task_3_rc | default(-1) }}"
    - "  Data: {{ data_3 | default('') | trim }}"
    - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
    - ""
    - "REQUIREMENT 4 - {{ req_4 }}:"
    - "  Task: {{ task_4_name | default('Task not recorded') }}"
    - "  Command: {{ task_4_cmd | default('N/A') }}"
    - "  Exit code: {{ task_4_rc | default(-1) }}"
    - "  Data: {{ data_4 | default('') | trim }}"
    - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
    - ""
    - "========================================================"
    - "OVERALL COMPLIANCE:"
    - "  Result: {{ status_5 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_5 | default('Not evaluated') | trim }}"
    - "========================================================"

- name: Set HTML Report Params
  set_fact:
    audit_result: '{{ audit_result | default([]) + [{ ''status_5_1_8'': status_5 | trim }] }}'
