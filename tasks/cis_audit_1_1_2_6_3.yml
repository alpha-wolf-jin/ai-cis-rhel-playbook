---
- name: Initialize meta data variables
  set_fact:
    cis_reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.1.2.6.3
    req_1: Check if /var/log is a separate partition
    req_2: If /var/log is separate partition, verify nosuid mount option is set
    req_3: 'OVERALL Verify: Ensure nosuid option set on /var/log partition'

- name: Initialize data variables
  set_fact:
    task_1_name: "Not executed"
    task_1_cmd: "N/A"
    task_1_rc: -1
    task_2_name: "Not executed"
    task_2_cmd: "N/A"
    task_2_rc: -1
    task_3_name: "Not executed"
    task_3_cmd: "N/A"
    task_3_rc: -1

    # Requirement 1: Check if /var/log is a separate partition
- name: Req 1 - Check if /var/log is separate partition
  shell: findmnt -kn /var/log
  args:
    executable: /bin/bash
  register: result_1
  ignore_errors: true
  changed_when: false

- name: Store requirement 1 details
  set_fact:
    task_1_name: "Check if /var/log is separate partition"
    task_1_cmd: "findmnt -kn /var/log"
    task_1_rc: "{{ result_1.rc | default(-1) }}"
    data_1: "{{ result_1.stdout | default('') | trim }}"
    status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim != '') else 'FAIL') | trim }}"
    rationale_1: "PASS when command returns a mount point entry (indicating a separate partition exists), FAIL when no output (indicating /var/log is not a separate partition and the check is not applicable)"

    # Requirement 2: If /var/log is separate partition, verify nosuid mount option is set
- name: Req 2 - Verify nosuid option on /var/log partition
  shell: findmnt -kn /var/log | grep -v nosuid
  args:
    executable: /bin/bash
  register: result_2
  ignore_errors: true
  changed_when: false
  when: data_1 | length > 0

- name: Store requirement 2 details
  set_fact:
    task_2_name: "Verify nosuid option on /var/log partition"
    task_2_cmd: "findmnt -kn /var/log | grep -v nosuid"
    task_2_rc: "{{ result_2.rc | default(-1) }}"
    data_2: "{{ result_2.stdout | default('') | trim }}"
    status_2: "{{ ('PASS' if (result_2.stdout | default('') | trim == '') else 'FAIL') | trim }}"
    rationale_2: 'PASS when the command returns no output (meaning the line containing the mount point does NOT lack "nosuid"), FAIL when any output is returned (meaning the mount point line was found and it lacks the "nosuid" option)'
  when: data_1 | length > 0

    # Requirement 3: Overall verification
- name: Store requirement 3 details
  set_fact:
    task_3_name: "OVERALL Verify: Ensure nosuid option set on /var/log partition"
    task_3_cmd: "Combined logic of req_1 and req_2"
    task_3_rc: "0"
    data_3: "req_1 status: {{ status_1 | default('UNKNOWN') }}, req_2 status: {{ status_2 | default('UNKNOWN') }}"
    status_3: >-
      {% if status_1 | default('UNKNOWN') | trim == 'FAIL' %}
        PASS
      {% elif (status_1 | default('UNKNOWN') | trim == 'PASS') and (status_2 | default('UNKNOWN') | trim == 'PASS') %}
        PASS
      {% elif (status_1 | default('UNKNOWN') | trim == 'PASS') and (status_2 | default('UNKNOWN') | trim == 'FAIL') %}
        FAIL
      {% else %}
        UNKNOWN
      {% endif %}
    rationale_3: "PASS when (req_1=FAIL) OR (req_1=PASS AND req_2=PASS), FAIL when (req_1=PASS AND req_2=FAIL)"

    # Final report - MUST include Status and Rationale for each requirement
- name: Generate compliance report
  debug:
    msg:
    - "========================================================"
    - "        COMPLIANCE REPORT - CIS 1.1.2.6.3"
    - "========================================================"
    - "Reference: {{ cis_reference }}"
    - "========================================================"
    - ""
    - "REQUIREMENT 1 - {{ req_1 }}:"
    - "  Task: {{ task_1_name | default('Task not recorded') }}"
    - "  Command: {{ task_1_cmd | default('N/A') }}"
    - "  Exit code: {{ task_1_rc | default(-1) }}"
    - "  Data: {{ data_1 | default('') | trim }}"
    - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
    - ""
    - "REQUIREMENT 2 - {{ req_2 }}:"
    - "  Task: {{ task_2_name | default('Task not recorded') }}"
    - "  Command: {{ task_2_cmd | default('N/A') }}"
    - "  Exit code: {{ task_2_rc | default(-1) }}"
    - "  Data: {{ data_2 | default('') | trim }}"
    - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
    - ""
    - "REQUIREMENT 3 - {{ req_3 }}:"
    - "  Task: {{ task_3_name | default('Task not recorded') }}"
    - "  Command: {{ task_3_cmd | default('N/A') }}"
    - "  Exit code: {{ task_3_rc | default(-1) }}"
    - "  Data: {{ data_3 | default('') | trim }}"
    - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
    - ""
    - "========================================================"
    - "OVERALL COMPLIANCE:"
    - "  Result: {{ status_3 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ ('PASS when (req_1=FAIL) OR (req_1=PASS AND req_2=PASS), FAIL when (req_1=PASS AND req_2=FAIL)') | trim }}"
    - "========================================================"

- name: Set HTML Report Params
  set_fact:
    audit_result: '{{ audit_result | default([]) + [{ ''status_1_1_2_6_3'': status_3 | trim }] }}'
