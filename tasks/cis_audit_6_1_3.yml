---
- name: Initialize meta data variables
  set_fact:
    cis_checkpoint: CIS RHEL 9 Benchmark v2.0.0 checkpoint 6.1.3
    req_1: Run the provided CIS audit script to verify Ensure cryptographic mechanisms are used to protect the integrity of audit tools. Verify that Advanced Intrusion Detection Environment (AIDE) is properly configured
    overall_verify: Ensure cryptographic mechanisms are used to protect the integrity of audit tools

- name: Initialize data variables
  set_fact:
    task_1_name: "Not executed"
    task_1_cmd: "N/A"
    task_1_rc: -1
    task_overall_name: "Overall verification"
    task_overall_cmd: "N/A"
    task_overall_rc: -1

    # Requirement 1: Run CIS audit script for 6.1.3
- name: Req 1 - Execute CIS audit script for 6.1.3
  copy:
    dest: "/tmp/cis_audit_6.1.3.sh"
    mode: '0700'
    content: |
      {% raw %}
      #!/usr/bin/env bash

      {
         a_output=();a_output2=();a_output3=();a_parlist=()
         l_systemd_analyze="$(whereis systemd-analyze | awk '{print $2}')"
         a_audit_files=("auditctl" "auditd" "ausearch" "aureport" "autrace" "augenrules")
         f_parameter_chk()
         {
            for l_tool_file in "${a_parlist[@]}"; do
               if grep -Pq -- '\b'"$l_tool_file"'\b' <<< "${!A_out[*]}"; then
                  for l_string in "${!A_out[@]}"; do
                     l_check="$(grep -Po -- '^\h*(\/usr)?\/sbin\/'"$l_tool_file"'\b' <<< "$l_string")"
                     if [ -n "$l_check" ]; then
                        l_fname="$(printf '%s' "${A_out[$l_string]}")"
                        [ "$l_check" != "$(readlink -f "$l_check")" ] && \
                        a_output3+=("  - \"$l_check\" should be updated to: \"$(readlink -f "$l_check")\"" "    in: \"$l_fname\"")
                        a_missing=()
                        for l_var in "${a_items[@]}"; do
                           if ! grep -Pq -- "\b$l_var\b" <<< "$l_string"; then
                              a_missing+=("\"$l_var\"")
                           fi
                        done
                        if [ "${#a_missing[@]}" -gt 0 ]; then
                           a_output2+=(" - Option(s): ( ${a_missing[*]} ) are missing from: \"$l_tool_file\" in: \"$l_fname\"")
                        else
                           a_output+=(" - Audit tool file \"$l_tool_file\" exists as:" "   \"$l_string\"" "   in the configuration file: \"$l_fname\"")
                        fi
                     fi
                  done
               else
                  a_output2+=(" - Audit tool file \"$l_tool_file\" doesn't exist in an AIDE configuration file")
               fi
            done
         }
         f_aide_conf()
         {
            l_config_file="$(whereis aide.conf | awk '{print $2}')"
            if [ -f "$l_config_file" ]; then
               a_items=("p" "i" "n" "u" "g" "s" "b" "acl" "xattrs" "sha512")
               declare -A A_out
               while IFS= read -r l_out; do
                  if grep -Pq -- '^\h*\#\h*\/[^#\n\r]+\.conf\b' <<< "$l_out"; then
                     l_file="${l_out//# /}"
                  else
                     for i in "${a_parlist[@]}"; do
                        grep -Pq -- '^\h*(\/usr)?\/sbin\/'"$i"'\b' <<< "$l_out" && A_out+=(["$l_out"]="$l_file")
                     done
                  fi
               done < <("$l_systemd_analyze" cat-config "$l_config_file" | grep - Pio '^\h*([^#\n\r]+|#\h*\/[^#\n\r\h]+\.conf\b)')
               if [ "${#A_out[@]}" -gt 0 ]; then
                  f_parameter_chk
               else
                  a_output2+=(" - No audit tool files are configured in an AIDE configuration file")
               fi
            else
               a_output2+=(" - AIDE configuration file not found." "   Please verify AIDE is installed on the system")
            fi
         }
         for l_audit_file in "${a_audit_files[@]}"; do
            if [ -f "$(readlink -f "/sbin/$l_audit_file")" ]; then
               a_parlist+=("$l_audit_file")
            else
               a_output+=(" - Audit tool file \"$(readlink -f "/sbin/$l_audit_file")\" doesn't exist")
            fi
         done
         [ "${#a_parlist[@]}" -gt 0 ] && f_aide_conf
         if [ "${#a_output2[@]}" -le 0 ]; then
            printf '%s\n' "" "- Audit Result:" "  ** PASS **" "${a_output[@]}"
            [ "${#a_output3[@]}" -gt 0 ] && printf '%s\n' "" "  ** WARNING **" "${a_output3[@]}"
         else
            printf '%s\n' "" "- Audit Result:" "  ** FAIL **" "  * Reasons for audit failure *" "${a_output2[@]}" ""
            [ "${#a_output3[@]}" -gt 0 ] && printf '%s\n' "" "  ** WARNING **" "${a_output3[@]}"
            [ "${#a_output[@]}" -gt 0 ] && printf '%s\n' "- Correctly set:" "${a_output[@]}"
         fi
      }
      {% endraw %}
  register: script_create_1
  ignore_errors: true
  changed_when: false

- name: Req 1 - Execute the audit script
  shell: "/tmp/cis_audit_6.1.3.sh"
  args:
    executable: /bin/bash
  register: result_1
  ignore_errors: true
  changed_when: false

- name: Req 1 - Remove temporary audit script
  file:
    path: "/tmp/cis_audit_6.1.3.sh"
    state: absent
  ignore_errors: true
  changed_when: false

- name: Store requirement 1 details
  set_fact:
    task_1_name: "Execute CIS audit script for 6.1.3"
    task_1_cmd: "/tmp/cis_audit_6.1.3.sh"
    task_1_rc: "{{ result_1.rc | default(-1) }}"
    data_1: "{{ result_1.stdout | default('') | trim }}"
    status_1: "{{ ('PASS' if '** PASS **' in result_1.stdout else 'FAIL') | trim }}"
    rationale_1: "PASS when script output shows '** PASS **', FAIL when script output shows '** FAIL **' or indicates non-compliance"

- name: Store overall verification details
  set_fact:
    data_overall: "Overall verification based on requirement 1"
    status_overall: "{{ status_1 | default('FAIL') }}"
    rationale_overall: "PASS when req_1=PASS, FAIL otherwise"

    # Final report
- name: Generate compliance report
  debug:
    msg:
    - "========================================================"
    - "        COMPLIANCE REPORT - CIS 6.1.3"
    - "========================================================"
    - "Reference: {{ cis_checkpoint }}"
    - "========================================================"
    - ""
    - "REQUIREMENT 1 - {{ req_1 }}:"
    - "  Task: {{ task_1_name | default('Task not recorded') }}"
    - "  Command: {{ task_1_cmd | default('N/A') }}"
    - "  Exit code: {{ task_1_rc | default(-1) }}"
    - "  Data: {{ data_1 | default('') | trim }}"
    - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
    - ""
    - "========================================================"
    - "OVERALL COMPLIANCE:"
    - "  Result: {{ status_overall | default('UNKNOWN') | trim }}"
    - "  Rationale: {{ rationale_overall | default('Not evaluated') | trim }}"
    - "========================================================"

- name: Set HTML Report Params
  set_fact:
    audit_result: '{{ audit_result | default([]) + [{ ''status_6_1_3'': status_1 | trim }] }}'
