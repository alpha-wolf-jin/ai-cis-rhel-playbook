---
- name: Data Collection for KCS Article 4214501 - systemd dbus/cgroup issues
  hosts: all
  become: yes
  gather_facts: yes
  
  tasks:
    # CRITICAL: Initialize ALL data collection variables FIRST with default values
    - name: Initialize ALL data collection variables with defaults
      set_fact:
        data_journal_systemd_logind: "Not collected yet"
        data_pod_states: "Not collected yet"
        data_docker_daemon_logs: "Not collected yet"
        data_openshift_node_logs: "Not collected yet"
        data_systemd_version_config: "Not collected yet"
        data_cgroup_configuration: "Not collected yet"
        data_kcs_reference: "https://access.redhat.com/solutions/4214501"
    
    # ========================================================
    # REQUIREMENT 1: Collect specific journal log entries containing systemd-logind errors with 'Connection timed out'
    # ========================================================
    - name: Collect journal logs for systemd-logind errors with 'Connection timed out'
      ansible.builtin.shell: |
        journalctl -u systemd-logind --since="1 day ago" --no-pager | grep -i "Connection timed out" | tail -50
      register: journal_logind_check
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Debug journal logind check result
      debug:
        var: journal_logind_check
      tags: [debug]
    
    - name: Store journal systemd-logind error data
      set_fact:
        data_journal_systemd_logind: >-
          {{
            journal_logind_check.stdout if journal_logind_check.rc == 0 and journal_logind_check.stdout | length > 0
            else 'No systemd-logind errors with "Connection timed out" found in last 24 hours'
          }}
      when: journal_logind_check is defined
    
    # ========================================================
    # REQUIREMENT 2: Retrieve the current state of pods on the node
    # ========================================================
    - name: Check if oc command is available
      ansible.builtin.command: which oc
      register: oc_check
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Check if docker command is available
      ansible.builtin.command: which docker
      register: docker_check
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Collect pod states using oc (OpenShift)
      ansible.builtin.shell: |
        oc get pods --all-namespaces -o wide | grep -E "(ContainerCreating|Terminating)" | head -100
      register: oc_pod_states
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: oc_check.rc == 0
    
    - name: Collect pod states using docker (if oc not available)
      ansible.builtin.shell: |
        docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" | grep -E "(ContainerCreating|Creating|Terminating|Exited)" | head -100
      register: docker_pod_states
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: oc_check.rc != 0 and docker_check.rc == 0
    
    - name: Debug pod states collection
      debug:
        msg: "OC check: {{ oc_check.rc }}, Docker check: {{ docker_check.rc }}"
      tags: [debug]
    
    - name: Store pod states data
      set_fact:
        data_pod_states: >-
          {{
            'Using oc command:\n' + oc_pod_states.stdout if oc_pod_states is defined and oc_pod_states.rc | default(-1) == 0 and oc_pod_states.stdout | default('') | length > 0
            else 'Using docker command:\n' + docker_pod_states.stdout if docker_pod_states is defined and docker_pod_states.rc | default(-1) == 0 and docker_pod_states.stdout | default('') | length > 0
            else 'No pods in ContainerCreating or Terminating state found (or commands not available)'
          }}
      when: (oc_pod_states is defined and oc_pod_states.rc is defined) or (docker_pod_states is defined and docker_pod_states.rc is defined)
    
    # ========================================================
    # REQUIREMENT 3: Gather docker daemon logs for errors related to container startup timeouts or connection limits
    # ========================================================
    - name: Check docker service status
      ansible.builtin.systemd:
        name: docker
      register: docker_service
      ignore_errors: true
      failed_when: false
    
    - name: Collect docker daemon logs (journalctl)
      ansible.builtin.shell: |
        journalctl -u docker --since="1 day ago" --no-pager | grep -iE "(timeout|connection.*limit|failed to start|startup.*failed)" | tail -100
      register: docker_journal_logs
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: docker_service.status is defined
    
    - name: Collect docker daemon logs (direct log file)
      ansible.builtin.shell: |
        tail -500 /var/log/docker.log 2>/dev/null || tail -500 /var/log/messages 2>/dev/null | grep -i docker | grep -iE "(timeout|connection.*limit|failed to start)" || echo "No docker log files found"
      register: docker_file_logs
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Debug docker logs collection
      debug:
        msg: "Docker service: {{ docker_service.status.ActiveState | default('not found') }}, Journal logs: {{ docker_journal_logs.stdout_lines | length | default(0) }} lines"
      tags: [debug]
    
    - name: Store docker daemon logs data
      set_fact:
        data_docker_daemon_logs: >-
          {{
            'Docker service status: ' + docker_service.status.ActiveState + '\n\nJournal logs (docker unit):\n' + docker_journal_logs.stdout
            if docker_journal_logs is defined and docker_journal_logs.stdout | length > 0
            else 'Docker service status: ' + docker_service.status.ActiveState + '\n\nFile logs:\n' + docker_file_logs.stdout
            if docker_file_logs is defined and docker_file_logs.stdout | length > 0
            else 'Docker service not found or no relevant logs collected'
          }}
    
    # ========================================================
    # REQUIREMENT 4: Collect logs from the atomic-openshift-node service (or kubelet) for 'FailedCreatePodSandBox' events
    # ========================================================
    - name: Check for atomic-openshift-node service
      ansible.builtin.systemd:
        name: atomic-openshift-node
      register: openshift_node_service
      ignore_errors: true
      failed_when: false
    
    - name: Check for kubelet service
      ansible.builtin.systemd:
        name: kubelet
      register: kubelet_service
      ignore_errors: true
      failed_when: false
    
    - name: Collect atomic-openshift-node logs
      ansible.builtin.shell: |
        journalctl -u atomic-openshift-node --since="1 day ago" --no-pager | grep -i "FailedCreatePodSandBox" | tail -50
      register: openshift_node_logs
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: openshift_node_service.status is defined
    
    - name: Collect kubelet logs
      ansible.builtin.shell: |
        journalctl -u kubelet --since="1 day ago" --no-pager | grep -i "FailedCreatePodSandBox" | tail -50
      register: kubelet_logs
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: kubelet_service.status is defined and openshift_node_service.status is not defined
    
    - name: Debug openshift/kubelet logs collection
      debug:
        msg: "OpenShift node service: {{ openshift_node_service.status.ActiveState | default('not found') }}, Kubelet service: {{ kubelet_service.status.ActiveState | default('not found') }}"
      tags: [debug]
    
    - name: Store openshift node logs data
      set_fact:
        data_openshift_node_logs: >-
          {{
            'atomic-openshift-node service logs:\n' + openshift_node_logs.stdout
            if openshift_node_logs is defined and openshift_node_logs.stdout | length > 0
            else 'kubelet service logs:\n' + kubelet_logs.stdout
            if kubelet_logs is defined and kubelet_logs.stdout | length > 0
            else 'No FailedCreatePodSandBox events found in logs (or services not running)'
          }}
    
    # ========================================================
    # REQUIREMENT 5: Retrieve systemd version and relevant configuration files
    # ========================================================
    - name: Get systemd version
      ansible.builtin.command: systemd --version | head -1
      register: systemd_version
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Check system.conf file
      ansible.builtin.stat:
        path: /etc/systemd/system.conf
      register: system_conf_file
      ignore_errors: true
      failed_when: false
    
    - name: Check logind.conf file
      ansible.builtin.stat:
        path: /etc/systemd/logind.conf
      register: logind_conf_file
      ignore_errors: true
      failed_when: false
    
    - name: Collect system.conf content
      ansible.builtin.shell: |
        grep -v "^#" /etc/systemd/system.conf | grep -v "^$" | head -50
      register: system_conf_content
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: system_conf_file.stat.exists | default(false)
    
    - name: Collect logind.conf content
      ansible.builtin.shell: |
        grep -v "^#" /etc/systemd/logind.conf | grep -v "^$" | head -50
      register: logind_conf_content
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: logind_conf_file.stat.exists | default(false)
    
    - name: Debug systemd configuration collection
      debug:
        msg: "Systemd version: {{ systemd_version.stdout | default('unknown') }}, system.conf exists: {{ system_conf_file.stat.exists | default(false) }}, logind.conf exists: {{ logind_conf_file.stat.exists | default(false) }}"
      tags: [debug]
    
    - name: Store systemd version and configuration data
      set_fact:
        data_systemd_version_config: >-
          {{
            'Systemd Version: ' + systemd_version.stdout + '\n\nsystem.conf (non-comment lines):\n' + system_conf_content.stdout + '\n\nlogind.conf (non-comment lines):\n' + logind_conf_content.stdout
            if system_conf_content is defined and logind_conf_content is defined
            else 'Systemd Version: ' + systemd_version.stdout + '\n\nConfiguration files not found or empty'
          }}
    
    # ========================================================
    # REQUIREMENT 6: Gather information about the current cgroup configuration and any related limits
    # ========================================================
    - name: Check cgroup version
      ansible.builtin.shell: |
        stat -fc %T /sys/fs/cgroup/
      register: cgroup_version_check
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Collect cgroup configuration
      ansible.builtin.shell: |
        echo "=== CGroup Version ==="
        cat /proc/filesystems | grep cgroup || echo "cgroup not in /proc/filesystems"
        echo -e "\n=== CGroup Mounts ==="
        mount | grep cgroup || echo "No cgroup mounts found"
        echo -e "\n=== CGroup Controllers ==="
        cat /sys/fs/cgroup/cgroup.controllers 2>/dev/null || echo "cgroup.controllers not available"
        echo -e "\n=== Memory CGroup Limits ==="
        cat /sys/fs/cgroup/memory/memory.limit_in_bytes 2>/dev/null || echo "memory cgroup not available"
        echo -e "\n=== PIDs CGroup Limits ==="
        cat /sys/fs/cgroup/pids/pids.max 2>/dev/null || echo "pids cgroup not available"
        echo -e "\n=== Systemd CGroup Info ==="
        systemd-cgls --no-pager 2>/dev/null | head -100 || echo "systemd-cgls not available"
      register: cgroup_config
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Check for cgroup-related kernel parameters
      ansible.builtin.shell: |
        sysctl -a 2>/dev/null | grep -i cgroup | head -20
      register: cgroup_sysctl
      ignore_errors: true
      failed_when: false
      changed_when: false
    
    - name: Debug cgroup configuration collection
      debug:
        msg: "CGroup filesystem type: {{ cgroup_version_check.stdout | default('unknown') }}, Config output length: {{ cgroup_config.stdout_lines | length | default(0) }} lines"
      tags: [debug]
    
    - name: Store cgroup configuration data
      set_fact:
        data_cgroup_configuration: >-
          {{
            'CGroup Filesystem: ' + cgroup_version_check.stdout + '\n\n' + cgroup_config.stdout + '\n\nKernel Parameters:\n' + cgroup_sysctl.stdout
            if cgroup_config.stdout | length > 0
            else 'CGroup information not available or error collecting data'
          }}
    
    # ========================================================
    # FINAL REPORT - DATA COLLECTION SUMMARY
    # ========================================================
    - name: Generate data collection report
      debug:
        msg:
          - "========================================================"
          - "        DATA COLLECTION REPORT"
          - "========================================================"
          - "Reference KCS Article: {{ data_kcs_reference | default('https://access.redhat.com/solutions/4214501') }}"
          - "systemd stops reading and processing dbus event of runc cgroup invokes"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - Journal log entries containing systemd-logind errors with 'Connection timed out':"
          - "  Data: {{ data_journal_systemd_logind | default('Data collection failed') }}"
          - ""
          - "REQUIREMENT 2 - Current state of pods on the node (ContainerCreating and Terminating states):"
          - "  Data: {{ data_pod_states | default('Data collection failed') }}"
          - ""
          - "REQUIREMENT 3 - Docker daemon logs for errors related to container startup timeouts or connection limits:"
          - "  Data: {{ data_docker_daemon_logs | default('Data collection failed') }}"
          - ""
          - "REQUIREMENT 4 - Logs from atomic-openshift-node/kubelet service for 'FailedCreatePodSandBox' events:"
          - "  Data: {{ data_openshift_node_logs | default('Data collection failed') }}"
          - ""
          - "REQUIREMENT 5 - Systemd version and relevant configuration files (system.conf, logind.conf):"
          - "  Data: {{ data_systemd_version_config | default('Data collection failed') }}"
          - ""
          - "REQUIREMENT 6 - Current cgroup configuration and any related limits:"
          - "  Data: {{ data_cgroup_configuration | default('Data collection failed') }}"
          - ""
          - "========================================================"
          - "        END OF DATA COLLECTION REPORT"
          - "========================================================"
          - ""
          - "NOTE: This playbook only collects data for analysis."
          - "AI will analyze this data against KCS article requirements."
          - "========================================================"
