---
- name: Data Collection for KCS 7101627
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    kcs_article: "https://access.redhat.com/solutions/7101627"
    req_4: "Gather information about any recent ansible-builder execution attempts, including command history or logs"
    req_10: "Collect the version and status of the podman or docker service, if applicable"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_4: "Not collected yet"
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        data_10: "Not collected yet"
        task_10_name: "Not executed"
        task_10_cmd: "N/A"
        task_10_rc: -1

    - name: "Req 4: Search for ansible-builder commands in shell history"
      shell: |
        for hist_file in ~/.bash_history ~/.zsh_history; do
          if [ -f "$hist_file" ]; then
            echo "=== History file: $hist_file ==="
            grep -i "ansible-builder" "$hist_file" | tail -20
            echo ""
          fi
        done
      register: result_4_history
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: "Req 4: Search for ansible-builder in journal logs"
      shell: |
        journalctl --since="1 week ago" --no-pager | grep -i "ansible-builder" | tail -50
      register: result_4_journal
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: "Req 4: Check for ansible-builder log files"
      shell: |
        find /var/log /tmp /home -type f \( -name "*ansible-builder*" -o -name "*ansible_builder*" \) 2>/dev/null | head -20
      register: result_4_logfiles
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Search for ansible-builder in history, logs, and files"
        task_4_cmd: |
          # History check
          for hist_file in ~/.bash_history ~/.zsh_history; do
            if [ -f "$hist_file" ]; then
              echo "=== History file: $hist_file ==="
              grep -i "ansible-builder" "$hist_file" | tail -20
              echo ""
            fi
          done
          # Journal check
          journalctl --since="1 week ago" --no-pager | grep -i "ansible-builder" | tail -50
          # Log files check
          find /var/log /tmp /home -type f \( -name "*ansible-builder*" -o -name "*ansible_builder*" \) 2>/dev/null | head -20
        task_4_rc: "{{ result_4_history.rc | default(0) }}"
        data_4: |
          === Shell History ===
          {{ result_4_history.stdout | default('No history files found or no matches') }}
          
          === Journal Logs ===
          {{ result_4_journal.stdout | default('No journal entries found') }}
          
          === Log Files Found ===
          {{ result_4_logfiles.stdout | default('No ansible-builder log files found') }}

    - name: "Req 10: Check podman and docker service status and version"
      shell: |
        for service in podman docker; do
          if systemctl list-unit-files | grep -q "^${service}\.service"; then
            echo "=== ${service} ==="
            systemctl status ${service} --no-pager
            ${service} --version 2>/dev/null || echo "Version command failed"
            echo ""
          fi
        done
      register: result_10
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: Store requirement 10 details
      set_fact:
        task_10_name: "Check podman and docker service status and version"
        task_10_cmd: |
          for service in podman docker; do
            if systemctl list-unit-files | grep -q "^${service}\.service"; then
              echo "=== ${service} ==="
              systemctl status ${service} --no-pager
              ${service} --version 2>/dev/null || echo "Version command failed"
              echo ""
            fi
          done
        task_10_rc: "{{ result_10.rc | default(-1) }}"
        data_10: "{{ result_10.stdout | default('') }}"

    - name: Generate data collection report (Part 4/11 - Requirement 4)
      debug:
        msg:
          - "========================================================"
          - "        DATA COLLECTION REPORT (Part 4/11)"
          - "========================================================"
          - "Reference KCS Article: {{ kcs_article }}"
          - "Ansible-builder fails to build custom EE with error ‘Cannot find libsystemd or libsystemd-journal:’ when using image: registry.redhat.io/ansible-automation-platform-25/ee-supported-rhel8"
          - "========================================================"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Task: {{ task_4_name | default('Task not recorded') }}"
          - "  Command: {{ task_4_cmd | default('N/A') }}"
          - "  Exit code: {{ task_4_rc | default(-1) }}"
          - "  Data: {{ data_4 | default('Data collection failed') }}"
          - ""
          - "========================================================"
          - "        END OF DATA COLLECTION REPORT (Part 4/11)"
          - "========================================================"

    - name: Generate data collection report (Part 10/11 - Requirement 10)
      debug:
        msg:
          - "========================================================"
          - "        DATA COLLECTION REPORT (Part 10/11)"
          - "========================================================"
          - "Reference KCS Article: {{ kcs_article }}"
          - "Ansible-builder fails to build custom EE with error ‘Cannot find libsystemd or libsystemd-journal:’ when using image: registry.redhat.io/ansible-automation-platform-25/ee-supported-rhel8"
          - "========================================================"
          - ""
          - "REQUIREMENT 10 - {{ req_10 }}:"
          - "  Task: {{ task_10_name | default('Task not recorded') }}"
          - "  Command: {{ task_10_cmd | default('N/A') }}"
          - "  Exit code: {{ task_10_rc | default(-1) }}"
          - "  Data: {{ data_10 | default('Data collection failed') }}"
          - ""
          - "========================================================"
          - "        END OF DATA COLLECTION REPORT (Part 10/11)"
          - "========================================================"