---
- name: Data Collection for CIS 1.8.6
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v4.0.0 checkpoint 1.8.6"
    req_1: "Check if GNOME Desktop Manager (GDM) is installed using package manager. Rationale: PASS when GDM package (gdm or gdm3) is NOT installed (recommendation not applicable), FAIL when GDM is installed and further checks are required"
    req_2: |
      If GDM is installed, search for existing automount settings in dconf database files using command: `grep -Prils -- '^\h*automount\b' /etc/dconf/db/*.d`. Rationale: PASS when a configuration file path is found (l_kfile variable set), FAIL when no file is found (neither automount nor automount-open is set)
    req_3: |
      If GDM is installed, search for existing automount-open settings in dconf database files using command: `grep -Prils -- '^\h*automount-open\b' /etc/dconf/db/*.d`. Rationale: PASS when a configuration file path is found (l_kfile2 variable set), FAIL when no file is found (neither automount nor automount-open is set)
    req_4: "Determine the dconf profile name (l_gpname) from the found configuration file(s). Rationale: PASS when l_gpname is extracted (profile exists), FAIL when l_gpname is empty (profile does not exist)"
    req_5: |
      Check if a dconf database profile file exists and references the determined profile name using command: `grep -Pl -- '^\h*system-db:$l_gpname\b' /etc/dconf/profile/*`. Rationale: PASS when a matching profile file is found, FAIL when no matching profile file is found
    req_6: "Check if the dconf database file exists at `/etc/dconf/db/$l_gpname`. Rationale: PASS when the file exists, FAIL when the file does not exist"
    req_7: "Check if the dconf database directory exists at `/etc/dconf/db/$l_gpname.d`. Rationale: PASS when the directory exists, FAIL when the directory does not exist"
    req_8: |
      Verify the automount setting is set to false in the found configuration file using command: `grep -Pqrs -- '^\h*automount\h*=\h*false\b' '$l_kfile'`. Rationale: PASS when 'automount=false' is found, FAIL when it is not set or set to true
    req_9: |
      Verify the automount-open setting is set to false in the found configuration file using command: `grep -Pqs -- '^\h*automount-open\h*=\h*false\b' '$l_kfile2'`. Rationale: PASS when 'automount-open=false' is found, FAIL when it is not set or set to true
    req_10: "Run the following script. Rationale: PASS when script output contains '** PASS **' and l_output2 is empty (no failures), FAIL when script output contains '** FAIL **' and l_output2 contains failure reasons"
    req_11: "OVERALL Verify: Ensure GDM automatic mounting of removable media is disabled. Rationale: PASS when (req_1=PASS AND recommendation not applicable) OR (req_1=FAIL AND req_2=PASS AND req_3=PASS AND req_4=PASS AND req_5=PASS AND req_6=PASS AND req_7=PASS AND req_8=PASS AND req_9=PASS), FAIL otherwise"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        data_3: ""
        data_4: ""
        data_5: ""
        data_6: ""
        data_7: ""
        data_8: ""
        data_9: ""
        data_10: ""
        data_11: ""
        status_1: "UNKNOWN"
        status_2: "UNKNOWN"
        status_3: "UNKNOWN"
        status_4: "UNKNOWN"
        status_5: "UNKNOWN"
        status_6: "UNKNOWN"
        status_7: "UNKNOWN"
        status_8: "UNKNOWN"
        status_9: "UNKNOWN"
        status_10: "UNKNOWN"
        status_11: "UNKNOWN"
        rationale_1: "Not evaluated"
        rationale_2: "Not evaluated"
        rationale_3: "Not evaluated"
        rationale_4: "Not evaluated"
        rationale_5: "Not evaluated"
        rationale_6: "Not evaluated"
        rationale_7: "Not evaluated"
        rationale_8: "Not evaluated"
        rationale_9: "Not evaluated"
        rationale_10: "Not evaluated"
        rationale_11: "Not evaluated"
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1
        task_6_name: "Not executed"
        task_6_cmd: "N/A"
        task_6_rc: -1
        task_7_name: "Not executed"
        task_7_cmd: "N/A"
        task_7_rc: -1
        task_8_name: "Not executed"
        task_8_cmd: "N/A"
        task_8_rc: -1
        task_9_name: "Not executed"
        task_9_cmd: "N/A"
        task_9_rc: -1
        task_10_name: "Not executed"
        task_10_cmd: "N/A"
        task_10_rc: -1
        task_11_name: "Not executed"
        task_11_cmd: "N/A"
        task_11_rc: -1
        gdm_installed: false
        l_kfile: ""
        l_kfile2: ""
        l_gpname: ""

    # Requirement 10: Execute the complete CIS audit script (PRIMARY IMPLEMENTATION)
    - name: Req 10 - Execute CIS audit script for checkpoint 1.8.6
      copy:
        dest: "/tmp/cis_audit_1.8.6.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_pkgoutput="" l_output="" l_output2=""
             # Check if GNOME Desktop Manager is installed.  If package isn't installed, recommendation is Not Applicable\n
             # determine system's package manager
             if command -v dpkg-query > /dev/null 2>&1; then
                l_pq="dpkg-query -W"
             elif command -v rpm > /dev/null 2>&1; then
                l_pq="rpm -q"
             fi
             # Check if GDM is installed
             l_pcl="gdm gdm3" # Space separated list of packages to check
             for l_pn in $l_pcl; do
                $l_pq "$l_pn" > /dev/null 2>&1 && l_pkgoutput="$l_pkgoutput\n - Package: \"$l_pn\" exists on the system\n - checking configuration"
             done
             # Check configuration (If applicable)
             if [ -n "$l_pkgoutput" ]; then
                echo -e "$l_pkgoutput"
                # Look for existing settings and set variables if they exist
                l_kfile="$(grep -Prils -- '^\h*automount\b' /etc/dconf/db/*.d)"
                l_kfile2="$(grep -Prils -- '^\h*automount-open\b' /etc/dconf/db/*.d)"
                # Set profile name based on dconf db directory ({PROFILE_NAME}.d)
                if [ -f "$l_kfile" ]; then
                   l_gpname="$(awk -F\/ '{split($(NF-1),a,".");print a[1]}' <<< "$l_kfile")"
                elif [ -f "$l_kfile2" ]; then
                   l_gpname="$(awk -F\/ '{split($(NF-1),a,".");print a[1]}' <<< "$l_kfile2")"
                fi
                # If the profile name exist, continue checks
                if [ -n "$l_gpname" ]; then
                   l_gpdir="/etc/dconf/db/$l_gpname.d"
                   # Check if profile file exists
                   if grep -Pq -- "^\h*system-db:$l_gpname\b" /etc/dconf/profile/*; then
                      l_output="$l_output\n - dconf database profile file \"$(grep -Pl -- "^\h*system-db:$l_gpname\b" /etc/dconf/profile/*)\" exists"
                   else
                      l_output2="$l_output2\n - dconf database profile isn't set"
                   fi
                   # Check if the dconf database file exists
                   if [ -f "/etc/dconf/db/$l_gpname" ]; then
                      l_output="$l_output\n - The dconf database \"$l_gpname\" exists"
                   else
                      l_output2="$l_output2\n - The dconf database \"$l_gpname\" doesn't exist"
                   fi
                   # check if the dconf database directory exists
                   if [ -d "$l_gpdir" ]; then
                      l_output="$l_output\n - The dconf database directory \"$l_gpdir\" exists"
                   else
                      l_output2="$l_output2\n - The dconf database directory \"$l_gpname\" doesn't exist"
                   fi
                   # check automount setting
                   if grep -Pqrs -- '^\h*automount\h*=\h*false\b' "$l_kfile"; then
                      l_output="$l_output\n - \"automount\" is set to false in: \"$l_kfile\""
                   else
                      l_output2="$l_output2\n - \"automount\" is not set correctly"
                   fi
                   # check automount-open setting
                   if grep -Pqs -- '^\h*automount-open\h*=\h*false\b' "$l_kfile2"; then
                      l_output="$l_output\n - \"automount-open\" is set to false in: \"$l_kfile2\""
                   else
                      l_output2="$l_output2\n - \"automount-open\" is not set correctly"
                   fi
                else
                   # Settings don't exist. Nothing further to check
                   l_output2="$l_output2\n - neither \"automount\" or \"automount-open\" is set"
                fi
             else
                l_output="$l_output\n - GNOME Desktop Manager package is not installed on the system\n  - Recommendation is not applicable"
             fi
             # Report results. If no failures output in l_output2, we pass
             if [ -z "$l_output2" ]; then
                echo -e "\n- Audit Result:\n  ** PASS **\n$l_output\n"
             else
                echo -e "\n- Audit Result:\n  ** FAIL **\n - Reason(s) for audit failure:\n$l_output2\n"
                [ -n "$l_output" ] && echo -e "\n- Correctly set:\n$l_output\n"
             fi
          }
          {% endraw %}
      register: script_create_10
      ignore_errors: true

    - name: Req 10 - Execute the audit script
      shell: "/tmp/cis_audit_1.8.6.sh"
      args:
        executable: /bin/bash
      register: result_10
      ignore_errors: true
      changed_when: false

    - name: Req 10 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_1.8.6.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 10 details
      set_fact:
        task_10_name: "Execute CIS audit script for checkpoint 1.8.6"
        task_10_cmd: "Execute complete CIS audit procedure script"
        task_10_rc: "{{ result_10.rc | default(-1) }}"
        data_10: "{{ result_10.stdout | default('') | trim }}"
        status_10: >-
          {% set output = result_10.stdout | default('') | trim %}
          {% if '** PASS **' in output and '** FAIL **' not in output %}
            PASS
          {% elif '** FAIL **' in output %}
            FAIL
          {% else %}
            UNKNOWN
          {% endif %}
        rationale_10: >-
          {% set output = result_10.stdout | default('') | trim %}
          {% if '** PASS **' in output and '** FAIL **' not in output %}
            PASS when script output contains '** PASS **' and l_output2 is empty (no failures)
          {% elif '** FAIL **' in output %}
            FAIL when script output contains '** FAIL **' and l_output2 contains failure reasons
          {% else %}
            Cannot determine from script output
          {% endif %}

    # Requirement 1: Check if GNOME Desktop Manager (GDM) is installed (using exact logic from script)
    - name: Req 1 - Check if GDM is installed
      shell: |
        if command -v dpkg-query > /dev/null 2>&1; then
          l_pq="dpkg-query -W"
        elif command -v rpm > /dev/null 2>&1; then
          l_pq="rpm -q"
        fi
        l_pcl="gdm gdm3"
        l_pkgoutput=""
        for l_pn in $l_pcl; do
          $l_pq "$l_pn" > /dev/null 2>&1 && l_pkgoutput="$l_pkgoutput\n - Package: \"$l_pn\" exists on the system\n - checking configuration"
        done
        if [ -n "$l_pkgoutput" ]; then
          echo "GDM_INSTALLED"
          echo -e "$l_pkgoutput"
        else
          echo "GDM_NOT_INSTALLED"
        fi
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check if GDM is installed"
        task_1_cmd: "Check for gdm or gdm3 packages using system package manager (exact CIS logic)"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        gdm_installed: "{{ 'GDM_INSTALLED' in result_1.stdout }}"
        status_1: "{{ ('PASS' if 'GDM_NOT_INSTALLED' in result_1.stdout else 'FAIL') | trim }}"
        rationale_1: "{{ ('PASS when GDM package is NOT installed (recommendation not applicable)' if 'GDM_NOT_INSTALLED' in result_1.stdout else 'FAIL when GDM is installed and further checks are required') | trim }}"

    # Requirement 2: Search for automount settings (only if GDM is installed)
    - name: Req 2 - Search for automount settings
      shell: |
        grep -Prils -- '^\h*automount\b' /etc/dconf/db/*.d 2>/dev/null || echo "NO_FILE_FOUND"
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false
      when: gdm_installed

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Search for automount settings in dconf database"
        task_2_cmd: |
          grep -Prils -- '^\h*automount\b' /etc/dconf/db/*.d
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        l_kfile: "{{ result_2.stdout | default('') | trim if result_2.stdout | default('') | trim != 'NO_FILE_FOUND' else '' }}"
        status_2: >-
          {% if not gdm_installed %}
            NA
          {% else %}
            {% set output = result_2.stdout | default('') | trim %}
            {% if output != 'NO_FILE_FOUND' and output != '' %}
              PASS
            {% else %}
              FAIL
            {% endif %}
          {% endif %}
        rationale_2: >-
          {% if not gdm_installed %}
            Not applicable - GDM not installed
          {% else %}
            {% set output = result_2.stdout | default('') | trim %}
            {% if output != 'NO_FILE_FOUND' and output != '' %}
              PASS when a configuration file path is found (l_kfile variable set)
            {% else %}
              FAIL when no file is found (neither automount nor automount-open is set)
            {% endif %}
          {% endif %}

    # Requirement 3: Search for automount-open settings (only if GDM is installed)
    - name: Req 3 - Search for automount-open settings
      shell: |
        grep -Prils -- '^\h*automount-open\b' /etc/dconf/db/*.d 2>/dev/null || echo "NO_FILE_FOUND"
      args:
        executable: /bin/bash
      register