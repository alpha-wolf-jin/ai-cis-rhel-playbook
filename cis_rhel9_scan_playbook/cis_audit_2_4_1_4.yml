---
- name: Data Collection for CIS checkpoint 2.4.1.4
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 2.4.1.4"
    req_1: "Check if cron is installed on the system"
    req_2: "Verify permissions, ownership, and group of /etc/cron.daily/"
    req_3: "OVERALL Verify: Ensure permissions on /etc/cron.daily are configured"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1

    # Requirement 1: Check if cron is installed on the system
    - name: Req 1 - Check cronie package installation
      shell: !unsafe |
        rpm -q cronie
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check cronie package installation"
        task_1_cmd: "rpm -q cronie"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim is not search('is not installed')) else 'FAIL') | trim }}"
        rationale_1: "{{ ('PASS when cronie package is installed (output shows package name and version), FAIL when package is not installed (output is package cronie is not installed)' if (result_1.stdout | default('') | trim is not search('is not installed')) else 'FAIL when package is not installed (output is package cronie is not installed), PASS when cronie package is installed (output shows package name and version)') | trim }}"

    # Requirement 2: Verify permissions, ownership, and group of /etc/cron.daily/
    - name: Req 2 - Verify /etc/cron.daily permissions
      shell: !unsafe |
        stat -Lc 'Access: (%a/%A) Uid: ( %u/ %U) Gid: ( %g/ %G)' /etc/cron.daily/
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Verify /etc/cron.daily permissions"
        task_2_cmd: "stat -Lc 'Access: (%a/%A) Uid: ( %u/ %U) Gid: ( %g/ %G)' /etc/cron.daily/"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% if output is search('Access: \(700/drwx------\) Uid: \( 0/ root\) Gid: \( 0/ root\)') %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_2: |
          {{ ('PASS when Access is (700/drwx------) AND Uid is ( 0/ root) AND Gid is ( 0/ root), FAIL otherwise' if (result_2.stdout | default('') | trim is search('Access: \(700/drwx------\) Uid: \( 0/ root\) Gid: \( 0/ root\)')) else 'FAIL otherwise, PASS when Access is (700/drwx------) AND Uid is ( 0/ root) AND Gid is ( 0/ root)') | trim }}

    # Requirement 3: OVERALL Verify: Ensure permissions on /etc/cron.daily are configured
    - name: Store requirement 3 details
      set_fact:
        task_3_name: "OVERALL Verify: Ensure permissions on /etc/cron.daily are configured"
        task_3_cmd: "N/A (calculated from req_1 and req_2)"
        task_3_rc: 0
        data_3: "N/A"
        status_3: >-
          {% if status_1 | default('FAIL') | trim == 'FAIL' %}
            PASS
          {% elif status_1 | default('FAIL') | trim == 'PASS' and status_2 | default('FAIL') | trim == 'PASS' %}
            PASS
          {% elif status_1 | default('FAIL') | trim == 'PASS' and status_2 | default('FAIL') | trim == 'FAIL' %}
            FAIL
          {% else %}
            UNKNOWN
          {% endif %}
        rationale_3: >-
          {% if status_1 | default('FAIL') | trim == 'FAIL' %}
            PASS when (req_1=FAIL) OR (req_1=PASS AND req_2=PASS)
          {% elif status_1 | default('FAIL') | trim == 'PASS' and status_2 | default('FAIL') | trim == 'PASS' %}
            PASS when (req_1=FAIL) OR (req_1=PASS AND req_2=PASS)
          {% elif status_1 | default('FAIL') | trim == 'PASS' and status_2 | default('FAIL') | trim == 'FAIL' %}
            FAIL when req_1=PASS AND req_2=FAIL
          {% else %}
            Cannot determine overall compliance
          {% endif %}

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 2.4.1.4"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 2.4.1.4"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - "========================================================"