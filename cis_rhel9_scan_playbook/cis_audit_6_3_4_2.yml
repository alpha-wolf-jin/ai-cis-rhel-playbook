---
- name: Data Collection for CIS 6.3.4.2
  hosts: all
  become: yes
  gather_facts: false
  vars:
    cis_reference: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 6.3.4.2"
    req_1: "Check if /etc/audit/auditd.conf exists using command: `[ -f /etc/audit/auditd.conf ] && echo 'File exists' || echo 'File not found'`. Rationale: PASS when file exists, FAIL when file does not exist (auditd may not be installed)."
    req_2: |
      Extract the audit log directory path from /etc/audit/auditd.conf using command: `awk -F= '/^\s*log_file\s*/{print $2}' /etc/audit/auditd.conf | xargs | xargs dirname`. Rationale: PASS when a valid directory path is extracted, FAIL when the path is empty or invalid.
    req_3: |
      Verify the extracted audit log directory exists using command: `[ -d \"$l_audit_log_directory\" ] && echo 'Directory exists' || echo 'Directory not found'`. Rationale: PASS when the directory exists, FAIL when it does not.
    req_4: "Run the provided script to check audit log files permissions. Rationale: PASS when script output contains '** PASS **' and no files with permissions more permissive than 0640 (i.e., no files with world read, group write, or any execute permissions) are found in the audit log directory, FAIL when script output contains '** FAIL **' or lists non-compliant files."
    req_5: "OVERALL Verify: Ensure audit log files mode is configured. Rationale: PASS when req_1=PASS AND req_2=PASS AND req_3=PASS AND req_4=PASS, FAIL otherwise."

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1

    # Requirement 1: Check if /etc/audit/auditd.conf exists
    - name: "Req 1 - Check auditd.conf file existence"
      shell: |
        [ -f /etc/audit/auditd.conf ] && echo 'File exists' || echo 'File not found'
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check auditd.conf file existence"
        task_1_cmd: "[ -f /etc/audit/auditd.conf ] && echo 'File exists' || echo 'File not found'"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim == 'File exists') else 'FAIL') | trim }}"
        rationale_1: "{{ ('PASS when file exists, FAIL when file does not exist' if (result_1.stdout | default('') | trim == 'File exists') else 'FAIL: auditd.conf file not found, auditd may not be installed') | trim }}"

    # Requirement 2: Extract audit log directory path
    - name: "Req 2 - Extract audit log directory path"
      shell: |
        awk -F= '/^\s*log_file\s*/{print $2}' /etc/audit/auditd.conf | xargs | xargs dirname
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false
      when: status_1 == 'PASS'

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Extract audit log directory path"
        task_2_cmd: |
          awk -F= '/^\s*log_file\s*/{print $2}' /etc/audit/auditd.conf | xargs | xargs dirname
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: "{{ ('PASS' if (result_2.stdout | default('') | trim != '' and result_2.stdout | default('') | trim != '.' and result_2.rc == 0) else 'FAIL') | trim }}"
        rationale_2: "{{ ('PASS when a valid directory path is extracted' if (result_2.stdout | default('') | trim != '' and result_2.stdout | default('') | trim != '.' and result_2.rc == 0) else 'FAIL: path is empty or invalid') | trim }}"
        l_audit_log_directory: "{{ result_2.stdout | default('') | trim }}"

    # Requirement 3: Verify extracted directory exists
    - name: "Req 3 - Verify audit log directory exists"
      shell: |
        [ -d "{{ l_audit_log_directory }}" ] && echo 'Directory exists' || echo 'Directory not found'
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      changed_when: false
      when: status_2 == 'PASS'

    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Verify audit log directory exists"
        task_3_cmd: |
          [ -d \"{{ l_audit_log_directory }}\" ] && echo 'Directory exists' || echo 'Directory not found'
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: "{{ ('PASS' if (result_3.stdout | default('') | trim == 'Directory exists') else 'FAIL') | trim }}"
        rationale_3: "{{ ('PASS when the directory exists' if (result_3.stdout | default('') | trim == 'Directory exists') else 'FAIL: directory not found') | trim }}"

    # Requirement 4: Run the CIS audit script
    - name: "Req 4 - Execute CIS audit script"
      copy:
        dest: "/tmp/cis_audit_6.3.4.2.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_output="" l_output2=""
             l_perm_mask="0177"
             if [ -e "/etc/audit/auditd.conf" ]; then
                l_audit_log_directory="$(dirname "$(awk -F= '/^\s*log_file\s*/{print 
          $2}' /etc/audit/auditd.conf | xargs)")"
                if [ -d "$l_audit_log_directory" ]; then
                   l_maxperm="$(printf '%o' $(( 0777 & ~$l_perm_mask )) )"
                   while IFS= read -r -d $'\0' l_file; do
                      while IFS=: read -r l_file_mode l_hr_file_mode; do
                         l_output2="$l_output2\n  - File: \"$l_file\" is mode: 
          \"$l_file_mode\"\n     (should be mode: \"$l_maxperm\" or more 
          restrictive)"
                      done <<< "$(stat -Lc '%#a:%A' "$l_file")"
                   done < <(find "$l_audit_log_directory" -maxdepth 1 -type f -perm 
          /"$l_perm_mask" -print0)
                else
                   l_output2="$l_output2\n  - Log file directory not set in 
          \"/etc/audit/auditd.conf\" please set log file directory"
                fi
             else
                l_output2="$l_output2\n  - File: \"/etc/audit/auditd.conf\" not 
          found.\n  - ** Verify auditd is installed **"
             fi
             if [ -z "$l_output2" ]; then
                l_output="$l_output\n  - All files in \"$l_audit_log_directory\" are 
          mode: \"$l_maxperm\" or more restrictive"
                echo -e "\n- Audit Result:\n  ** PASS **\n - * Correctly configured * 
          :$l_output"
             else
                echo -e "\n- Audit Result:\n  ** FAIL **\n - * Reasons for audit 
          failure * :$l_output2\n"
             fi
          }
          {% endraw %}
      register: script_create_4
      ignore_errors: true

    - name: "Req 4 - Run the audit script"
      shell: "/tmp/cis_audit_6.3.4.2.sh"
      args:
        executable: /bin/bash
      register: result_4
      ignore_errors: true
      changed_when: false

    - name: "Req 4 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_6.3.4.2.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Execute CIS audit script"
        task_4_cmd: "Execute the provided CIS audit script"
        task_4_rc: "{{ result_4.rc | default(-1) }}"
        data_4: "{{ result_4.stdout | default('') | trim }}"
        status_4: |
          {{ ('PASS' if (result_4.stdout | default('') is search('\\*\\* PASS \\*\\*')) else 'FAIL') | trim }}
        rationale_4: |
          {{ ('PASS when script output contains ** PASS ** and no files with permissions more permissive than 0640 are found' if (result_4.stdout | default('') is search('\\*\\* PASS \\*\\*')) else 'FAIL: script output contains ** FAIL ** or lists non-compliant files') | trim }}

    # Requirement 5: Overall verification
    - name: Store requirement 5 details
      set_fact:
        task_5_name: "Overall verification"
        task_5_cmd: "Check all requirements"
        task_5_rc: 0
        data_5: "Requirement statuses: 1={{ status_1 }}, 2={{ status_2 }}, 3={{ status_3 }}, 4={{ status_4 }}"
        status_5: "{{ ('PASS' if (status_1 == 'PASS' and status_2 == 'PASS' and status_3 == 'PASS' and status_4 == 'PASS') else 'FAIL') | trim }}"
        rationale_5: "{{ ('PASS when all requirements are PASS' if (status_1 == 'PASS' and status_2 == 'PASS' and status_3 == 'PASS' and status_4 == 'PASS') else 'FAIL: one or more requirements failed') | trim }}"

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 6.3.4.2"
          - "========================================================"
          - "Reference: {{ cis_reference }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Task: {{ task_4_name | default('Task not recorded') }}"
          - "  Command: {{ task_4_cmd | default('N/A') }}"
          - "  Exit code: {{ task_4_rc | default(-1) }}"
          - "  Data: {{ data_4 | default('') | trim }}"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 5 - {{ req_5 }}:"
          - "  Task: {{ task_5_name | default('Task not recorded') }}"
          - "  Command: {{ task_5_cmd | default('N/A') }}"
          - "  Exit code: {{ task_5_rc | default(-1) }}"
          - "  Data: {{ data_5 | default('') | trim }}"
          - "  Status: {{ status_5 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_5 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_5 | trim }}"
          - "  Rationale: {{ rationale_5 | trim }}"
          - "========================================================"