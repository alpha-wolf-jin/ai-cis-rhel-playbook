---
- name: Data Collection for CIS 5.1.13
  hosts: all
  become: yes
  gather_facts: false
  vars:
    cis_reference: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.13"
    req_1: "Verify sshd IgnoreRhosts global setting using command: `sshd -T | grep ignorerhosts`. Rationale: PASS when output is exactly 'ignorerhosts yes', FAIL otherwise"
    req_2: "If Match blocks are used in the sshd configuration, for each relevant Match block, verify the IgnoreRhosts setting using command: `sshd -T -C user=<user> -C addr=<addr> -C host=<host> -C laddr=<laddr> -C lport=<lport> -C rdomain=<rdomain> | grep ignorerhosts` (substituting the appropriate connection parameters for the specific Match block). Rationale: PASS when output is exactly 'ignorerhosts yes' for all tested Match blocks, FAIL if any tested block returns a different value or no value."
    req_overall: "Ensure sshd IgnoreRhosts is enabled. Rationale: PASS when req_1=PASS AND (if Match blocks are used, req_2=PASS), FAIL otherwise"
    # User-defined connection parameters for testing Match blocks
    # Example: 
    # sshd_match_connection_params:
    #   - "-C user=root"
    #   - "-C user=sshusera -C addr=192.168.1.1"
    sshd_match_connection_params: []

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Global setting
    - name: Req 1 - Check global IgnoreRhosts setting
      shell: |
        sshd -T | grep ignorerhosts
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check global IgnoreRhosts setting"
        task_1_cmd: "sshd -T | grep ignorerhosts"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% set output = result_1.stdout | default('') | trim %}
          {% if output == 'ignorerhosts yes' %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_1: >-
          {% set output = result_1.stdout | default('') | trim %}
          {% if output == 'ignorerhosts yes' %}
            PASS when output is exactly ignorerhosts yes, FAIL otherwise
          {% else %}
            FAIL: Expected ignorerhosts yes, got {{ output }}
          {% endif %}

    # Requirement 2: Test Match blocks with user-specified connection parameters
    - name: Req 2 - Test Match blocks with user-specified connection parameters
      shell: |
        # Initialize variables
        all_pass=true
        output=""
        
        # Test each set of connection parameters
        {% for opts in sshd_match_connection_params %}
        result=$(sshd -T {{ opts }} 2>/dev/null | grep ignorerhosts)
        if [ "$result" = "ignorerhosts yes" ]; then
          output="$output\nTest with options {{ opts }}: PASS"
        else
          output="$output\nTest with options {{ opts }}: FAIL (got: '$result')"
          all_pass=false
        fi
        {% endfor %}
        
        # Output results
        if [ "$all_pass" = true ]; then
          echo -e "All tests passed:$output"
          exit 0
        else
          echo -e "Some tests failed:$output"
          exit 1
        fi
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false
      when: sshd_match_connection_params | default([]) | length > 0

    - name: Store requirement 2 details when Match blocks are tested
      set_fact:
        task_2_name: "Test IgnoreRhosts in Match blocks with user-specified connection parameters"
        task_2_cmd: "sshd -T with connection parameters: {{ sshd_match_connection_params | default([]) | join(', ') }}"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% if output == '' %}
            NA
          {% elif result_2.rc | default(1) == 0 %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% set rc = result_2.rc | default(-1) %}
          {% if output == '' %}
            NA: No connection parameters specified for testing Match blocks
          {% elif rc == 0 %}
            PASS: All tested Match blocks have IgnoreRhosts enabled
          {% else %}
            FAIL: One or more tested Match blocks do not have IgnoreRhosts enabled
          {% endif %}
      when: sshd_match_connection_params | default([]) | length > 0

    - name: Set default requirement 2 details if no Match blocks to test
      set_fact:
        task_2_name: "Match blocks test - skipped"
        task_2_cmd: "N/A - No connection parameters specified for testing Match blocks"
        task_2_rc: 0
        data_2: "No connection parameters specified for testing Match blocks"
        status_2: "NA"
        rationale_2: "NA: No connection parameters specified for testing Match blocks"
      when: sshd_match_connection_params | default([]) | length == 0

    # Determine overall compliance
    - name: Set overall compliance status
      set_fact:
        status_overall: >-
          {% if status_1 | default('UNKNOWN') | trim == 'PASS' %}
            {% if status_2 | default('NA') | trim in ['PASS', 'NA'] %}
              PASS
            {% else %}
              FAIL
            {% endif %}
          {% else %}
            FAIL
          {% endif %}
        rationale_overall: >-
          {% if status_1 | default('UNKNOWN') | trim == 'PASS' %}
            {% if status_2 | default('NA') | trim in ['PASS', 'NA'] %}
              PASS: Global setting is enabled and (if Match blocks are tested, they are also enabled, or no Match blocks are tested)
            {% else %}
              FAIL: Global setting is enabled but one or more tested Match blocks are not properly configured
            {% endif %}
          {% else %}
            FAIL: Global setting is not enabled
          {% endif %}

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 5.1.13"
          - "========================================================"
          - "Reference: {{ cis_reference }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') | trim }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Status: {{ status_overall | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_overall | default('Not evaluated') | trim }}"
          - "========================================================"