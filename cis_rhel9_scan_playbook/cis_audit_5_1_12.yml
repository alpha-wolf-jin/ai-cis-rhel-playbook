---
- name: Data Collection for CIS 5.1.12
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.12"
    req_1: "Verify sshd HostbasedAuthentication global setting using command: `sshd -T | grep hostbasedauthentication`. Rationale: PASS when output is exactly 'hostbasedauthentication no', FAIL otherwise"
    req_2: "If Match blocks are used in the sshd configuration, verify HostbasedAuthentication for each relevant Match block using connection parameters. Example for user 'sshuser': `sshd -T -C user=sshuser | grep hostbasedauthentication`. Rationale: PASS when for all applicable Match blocks the output is exactly 'hostbasedauthentication no', FAIL if any applicable Match block output is not 'hostbasedauthentication no'"
    req_3: "OVERALL Verify: Ensure sshd HostbasedAuthentication is disabled. Rationale: PASS when req_1=PASS AND (Match blocks are not used OR req_2=PASS), FAIL otherwise"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Global setting
    - name: Req 1 - Check global HostbasedAuthentication setting
      shell: |
        sshd -T | grep hostbasedauthentication
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check global HostbasedAuthentication setting"
        task_1_cmd: "sshd -T | grep hostbasedauthentication"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim == 'hostbasedauthentication no') else 'FAIL') | trim }}"
        rationale_1: "{{ ('PASS when output is exactly hostbasedauthentication no, FAIL otherwise') | trim }}"

    # Requirement 2: Check for Match blocks and test all conditions
    - name: Req 2 - Parse Match blocks and test HostbasedAuthentication
      shell: |
        # Ansible processes this first outside raw block
        config_file=/etc/ssh/sshd_config
        match_blocks_found=false
        match_conditions_list=""
        
        # Check if we have match blocks to test
        if grep -q "^Match" "$config_file"; then
          match_blocks_found=true
        fi
        
        {% raw %}
        if [ "$match_blocks_found" = "false" ]; then
          echo "No Match blocks found"
          exit 0
        fi
        
        # Extract all Match block conditions from sshd_config
        # We will parse each Match line and extract condition parameters
        # Example: Match User root Host 192.168.1.1 -> conditions: User=root Host=192.168.1.1
        # Example: Match User john Group admin -> conditions: User=john Group=admin
        
        # First, get all Match lines
        match_lines=$(grep -n "^Match" "$config_file" | sed 's/^\([0-9]*\):Match \(.*\)$/\1:\2/')
        
        # Initialize result tracking
        all_compliant=true
        output_lines=""
        
        # Process each Match block
        while IFS= read -r match_line; do
          line_num="${match_line%%:*}"
          conditions="${match_line#*:}"
          
          # Clean up conditions - remove extra spaces
          conditions=$(echo "$conditions" | sed 's/^ *//;s/ *$//')
          
          # Initialize connection parameters for this Match block
          c_params=""
          
          # Split conditions into tokens (key1 value1 key2 value2 ...)
          # Use set to parse tokens
          set -- $conditions
          
          # Process token pairs
          while [ $# -gt 0 ]; do
            key="$1"
            value="$2"
            shift 2
            
            # Convert condition key to lowercase for sshd -C parameter
            # Known sshd condition types: User, Group, Host, LocalAddress, LocalPort, Address, RDomain
            case "$key" in
              User)
                param_key="user"
                ;;
              Group)
                param_key="group"
                ;;
              Host)
                param_key="host"
                ;;
              LocalAddress)
                param_key="laddr"
                ;;
              LocalPort)
                param_key="lport"
                ;;
              Address)
                param_key="addr"
                ;;
              RDomain)
                param_key="rdomain"
                ;;
              *)
                # Skip unknown condition types
                continue
                ;;
            esac
            
            # Add -C parameter
            if [ -n "$c_params" ]; then
              c_params="$c_params -C $param_key=$value"
            else
              c_params="-C $param_key=$value"
            fi
          done
          
          # If we have connection parameters, test this Match block
          if [ -n "$c_params" ]; then
            # Test with all collected connection parameters for this Match block
            match_output=$(sshd -T $c_params 2>/dev/null | grep hostbasedauthentication || true)
            
            # Record the test
            output_lines="${output_lines}Match block at line $line_num with params: $c_params"$'\n'
            output_lines="${output_lines}  Output: $match_output"$'\n'
            
            # Check if this block is compliant
            if [ "$match_output" != "hostbasedauthentication no" ]; then
              all_compliant=false
              output_lines="${output_lines}  Status: NON-COMPLIANT"$'\n'
            else
              output_lines="${output_lines}  Status: COMPLIANT"$'\n'
            fi
          fi
        done << EOF
        $match_lines
        EOF
        
        # Output final results
        if [ "$all_compliant" = "true" ]; then
          echo "All Match blocks are compliant:"
          echo "$output_lines"
          echo "hostbasedauthentication no"
        else
          echo "Some Match blocks are non-compliant:"
          echo "$output_lines"
          exit 1
        fi
        {% endraw %}
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Check HostbasedAuthentication for all Match blocks"
        task_2_cmd: "Parse sshd_config for Match blocks and test each with appropriate connection parameters"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% if output == 'No Match blocks found' %}
            NA
          {% elif 'All Match blocks are compliant' in output and 'hostbasedauthentication no' in output %}
            PASS
          {% elif result_2.rc == 0 %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% if output == 'No Match blocks found' %}
            No Match blocks found, requirement not applicable
          {% elif 'All Match blocks are compliant' in output and 'hostbasedauthentication no' in output %}
            PASS when for all tested Match blocks output is exactly hostbasedauthentication no
          {% elif 'Some Match blocks are non-compliant' in output %}
            FAIL if any applicable Match block output is not hostbasedauthentication no
          {% else %}
            FAIL if any applicable Match block output is not hostbasedauthentication no
          {% endif %}

    # Requirement 3: Overall compliance
    - name: Set overall compliance
      set_fact:
        status_3: >-
          {% set s1 = status_1 | default('UNKNOWN') | trim %}
          {% set s2 = status_2 | default('UNKNOWN') | trim %}
          {% if s1 == 'PASS' and (s2 == 'PASS' or s2 == 'NA') %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_3: >-
          {% set s1 = status_1 | default('UNKNOWN') | trim %}
          {% set s2 = status_2 | default('UNKNOWN') | trim %}
          PASS when req_1=PASS AND (Match blocks are not used OR req_2=PASS), FAIL otherwise

    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 5.1.12"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.1.12"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name }}"
          - "  Command: {{ task_1_cmd }}"
          - "  Exit code: {{ task_1_rc }}"
          - "  Data: {{ data_1 }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name }}"
          - "  Command: {{ task_2_cmd }}"
          - "  Exit code: {{ task_2_rc }}"
          - "  Data: {{ data_2 }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_3 | trim }}"
          - "  Rationale: {{ rationale_3 | trim }}"
          - "========================================================"