---
- name: Data Collection for CIS 1.7.2 - Local Login Warning Banner
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.7.2"
    req_1: "Check the contents of the local login warning banner file using command: `cat /etc/issue`. Rationale: PASS when the contents match the organization's site policy (e.g., contain a legal warning, organization name, and monitoring policy notice, and do NOT contain OS or patch level information), FAIL otherwise."
    req_2: |
      Verify the local login warning banner does not contain prohibited information using command: `grep -E -i \"(\\\\v|\\\\r|\\\\m|\\\\s|\\\$(grep '^ID=' /etc/os-release | cut -d= -f2 | sed -e 's/\"//g'))\" /etc/issue`. Rationale: PASS when the command returns no output (exit code 1), indicating the banner does NOT contain escape sequences (\v, \r, \m, \s) or the OS distribution name, FAIL when any output is returned (exit code 0).
    req_3: "OVERALL Verify: Ensure local login warning banner is configured properly. Rationale: PASS when req_1=PASS AND req_2=PASS, FAIL otherwise."

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    - name: Req 1 - Check /etc/issue contents
      shell: |
        cat /etc/issue
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check /etc/issue contents"
        task_1_cmd: "cat /etc/issue"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"

    - name: Set requirement 1 status and rationale
      set_fact:
        status_1: >-
          {% set banner_content = result_1.stdout | default('') | trim %}
          {% if banner_content != '' %}
            {% set banner_lower = banner_content | lower %}
            {% if 'linux' in banner_lower or 'red hat' in banner_lower or 'centos' in banner_lower or
                  'fedora' in banner_lower or 'ubuntu' in banner_lower or 'debian' in banner_lower or
                  'suse' in banner_lower or 'kernel' in banner_lower or 'release' in banner_lower or
                  'patch' in banner_lower or 'update' in banner_lower or 'security' in banner_lower or
                  banner_lower | regex_search('\\d+\\.\\d+') %}
              FAIL
            {% else %}
              PASS
            {% endif %}
          {% else %}
            FAIL
          {% endif %}
        rationale_1: >-
          {% set banner_content = result_1.stdout | default('') | trim %}
          {% if banner_content != '' %}
            {% set banner_lower = banner_content | lower %}
            {% if 'linux' in banner_lower or 'red hat' in banner_lower or 'centos' in banner_lower or
                  'fedora' in banner_lower or 'ubuntu' in banner_lower or 'debian' in banner_lower or
                  'suse' in banner_lower or 'kernel' in banner_lower or 'release' in banner_lower or
                  'patch' in banner_lower or 'update' in banner_lower or 'security' in banner_lower or
                  banner_lower | regex_search('\\d+\\.\\d+') %}
              FAIL: Banner contains OS/patch information
            {% else %}
              PASS: Banner exists and does not contain obvious OS/patch information (manual review required for site policy compliance)
            {% endif %}
          {% else %}
            FAIL: Banner empty or file does not exist
          {% endif %}

    - name: Req 2 - Create script to check for prohibited content
      copy:
        dest: "/tmp/cis_1.7.2_req2.sh"
        mode: '0700'
        content: |
          #!/usr/bin/env bash
          grep -E -i "(\\\\v|\\\\r|\\\\m|\\\\s|\$(grep '^ID=' /etc/os-release | cut -d= -f2 | sed -e 's/\"//g'))" /etc/issue
      register: script_create_2
      ignore_errors: true

    - name: Req 2 - Execute script to check for prohibited content
      shell: "/tmp/cis_1.7.2_req2.sh"
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false

    - name: Req 2 - Remove temporary script
      file:
        path: "/tmp/cis_1.7.2_req2.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Check for prohibited content in /etc/issue"
        task_2_cmd: |
          grep -E -i \"(\\\\v|\\\\r|\\\\m|\\\\s|\\\$(grep '^ID=' /etc/os-release | cut -d= -f2 | sed -e 's/\"//g'))\" /etc/issue
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"

    - name: Set requirement 2 status and rationale
      set_fact:
        status_2: "{{ ('PASS' if (result_2.rc == 1 and result_2.stdout | default('') | trim == '') else 'FAIL') | trim }}"
        rationale_2: '{{ ("PASS: No prohibited content (escape sequences or OS distribution name) found" if (result_2.rc == 1 and result_2.stdout | default("") | trim == "") else "FAIL: Prohibited content found or command failed") | trim }}'

    - name: Store overall compliance details
      set_fact:
        status_3: "{{ ('PASS' if (status_1 == 'PASS' and status_2 == 'PASS') else 'FAIL') | trim }}"
        rationale_3: '{{ ("PASS: Both requirements met - banner exists without OS/patch info and contains no prohibited content" if (status_1 == "PASS" and status_2 == "PASS") else "FAIL: One or both requirements failed") | trim }}'

    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.7.2"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.7.2"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - "========================================================"