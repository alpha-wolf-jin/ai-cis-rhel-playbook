---
- name: Data Collection for CIS 4.3.4
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    cis_reference: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 4.3.4"
    req_1: "Check if FirewallD is enabled using command: systemctl is-enabled firewalld.service 2>/dev/null. Rationale: PASS when command output is NOT 'enabled' (or service is not found), FAIL when output is 'enabled' (as this makes the checkpoint Not Applicable)."
    req_2: "Check if nftables is enabled using command: systemctl is-enabled nftables.service. Rationale: PASS when command output is 'enabled', FAIL when output is not 'enabled' (and FirewallD is also not enabled per req_1)."
    req_3: "Run the following script to audit nftables loopback configuration. Rationale: PASS when script output contains '*** PASS ***' and no '*** FAIL ***' lines, FAIL when script output contains '*** FAIL ***' or indicates FirewallD is in use (making it NA) or indicates neither firewall is enabled."
    req_4: "OVERALL Verify: Ensure nftables loopback traffic is configured. Rationale: PASS when req_1=PASS (FirewallD not enabled) AND req_2=PASS (nftables is enabled) AND req_3=PASS (loopback rules are correctly configured), FAIL otherwise."
    req_5: "Add comment referencing CIS RHEL 9 Benchmark v2.0.0, checkpoint 4.3.4"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1

    # Requirement 1: Check if FirewallD is enabled
    - name: Req 1 - Check FirewallD status
      command: systemctl is-enabled firewalld.service 2>/dev/null
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check FirewallD status"
        task_1_cmd: "systemctl is-enabled firewalld.service 2>/dev/null"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% if result_1.stdout is defined and 'enabled' in result_1.stdout %}
            FAIL
          {% else %}
            PASS
          {% endif %}
        rationale_1: >-
          {% if result_1.stdout is defined and 'enabled' in result_1.stdout %}
            FAIL - FirewallD is enabled (makes checkpoint NA)
          {% else %}
            PASS - FirewallD not enabled or not found
          {% endif %}

    # Requirement 2: Check if nftables is enabled - FIXED: Correct conditional execution
    - name: Req 2 - Check nftables status
      command: systemctl is-enabled nftables.service
      register: result_2
      ignore_errors: true
      changed_when: false
      when: "'enabled' not in data_1"  # FIXED: Check if FirewallD is NOT enabled

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Check nftables status"
        task_2_cmd: "systemctl is-enabled nftables.service"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% if result_2.stdout is defined and 'enabled' in result_2.stdout %}
            PASS
          {% else %}
            FAIL
          {% endif %}
        rationale_2: >-
          {% if result_2.stdout is defined and 'enabled' in result_2.stdout %}
            PASS - nftables is enabled
          {% else %}
            FAIL - nftables is not enabled
          {% endif %}

    # Requirement 3: Execute CIS audit script for nftables loopback configuration
    - name: Req 3 - Create CIS audit script
      copy:
        dest: "/tmp/cis_audit_4.3.4.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_output="" l_output2="" l_hbfw=""
             if systemctl is-enabled firewalld.service 2>/dev/null | grep -q 'enabled'; then
                echo -e "\n - FirewallD is in use on the system\n - Recommendation is NA" && l_hbfw="fwd"
             elif systemctl is-enabled nftables.service | grep -q 'enabled'; then
                l_hbfw="nft"
             else
                echo -e "\n - Error - Neither FirewallD or NFTables is enabled\n - Please follow recommendation: \"Ensure a single firewall configuration utility is in use\""
                l_output2="*** FAIL *** Please follow recommendation: Ensure a single firewall configuration utility is in use"
             fi
             if [ "$l_hbfw" = "nft" ]; then
                if nft list ruleset | awk '/hook\s+input\s+/,/\}\s*(#.*)?$/' | grep -Pq -- '\H+\h+"lo"\h+accept'; then
                   l_output="$l_output\n - Network traffic to the loopback address is correctly set to accept"
                else
                   l_output2="$l_output2\n - Network traffic to the loopback address is not set to accept"
                fi
                l_ipsaddr="$(nft list ruleset | awk '/filter_IN_public_deny|hook\s+input\s+/,/\}\s*(#.*)?$/' | grep -P -- 'ip\h+saddr')"
                if grep -Pq -- 'ip\h+saddr\h+127\.0\.0\.0\/8\h+(counter\h+packets\h+\d+\h+bytes\h+\d+\h+)?drop' <<< "$l_ipsaddr" || grep -Pq -- 'ip\h+daddr\h+\!\=\h+127\.0\.0\.1\h+ip\h+saddr\h+127\.0\.0\.1\h+drop' <<< "$l_ipsaddr"; then
                   l_output="$l_output\n - IPv4 network traffic from loopback address correctly set to drop"
                else
                   l_output2="$l_output2\n - IPv4 network traffic from loopback address not set to drop"
                fi
                if grep -Pq -- '^\h*0\h*$' /sys/module/ipv6/parameters/disable; then
                   l_ip6saddr="$(nft list ruleset | awk '/filter_IN_public_deny|hook input/,/}/' | grep 'ip6 saddr')"
                   if grep -Pq 'ip6\h+saddr\h+::1\h+(counter\h+packets\h+\d+\h+bytes\h+\d+\h+)?drop' <<< "$l_ip6saddr" || grep -Pq -- 'ip6\h+daddr\h+\!\=\h+::1\h+ip6\h+saddr\h+::1\h+drop' <<< "$l_ip6saddr"; then
                      l_output="$l_output\n - IPv6 network traffic from loopback address correctly set to drop"
                   else
                      l_output2="$l_output2\n - IPv6 network traffic from loopback address not set to drop"
                   fi
                fi
             fi
             if [ "$l_hbfw" = "nft" ] || [ -z "$l_output2" ]; then
                echo -e "\n- Audit Result:\n  *** PASS ***\n$l_output"
             else
                echo -e "\n- Audit Result:\n  *** FAIL ***\n$l_output2\n\n  - Correctly set:\n$l_output"
             fi
          }
          {% endraw %}
      register: script_create_3
      ignore_errors: true
      when: "'enabled' not in data_1"  # FIXED: Only create script if FirewallD not enabled

    - name: Req 3 - Execute the audit script
      shell: "/tmp/cis_audit_4.3.4.sh"
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      changed_when: false
      when: "'enabled' not in data_1"  # FIXED: Only execute script if FirewallD not enabled

    - name: Req 3 - Remove temporary audit script
      file:
        path: "/tmp/cis_audit_4.3.4.sh"
        state: absent
      ignore_errors: true
      when: "'enabled' not in data_1"  # FIXED: Only remove if script was created

    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Execute CIS audit script for nftables loopback configuration"
        task_3_cmd: "/tmp/cis_audit_4.3.4.sh"
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: >-
          {% if result_3.stdout is defined and '*** PASS ***' in result_3.stdout %}
            PASS
          {% elif result_3.stdout is defined and 'FirewallD is in use on the system' in result_3.stdout %}
            NA
          {% elif result_3.stdout is defined and '*** FAIL ***' in result_3.stdout %}
            FAIL
          {% elif "'enabled' not in data_1" | bool == false %}
            NA
          {% else %}
            FAIL
          {% endif %}
        rationale_3: >-
          {% if result_3.stdout is defined and '*** PASS ***' in result_3.stdout %}
            PASS - Script output contains *** PASS ***
          {% elif result_3.stdout is defined and 'FirewallD is in use on the system' in result_3.stdout %}
            NA - FirewallD is enabled (makes checkpoint NA)
          {% elif result_3.stdout is defined and '*** FAIL ***' in result_3.stdout %}
            FAIL - Script output contains *** FAIL ***
          {% elif "'enabled' not in data_1" | bool == false %}
            NA - FirewallD enabled, script not executed
          {% else %}
            FAIL - Script execution failed or produced unexpected output
          {% endif %}

    # Requirement 4: Overall verification - FIXED: Check all three requirements
    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Overall verification"
        task_4_cmd: "N/A - Calculated from audit script output"
        task_4_rc: 0
        data_4: "N/A"
        status_4: >-
          {% if status_1 | trim == 'PASS' and status_2 | trim == 'PASS' and status_3 | trim == 'PASS' %}
            PASS
          {% elif status_1 | trim == 'FAIL' or status_3 | trim == 'NA' %}
            NA
          {% else %}
            FAIL
          {% endif %}
        rationale_4: >-
          {% if status_1 | trim == 'PASS' and status_2 | trim == 'PASS' and status_3 | trim == 'PASS' %}
            PASS - All requirements met: FirewallD not enabled, nftables enabled, and loopback rules correctly configured
          {% elif status_1 | trim == 'FAIL' or status_3 | trim == 'NA' %}
            NA - FirewallD enabled or nftables not enabled (checkpoint not applicable)
          {% else %}
            FAIL - One or more requirements failed: FirewallD enabled, nftables not enabled, or loopback rules not correctly configured
          {% endif %}

    # Requirement 5: Add comment referencing CIS RHEL 9 Benchmark v2.0.0, checkpoint 4.3.4
    - name: Req 5 - Add CIS reference comment
      set_fact:
        task_5_name: "Add CIS reference comment"
        task_5_cmd: "N/A - Reference added in playbook"
        task_5_rc: 0
        data_5: "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 4.3.4"
        status_5: "PASS"
        rationale_5: "PASS - CIS reference included in playbook"

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 4.3.4"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 4.3.4"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - Check if FirewallD is enabled using command: systemctl is-enabled firewalld.service 2>/dev/null. Rationale: PASS when command output is NOT 'enabled' (or service is not found), FAIL when output is 'enabled' (as this makes the checkpoint Not Applicable).:"
          - "  Task: Check FirewallD status"
          - "  Command: systemctl is-enabled firewalld.service 2>/dev/null"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - Check if nftables is enabled using command: systemctl is-enabled nftables.service. Rationale: PASS when command output is 'enabled', FAIL when output is not 'enabled' (and FirewallD is also not enabled per req_1).:"
          - "  Task: Check nftables status"
          - "  Command: systemctl is-enabled nftables.service"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - Run the following script to audit nftables loopback configuration. Rationale: PASS when script output contains '*** PASS ***' and no '*** FAIL ***' lines, FAIL when script output contains '*** FAIL ***' or indicates FirewallD is in use (making it NA) or indicates neither firewall is enabled.:"
          - "  Task: Execute CIS audit script for nftables loopback configuration"
          - "  Command: /tmp/cis_audit_4.3.4.sh"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - OVERALL Verify: Ensure nftables loopback traffic is configured. Rationale: PASS when req_1=PASS (FirewallD not enabled) AND req_2=PASS (nftables is enabled) AND req_3=PASS (loopback rules are correctly configured), FAIL otherwise.:"
          - "  Task: Overall verification"
          - "  Command: N/A - Calculated from audit script output"
          - "  Exit code: 0"
          - "  Data: N/A"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 5 - Add comment referencing CIS RHEL 9 Benchmark v2.0.0, checkpoint 4.3.4:"
          - "  Task: Add CIS reference comment"
          - "  Command: N/A - Reference added in playbook"
          - "  Exit code: 0"
          - "  Data: Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 4.3.4"
          - "  Status: PASS"
          - "  Rationale: PASS - CIS reference included in playbook"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - "========================================================"