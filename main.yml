---
- name: Convert and Execute CIS Audit Tasks
  hosts: all
  become: true
  gather_facts: false

  vars:
    checkpoint_list:
      - '6.3.3.12 Ensure login and logout events are collected (Automated)'
      - '6.3.3.13 Ensure file deletion events by users are collected (Automated)'

  tasks:

    - name: Display the generated task list
      debug:
        var: index
    
    - name: Construct the playbook task list
      set_fact:
        audit_task_playbook: >-
          {{ index.split(',') | map('replace', '.', '_') | map('regex_replace', '^(.*)$', 'tasks/cis_audit_\1.yml') | list }}

    - name: Display the generated task list
      debug:
        var: audit_task_playbook

    - name: Construct the playbook task list
      set_fact:
        audit_task_playbook: >-
          {{ checkpoint_list | map('split', ' ') | map('first') | map('replace', '.', '_') | map('regex_replace', '^(.*)$', 'tasks/cis_audit_\1.yml') | list }}

    - name: Display the generated task list
      debug:
        var: audit_task_playbook

    #- name: Trigger the audit tasks
    #  include_tasks: "{{ item }}"
    #  loop: "{{ audit_task_playbook | list }}"
    #  loop_control:
    #    label: "Running: {{ item }}"
    #  ignore_errors: yes

