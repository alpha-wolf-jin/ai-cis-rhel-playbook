================================================================================
DATA FLOW: PLAYBOOK → AI ANALYSIS
================================================================================

COMPLETE PIPELINE:

  ┌─────────────────────────────────────────────────────────┐
  │ 1. GENERATE PLAYBOOK (LLM)                              │
  │    Input: Requirements + Objective                      │
  │    Output: Playbook (data collection only)              │
  └─────────────────────────────────────────────────────────┘
                            ↓
                  playbook_content
                            ↓
  ┌─────────────────────────────────────────────────────────┐
  │ 2. SAVE PLAYBOOK                                        │
  │    Save to: compliance_check.yml                        │
  └─────────────────────────────────────────────────────────┘
                            ↓
                       filename
                            ↓
  ┌─────────────────────────────────────────────────────────┐
  │ 3. CHECK SYNTAX                                         │
  │    Validate: YAML syntax                                │
  └─────────────────────────────────────────────────────────┘
                            ↓
                      syntax_valid
                            ↓
  ┌─────────────────────────────────────────────────────────┐
  │ 4. EXECUTE ON TEST HOST                                 │
  │    Run playbook → Collect data                          │
  │    Output captured to: test_output ← KEY VARIABLE       │
  │                                                          │
  │    test_output contains:                                │
  │    ┌──────────────────────────────────────────────┐    │
  │    │ DATA COLLECTION REPORT                       │    │
  │    │ Requirement 1: Docker version 20.10.24       │    │
  │    │ Requirement 2: Service httpd is stopped      │    │
  │    │ Requirement 3: RHEL 8.6                      │    │
  │    └──────────────────────────────────────────────┘    │
  └─────────────────────────────────────────────────────────┘
                            ↓
                      test_output ✅
                            ↓
  ┌─────────────────────────────────────────────────────────┐
  │ 5. AI ANALYSIS (analyze_output_node)                    │
  │                                                          │
  │    analyze_playbook_output(                             │
  │        requirements,      ← Original requirements       │
  │        objective,         ← What we're checking         │
  │        test_output  ✅    ← Data from playbook          │
  │    )                                                     │
  │                                                          │
  │    AI analyzes test_output and determines:              │
  │    ┌──────────────────────────────────────────────┐    │
  │    │ Req 1: COMPLIANT (Docker present)           │    │
  │    │ Req 2: NON-COMPLIANT (Service stopped)      │    │
  │    │ Req 3: NON-COMPLIANT (RHEL 8, need RHEL 7)  │    │
  │    │ OVERALL: PASS (data collected successfully) │    │
  │    └──────────────────────────────────────────────┘    │
  └─────────────────────────────────────────────────────────┘
                            ↓
              analysis_passed + analysis_message
                            ↓
                   ┌────────┴────────┐
                   │                 │
                analysis_passed?     │
                   │                 │
              ┌────┴────┐            │
              │         │            │
            YES        NO             │
              │         │            │
              │    Max retries?      │
              │         │            │
              │    ┌────┴────┐       │
              │   YES       NO       │
              │    │         │       │
              │   END    RETRY       │
              │              │       │
              │              └───────┘
              │          (regenerate)
              ↓
  ┌─────────────────────────────────────────────────────────┐
  │ 6. EXECUTE ON TARGET HOST (Final)                       │
  │    Run playbook on production server                    │
  │    Collect final data → final_output                    │
  │    (Can be analyzed by AI again if needed)              │
  └─────────────────────────────────────────────────────────┘
                            ↓
                      final_output
                            ↓
  ┌─────────────────────────────────────────────────────────┐
  │ 7. COMPLETE                                             │
  │    Success! Data collected + AI analyzed                │
  └─────────────────────────────────────────────────────────┘

================================================================================

KEY DATA VARIABLES:

  playbook_content  → Generated playbook (data collection)
  filename          → compliance_check.yml
  test_output       → ✅ DATA FROM PLAYBOOK (passed to AI)
  analysis_message  → AI's compliance determination
  final_output      → Data from target host

================================================================================

THE CRITICAL FLOW:

  Playbook Execution (Step 4)
           ↓
    Captures output
           ↓
    test_output = "DATA COLLECTION REPORT\n..."
           ↓
    Passed to analyze_output_node (Step 5)
           ↓
    AI receives test_output
           ↓
    AI analyzes data
           ↓
    Returns compliance determination

================================================================================

CODE REFERENCE:

  # Step 4: Capture data
  test_output = test_playbook_on_server(filename, test_host)
  state['test_output'] = test_output  ← Store for AI
  
  # Step 5: AI analyzes
  def analyze_output_node(state):
      analysis_passed, analysis_message = analyze_playbook_output(
          requirements=state['requirements'],
          playbook_objective=state['playbook_objective'],
          test_output=state['test_output']  ← AI receives data here
      )
      state['analysis_passed'] = analysis_passed
      state['analysis_message'] = analysis_message

================================================================================

EXAMPLE DATA IN test_output:

  TASK [Generate data collection report] ***********************************
  ok: [192.168.122.16] => {
      "msg": [
          "========================================",
          "DATA COLLECTION REPORT",
          "========================================",
          "Requirement 1 - Docker Version:",
          "  Data: Docker version 20.10.24 is installed",
          "",
          "Requirement 2 - Service Status:",
          "  Data: Service httpd is stopped",
          "========================================",
          "NOTE: AI will analyze this data to determine compliance"
      ]
  }

  ↑ This entire output is in test_output
  ↓ Passed to AI for analysis

EXAMPLE AI OUTPUT (analysis_message):

  Requirement 1: Docker must be installed
  Data Collected: Docker version 20.10.24 is installed
  Compliance Status: COMPLIANT
  Reasoning: Data shows Docker is present with version 20.10.24
  
  Requirement 2: Service httpd must be running
  Data Collected: Service httpd is stopped
  Compliance Status: NON-COMPLIANT
  Reasoning: Service is stopped, requirement specifies running
  
  OVERALL: PASS

================================================================================

WHY THIS WORKS:

  1. Playbook has no intelligence
     → Just collects data
     → Stores in test_output
  
  2. test_output passed to AI
     → Contains all collected data
     → Clean format for analysis
  
  3. AI has all intelligence
     → Reads test_output
     → Determines compliance
     → Provides reasoning

  4. Separation of concerns
     → Playbook: data collection
     → AI: intelligence
     → Perfect division of labor!

================================================================================

STATUS: ✅ VERIFIED AND DOCUMENTED
Flow is correctly implemented in both versions!
================================================================================
