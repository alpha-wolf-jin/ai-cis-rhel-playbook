---
- name: Data Collection for CIS 1.1.1.3
  hosts: all
  become: yes
  gather_facts: yes
  vars:
    cis_reference: "CIS RHEL 8 Benchmark v4.0.0 checkpoint 1.1.1.3"
    req_1: "Run script to check if hfs kernel module is available on filesystem"
    req_2: "Verify hfs kernel module is not loaded"
    req_3: "Verify hfs kernel module is not loadable"
    req_4: "OVERALL Verify: Ensure hfs kernel module is not available"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: "Not collected yet"
        data_2: "Not collected yet"
        data_3: "Not collected yet"
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        status_1: "UNKNOWN"
        status_2: "NA"
        status_3: "NA"
        status_4: "UNKNOWN"
        rationale_1: "Not evaluated"
        rationale_2: "Task skipped - Requirement 1 returned no output"
        rationale_3: "Task skipped - Requirement 1 returned no output"
        rationale_4: "Not evaluated"

    # Requirement 1: Run script to check if hfs kernel module is available on filesystem
    - name: "Req 1 - Create temporary audit script for hfs module availability"
      copy:
        dest: "/tmp/cis_audit_script_1.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_mod_name="hfs" l_mod_type="fs"
             while IFS= read -r l_mod_path; do
                if [ -d "$l_mod_path/${l_mod_name//-/\/}" ] &&  \
                [ -n "$(ls -A "$l_mod_path/${l_mod_name//-/\/}")" ]; then
                   printf '%s\n' "$l_mod_name exists in $l_mod_path"
                fi
             done < <(readlink -e /usr/lib/modules/**/kernel/$l_mod_type \
             || readlink -e /lib/modules/**/kernel/$l_mod_type)
          }
          {% endraw %}
      register: script_created_1
      ignore_errors: true
      failed_when: false

    - name: "Req 1 - Execute audit script for hfs module availability"
      shell: "/tmp/cis_audit_script_1.sh"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      failed_when: false
      changed_when: false

    - name: "Req 1 - Remove temporary audit script"
      file:
        path: "/tmp/cis_audit_script_1.sh"
        state: absent
      ignore_errors: true

    - name: Store requirement 1 details and determine status
      set_fact:
        task_1_name: "Check if hfs kernel module is available on filesystem"
        task_1_cmd: "Execute CIS audit script for hfs module availability"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('PASS' if (result_1.stdout | default('') | trim == '') else 'FAIL') | trim }}"
        rationale_1: "PASS when the script returns no output (module not available) OR the system includes hfs in the kernel (also returns no output), FAIL when the script returns output indicating the hfs module exists on the filesystem"

    # Requirement 2: Verify hfs kernel module is not loaded
    - name: "Req 2 - Check if hfs kernel module is loaded"
      shell: |
        lsmod | grep 'hfs'
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: data_1 | trim | length > 0

    - name: Store requirement 2 details and determine status
      set_fact:
        task_2_name: "Check if hfs kernel module is loaded"
        task_2_cmd: "lsmod | grep 'hfs'"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: "{{ ('PASS' if (result_2.stdout | default('') | trim == '') else 'FAIL') | trim }}"
        rationale_2: "PASS when the command returns no output, FAIL when it returns any output"
      when: data_1 | trim | length > 0

    # Requirement 3: Verify hfs kernel module is not loadable
    - name: "Req 3 - Check if hfs kernel module is not loadable"
      shell: |
        modprobe --showconfig | grep -P -- '\b(install|blacklist)\h+hfs\b'
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      failed_when: false
      changed_when: false
      when: data_1 | trim | length > 0

    - name: Store requirement 3 details and determine status
      set_fact:
        task_3_name: "Check if hfs kernel module is not loadable"
        task_3_cmd: |
          modprobe --showconfig | grep -P -- '\\b(install|blacklist)\\h+hfs\\b'
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: >
          {{ (
            'PASS' if (
              result_3.stdout | default('') | trim | length > 0 and
              'blacklist hfs' in result_3.stdout and
              ('install hfs /bin/false' in result_3.stdout or 'install hfs /bin/true' in result_3.stdout)
            ) else 'FAIL'
          ) | trim }}
        rationale_3: "PASS when the output contains 'blacklist hfs' AND (contains 'install hfs /bin/false' OR contains 'install hfs /bin/true'), FAIL otherwise"
      when: data_1 | trim | length > 0

    # Requirement 4: OVERALL Verify
    - name: Store requirement 4 details and determine overall status
      set_fact:
        status_4: >
          {{ (
            'PASS' if
            (result_1.stdout | default('') | trim == '') or
            (result_1.stdout | default('') | trim != '' and status_2 | trim == 'PASS' and status_3 | trim == 'PASS')
            else 'FAIL'
          ) | trim }}
        rationale_4: "PASS when (req_1 returns nothing) OR (req_1 returns output AND req_2=PASS AND req_3=PASS), FAIL otherwise"

    # Final report
    - name: Generate compliance report
      debug:
        msg:
          - "========================================================"
          - "        COMPLIANCE REPORT - CIS 1.1.1.3"
          - "========================================================"
          - "Reference: {{ cis_reference }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('NA') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('NA') | trim }}"
          - "  Rationale: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL COMPLIANCE:"
          - "  Result: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_4 | default('Not evaluated') | trim }}"
          - "========================================================"