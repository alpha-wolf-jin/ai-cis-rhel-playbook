---
- name: Remediation for CIS 5.3.3.3.1
  hosts: all
  become: yes
  gather_facts: false
  vars:
    checkpoint_id: "cis_5_3_3_3_1"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.3.3.3.1"
    req_1: "Edit or add the following line in /etc/security/pwhistory.conf: remember = 24"
    req_2: "Run the following script to remove the remember argument from the pam_pwhistory.so module in /etc/pam.d/system-auth and /etc/pam.d/password-auth"
    req_3: "VERIFY: Run the CIS audit procedure to confirm Ensure password history remember is configured is now properly configured"

  pre_tasks:
    - name: "State Guard - Check for existing checkpoint"
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag

    - name: "State Guard - Restore /etc/security/pwhistory.conf from backup"
      copy:
        src: "{{ state_guard_dir }}/pwhistory.conf.present"
        dest: "/etc/security/pwhistory.conf"
        remote_src: true
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Remove old checkpoint"
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists

    - name: "State Guard - Create checkpoint directory"
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'

    - name: "State Guard - Check if /etc/security/pwhistory.conf exists"
      stat:
        path: "/etc/security/pwhistory.conf"
      register: _sg_pwhistory_stat

    - name: "State Guard - Backup /etc/security/pwhistory.conf (present)"
      copy:
        src: "/etc/security/pwhistory.conf"
        dest: "{{ state_guard_dir }}/pwhistory.conf.present"
        remote_src: true
      when: _sg_pwhistory_stat.stat.exists

    - name: "State Guard - Create checkpoint flag"
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1

    - name: "Req 1 - Configure password history in pwhistory.conf"
      shell: |
        echo "=== BEFORE ==="
        cat /etc/security/pwhistory.conf 2>/dev/null || echo "File does not exist"
        echo "=== APPLYING CHANGE ==="
        if [ ! -d /etc/security ]; then
          mkdir -p /etc/security
        fi
        if grep -q '^remember\s*=' /etc/security/pwhistory.conf 2>/dev/null; then
          sed -i 's/^remember\s*=.*/remember = 24/' /etc/security/pwhistory.conf
        else
          echo "remember = 24" >> /etc/security/pwhistory.conf
        fi
        echo "=== AFTER ==="
        cat /etc/security/pwhistory.conf 2>/dev/null || echo "File does not exist"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true

    - name: "Store requirement 1 details"
      set_fact:
        task_1_name: "Configure /etc/security/pwhistory.conf"
        task_1_cmd: "Edit or add remember = 24 in /etc/security/pwhistory.conf"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('APPLIED' if result_1.rc | default(-1) == 0 else 'FAILED') | trim }}"
        rationale_1: "{{ ('APPLIED: Configured remember = 24 in /etc/security/pwhistory.conf' if result_1.rc | default(-1) == 0 else 'FAILED: Could not configure /etc/security/pwhistory.conf') | trim }}"

    - name: "Req 2 - Check if pam_pwhistory.so with remember argument exists"
      shell: |
        found=0
        for pam_file in system-auth password-auth; do
          if [ -f "/etc/pam.d/$pam_file" ]; then
            if grep -qE '^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so.*\s+remember\s*=' "/etc/pam.d/$pam_file"; then
              found=1
              echo "Found pam_pwhistory.so with remember argument in /etc/pam.d/$pam_file"
              break
            fi
          fi
        done
        if [ $found -eq 0 ]; then
          echo "No pam_pwhistory.so with remember argument found in PAM files"
        fi
        exit $found
      args:
        executable: /bin/bash
      register: pam_remember_check
      ignore_errors: true
      changed_when: false

    - name: "Req 2 - Execute CIS remediation script for PAM configuration (if needed)"
      block:
        - name: "Req 2 - Create CIS remediation script"
          copy:
            dest: "/tmp/cis_remediation_pwhistory.sh"
            mode: '0700'
            content: |
              {% raw %}
              #!/usr/bin/env bash
              {
                 for l_pam_file in system-auth password-auth; do
                   l_authselect_file="/etc/authselect/$(head -1 /etc/authselect/authselect.conf | grep 'custom/')/$l_pam_file"
                   sed -ri 's/(^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so.*)(\s+ remember\s*=\s*\S+)(.*$)/\1\4/' "$l_authselect_file"
                 done
                 authselect apply-changes
              }
              {% endraw %}
          register: script_create_2
          ignore_errors: true

        - name: "Req 2 - Execute the CIS remediation script"
          shell: "/tmp/cis_remediation_pwhistory.sh"
          args:
            executable: /bin/bash
          register: result_2_script
          ignore_errors: true

        - name: "Req 2 - Remove temporary remediation script"
          file:
            path: "/tmp/cis_remediation_pwhistory.sh"
            state: absent
          ignore_errors: true

        - name: "Req 2 - Check if system uses authselect"
          shell: |
            echo "=== Checking if authselect is used ==="
            if [ -d /etc/authselect ] && head -1 /etc/authselect/authselect.conf 2>/dev/null | grep -q 'custom/'; then
              echo "System uses authselect with custom profile"
              exit 0
            else
              echo "System does not use authselect with custom profile"
              exit 1
            fi
          args:
            executable: /bin/bash
          register: authselect_check
          ignore_errors: true
          changed_when: false

        - name: "Req 2 - Alternative PAM file editing if CIS script failed"
          shell: |
            echo "=== Alternative PAM file editing ==="
            echo "=== Checking PAM files for pam_pwhistory.so with remember parameter ==="
            
            changed=0
            for pam_file in system-auth password-auth; do
              file_path="/etc/pam.d/$pam_file"
              if [ -f "$file_path" ]; then
                echo "--- Checking $file_path ---"
                # Check if pam_pwhistory.so exists with remember parameter
                if grep -qE '^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so.*\s+remember\s*=' "$file_path"; then
                  echo "Found remember parameter in $file_path, removing..."
                  # Remove remember parameter
                  sed -ri 's/(^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so.*)(\s+remember\s*=\s*\S+)(.*)$/\1\4/' "$file_path"
                  changed=1
                  echo "Updated $file_path"
                else
                  echo "No remember parameter found in $file_path (or pam_pwhistory.so not present)"
                fi
              else
                echo "File $file_path does not exist"
              fi
            done
            
            if [ $changed -eq 1 ]; then
              echo "PAM files updated successfully"
            else
              echo "No changes needed to PAM files"
            fi
          args:
            executable: /bin/bash
          register: result_2_alt
          ignore_errors: true
          when: "authselect_check.rc != 0 or result_2_script.rc | default(-1) != 0"
      when: pam_remember_check.rc == 1
      ignore_errors: true

    - name: "Store requirement 2 details"
      set_fact:
        task_2_name: "Remove remember argument from pam_pwhistory.so"
        task_2_cmd: "Execute CIS remediation script for PAM files"
        task_2_rc: >-
          {% if pam_remember_check.rc == 0 %}
            -1
          {% elif authselect_check.rc == 0 %}
            {{ result_2_script.rc | default(-1) }}
          {% else %}
            {{ result_2_alt.rc | default(-1) }}
          {% endif %}
        data_2: >-
          {% if pam_remember_check.rc == 0 %}
            {{ pam_remember_check.stdout | default('') | trim }}
          {% elif authselect_check.rc == 0 %}
            {{ result_2_script.stdout | default('') | trim }}
          {% else %}
            {{ result_2_alt.stdout | default('') | trim }}
          {% endif %}
        status_2: >-
          {% if pam_remember_check.rc == 0 %}
            SKIPPED
          {% elif authselect_check.rc == 0 %}
            {{ ('APPLIED' if result_2_script.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% else %}
            {{ ('APPLIED' if result_2_alt.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_2: >-
          {% if pam_remember_check.rc == 0 %}
            SKIPPED: pam_pwhistory.so with remember argument not found in PAM files - nothing to remediate
          {% elif authselect_check.rc == 0 %}
            {% if result_2_script.rc | default(-1) == 0 %}
              APPLIED: Script executed successfully, remember argument removed from authselect-managed PAM files
            {% else %}
              FAILED: Script failed to execute or modify authselect-managed PAM files
            {% endif %}
          {% else %}
            {% if result_2_alt.rc | default(-1) == 0 %}
              APPLIED: Alternative PAM editing applied successfully for non-authselect system
            {% else %}
              FAILED: Alternative PAM editing failed for non-authselect system
            {% endif %}
          {% endif %}

    - name: "Req 3 - Verify password history configuration"
      shell: |
        echo "=== Checking /etc/security/pwhistory.conf ==="
        grep -E '^\s*remember\s*=\s*24' /etc/security/pwhistory.conf 2>/dev/null || echo "ERROR: remember not set to 24"
        echo "=== Checking pam_pwhistory.so in PAM files ==="
        verification_passed=true
        
        # Check pwhistory.conf
        if grep -qE '^\s*remember\s*=\s*24' /etc/security/pwhistory.conf 2>/dev/null; then
          echo "PASS: remember=24 configured in pwhistory.conf"
        else
          echo "FAIL: remember=24 not configured in pwhistory.conf"
          verification_passed=false
        fi
        
        # Check PAM files for remember parameter in pam_pwhistory.so
        echo "=== Checking PAM files for remember parameter ==="
        for pam_file in system-auth password-auth; do
          echo "--- $pam_file ---"
          if [ -f "/etc/pam.d/$pam_file" ]; then
            if grep -qE '^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so' "/etc/pam.d/$pam_file"; then
              # Check if remember parameter exists
              if grep -qE '^\s*password\s+(requisite|required|sufficient)\s+pam_pwhistory\.so.*\s+remember\s*=' "/etc/pam.d/$pam_file"; then
                echo "FAIL: pam_pwhistory.so found with remember parameter in $pam_file"
                verification_passed=false
              else
                echo "PASS: pam_pwhistory.so found without remember parameter in $pam_file"
              fi
            else
              echo "PASS: pam_pwhistory.so not found in $pam_file (no remember parameter)"
            fi
          else
            echo "File /etc/pam.d/$pam_file not found"
          fi
        done
        
        echo "=== Verification summary ==="
        if $verification_passed; then
          echo "OVERALL: PASS - Password history properly configured"
        else
          echo "OVERALL: FAIL - Password history not properly configured"
        fi
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true

    - name: "Store requirement 3 details"
      set_fact:
        task_3_name: "Verify password history configuration"
        task_3_cmd: "Check pwhistory.conf and PAM files"
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: >-
          {% set output = result_3.stdout | default('') | trim %}
          {% if 'OVERALL: PASS' in output %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_3: >-
          {% set output = result_3.stdout | default('') | trim %}
          {% if 'OVERALL: PASS' in output %}
            APPLIED: Verification passed - password history properly configured
          {% else %}
            FAILED: Verification failed - password history not properly configured
          {% endif %}

    - name: "Determine overall remediation status"
      set_fact:
        overall_status: >-
          {% set s1 = status_1 | default('FAILED') | trim %}
          {% set s2 = status_2 | default('FAILED') | trim %}
          {% if s1 == 'FAILED' or s2 == 'FAILED' %}
            FAILED
          {% elif s1 == 'APPLIED' and (s2 == 'APPLIED' or s2 == 'SKIPPED') %}
            APPLIED
          {% else %}
            PARTIALLY APPLIED
          {% endif %}
        overall_details: >-
          {% set s1 = status_1 | default('FAILED') | trim %}
          {% set s2 = status_2 | default('FAILED') | trim %}
          {% if s1 == 'FAILED' or s2 == 'FAILED' %}
            {% if s1 == 'FAILED' and s2 == 'FAILED' %}
              Failed to apply both requirements
            {% elif s1 == 'FAILED' %}
              Requirement 1 failed - pwhistory.conf not configured
            {% else %}
              Requirement 2 failed - PAM file modification unsuccessful
            {% endif %}
          {% elif s1 == 'APPLIED' and s2 == 'APPLIED' %}
            Both requirements successfully applied - password history configured and PAM files updated
          {% elif s1 == 'APPLIED' and s2 == 'SKIPPED' %}
            Requirement 1 applied and Requirement 2 skipped (no remember argument found) - system compliant
          {% else %}
            Unknown state - manual review required
          {% endif %}

    - name: "Generate remediation report"
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 5.3.3.3.1"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: {{ overall_status | default('UNKNOWN') | trim }}"
          - "  Details: {{ overall_details | default('Not evaluated') | trim }}"
          - "========================================================"