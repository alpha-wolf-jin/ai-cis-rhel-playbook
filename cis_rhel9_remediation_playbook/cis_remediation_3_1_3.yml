---
- name: Remediation for CIS 3.1.3 - Ensure bluetooth services are not in use
  hosts: all
  become: yes
  gather_facts: false
  vars:
    checkpoint_id: "cis_3_1_3"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 3.1.3"
    
    # Requirement descriptions
    req_1: "Check if bluez package is installed using command: rpm -q bluez. Expected result: If package is NOT installed, skip all subsequent steps with status 'SKIPPED' and message 'Remediation not applicable - bluez is not installed on this server'."
    req_2: "Stop the bluetooth service using command: systemctl stop bluetooth.service. Expected result: bluetooth.service is stopped."
    req_3: "Remove the bluez package using command: dnf remove -y bluez. Expected result: bluez package is removed. (This step is an alternative to masking the service if the package is not required as a dependency)."
    req_4: "Mask the bluetooth service using command: systemctl mask bluetooth.service. Expected result: bluetooth.service is masked to prevent it from being started. (This step is an alternative to package removal if bluez is required as a dependency)."
    req_5: "Run audit check to confirm Ensure bluetooth services are not in use is properly configured. Expected result: System should now be compliant; bluetooth.service should be masked or the bluez package should be removed."

  pre_tasks:
    # === STATE GUARD: Ensure pristine state for each remediation attempt ===
    # Note: This remediation does not modify config files, only stops/removes packages and masks services
    # We'll backup service state and package list instead
    
    - name: State Guard - Check for existing checkpoint
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag
    
    # RESTORE PHASE: If checkpoint exists, previous run left dirty state - restore original state
    # Restore package if it was removed in previous attempt
    - name: State Guard - Restore bluez package if it existed before
      shell: |
        # Check if backup of package state exists
        if [ -f "{{ state_guard_dir }}/bluez_present" ]; then
          echo "Restoring bluez package from backup..."
          dnf install -y bluez
        fi
      args:
        executable: /bin/bash
      when: _sg_flag.stat.exists
      ignore_errors: true
    
    # Unmask service if it was masked in previous attempt
    - name: State Guard - Unmask bluetooth service if it was unmasked before
      shell: |
        # Check if backup of service state exists
        if [ -f "{{ state_guard_dir }}/bluetooth_unmasked" ]; then
          echo "Unmasking bluetooth service..."
          systemctl unmask bluetooth.service
        fi
      args:
        executable: /bin/bash
      when: _sg_flag.stat.exists
      ignore_errors: true
    
    # Restart service if it was running before
    - name: State Guard - Restart bluetooth service if it was running before
      shell: |
        # Check if backup shows service was active
        if [ -f "{{ state_guard_dir }}/bluetooth_active" ]; then
          echo "Restarting bluetooth service..."
          systemctl start bluetooth.service
        fi
      args:
        executable: /bin/bash
      when: _sg_flag.stat.exists
      ignore_errors: true
    
    - name: State Guard - Remove old checkpoint
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists
      ignore_errors: true
    
    # CAPTURE PHASE: Backup current pristine state before remediation
    - name: State Guard - Create checkpoint directory
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'
    
    # Check current package state
    - name: State Guard - Check if bluez package is installed
      shell: rpm -q bluez
      args:
        executable: /bin/bash
      register: _sg_bluez_check
      ignore_errors: true
      changed_when: false
    
    # Backup package state
    - name: State Guard - Backup bluez package state (present)
      copy:
        content: "present"
        dest: "{{ state_guard_dir }}/bluez_present"
      when: _sg_bluez_check.rc == 0
    
    - name: State Guard - Mark bluez package as absent
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/bluez_absent"
      when: _sg_bluez_check.rc != 0
    
    # Check current service state
    - name: State Guard - Check bluetooth service state
      shell: |
        systemctl is-active bluetooth.service 2>/dev/null || echo "inactive"
        systemctl is-enabled bluetooth.service 2>/dev/null || echo "disabled"
        systemctl is-masked bluetooth.service 2>/dev/null && echo "masked" || echo "not-masked"
      args:
        executable: /bin/bash
      register: _sg_service_check
      ignore_errors: true
      changed_when: false
    
    # Backup service state
    - name: State Guard - Backup bluetooth service active state
      copy:
        content: "{{ _sg_service_check.stdout_lines[0] | default('inactive') }}"
        dest: "{{ state_guard_dir }}/bluetooth_active"
      when: "'active' in _sg_service_check.stdout"
    
    - name: State Guard - Backup bluetooth service masked state
      copy:
        content: "{{ _sg_service_check.stdout_lines[2] | default('not-masked') }}"
        dest: "{{ state_guard_dir }}/bluetooth_masked"
      when: "'masked' in _sg_service_check.stdout"
    
    - name: State Guard - Mark bluetooth service as unmasked
      copy:
        content: "unmasked"
        dest: "{{ state_guard_dir }}/bluetooth_unmasked"
      when: "'not-masked' in _sg_service_check.stdout"
    
    - name: State Guard - Create checkpoint flag
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        data_3: ""
        data_4: ""
        data_5: ""
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1

    # Requirement 1: Check if bluez package is installed
    - name: Req 1 - Check if bluez package is installed
      shell: rpm -q bluez
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check bluez package installation"
        task_1_cmd: "rpm -q bluez"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('SKIPPED' if result_1.rc | default(-1) != 0 else 'APPLIED') | trim }}"
        rationale_1: "{{ ('SKIPPED: Remediation not applicable - bluez is not installed on this server' if result_1.rc | default(-1) != 0 else 'APPLIED: bluez package is installed, proceeding with remediation') | trim }}"
        bluez_installed: "{{ result_1.rc | default(-1) == 0 }}"

    # Requirement 2: Stop the bluetooth service
    - name: Req 2 - Stop bluetooth service
      shell: systemctl stop bluetooth.service
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      when: bluez_installed | default(false)

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Stop bluetooth service"
        task_2_cmd: "systemctl stop bluetooth.service"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: "{{ ('SKIPPED' if not (bluez_installed | default(false)) else ('APPLIED' if result_2.rc | default(-1) == 0 else 'FAILED')) | trim }}"
        rationale_2: "{{ ('SKIPPED: bluez package not installed' if not (bluez_installed | default(false)) else ('APPLIED: bluetooth.service stopped successfully' if result_2.rc | default(-1) == 0 else 'FAILED: Could not stop bluetooth.service')) | trim }}"

    # Requirement 3: Remove bluez package (try first)
    - name: Req 3 - Remove bluez package
      shell: dnf remove -y bluez
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      when: bluez_installed | default(false)

    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Remove bluez package"
        task_3_cmd: "dnf remove -y bluez"
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: "{{ ('SKIPPED' if not (bluez_installed | default(false)) else ('APPLIED' if result_3.rc | default(-1) == 0 else 'FAILED')) | trim }}"
        rationale_3: "{{ ('SKIPPED: bluez package not installed' if not (bluez_installed | default(false)) else ('APPLIED: bluez package removed successfully' if result_3.rc | default(-1) == 0 else 'FAILED: Could not remove bluez package - may be required as dependency')) | trim }}"
        package_removed: "{{ result_3.rc | default(-1) == 0 }}"

    # Requirement 4: Mask bluetooth service (if package removal failed)
    - name: Req 4 - Mask bluetooth service
      shell: systemctl mask bluetooth.service
      args:
        executable: /bin/bash
      register: result_4
      ignore_errors: true
      when: bluez_installed | default(false) and not (package_removed | default(false))

    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Mask bluetooth service"
        task_4_cmd: "systemctl mask bluetooth.service"
        task_4_rc: "{{ result_4.rc | default(-1) }}"
        data_4: "{{ result_4.stdout | default('') | trim }}"
        status_4: >-
          {% if not (bluez_installed | default(false)) %}
            SKIPPED
          {% elif package_removed | default(false) %}
            SKIPPED
          {% elif result_4.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_4: >-
          {% if not (bluez_installed | default(false)) %}
            SKIPPED: bluez package not installed
          {% elif package_removed | default(false) %}
            SKIPPED: Package removed successfully, masking not needed
          {% elif result_4.rc | default(-1) == 0 %}
            APPLIED: bluetooth.service masked successfully
          {% else %}
            FAILED: Could not mask bluetooth.service
          {% endif %}

    # Requirement 5: Verify remediation
    - name: Req 5 - Verify remediation
      shell: |
        # Check if bluez package is still installed
        rpm -q bluez 2>/dev/null
        package_rc=$?
        
        # Check service state
        systemctl is-active bluetooth.service 2>/dev/null || echo "inactive"
        systemctl is-enabled bluetooth.service 2>/dev/null || echo "disabled"
        systemctl is-masked bluetooth.service 2>/dev/null && echo "masked" || echo "not-masked"
        
        # Determine overall compliance
        if [ $package_rc -eq 0 ]; then
          # Package still installed, check if service is masked
          if systemctl is-masked bluetooth.service >/dev/null 2>&1; then
            echo "COMPLIANT: bluez installed but service masked"
          else
            echo "NON-COMPLIANT: bluez installed and service not masked"
          fi
        else
          # Package removed
          echo "COMPLIANT: bluez package removed"
        fi
      args:
        executable: /bin/bash
      register: result_5
      ignore_errors: true
      when: bluez_installed | default(false)

    - name: Store requirement 5 details
      set_fact:
        task_5_name: "Verify remediation"
        task_5_cmd: "Check package and service state"
        task_5_rc: "{{ result_5.rc | default(-1) }}"
        data_5: "{{ result_5.stdout | default('') | trim }}"
        status_5: >-
          {% if not (bluez_installed | default(false)) %}
            SKIPPED
          {% elif 'COMPLIANT' in (result_5.stdout | default('')) %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_5: >-
          {% if not (bluez_installed | default(false)) %}
            SKIPPED: bluez package not installed
          {% elif 'COMPLIANT' in (result_5.stdout | default('')) %}
            APPLIED: System is now compliant with CIS 3.1.3
          {% else %}
            FAILED: System is not compliant with CIS 3.1.3
          {% endif %}

    # Final report
    - name: Generate remediation report
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 3.1.3"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Task: {{ task_4_name | default('Task not recorded') }}"
          - "  Command: {{ task_4_cmd | default('N/A') }}"
          - "  Exit code: {{ task_4_rc | default(-1) }}"
          - "  Data: {{ data_4 | default('') | trim }}"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 5 - {{ req_5 }}:"
          - "  Task: {{ task_5_name | default('Task not recorded') }}"
          - "  Command: {{ task_5_cmd | default('N/A') }}"
          - "  Exit code: {{ task_5_rc | default(-1) }}"
          - "  Data: {{ data_5 | default('') | trim }}"
          - "  Status: {{ status_5 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_5 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: {{ ('SKIPPED' if not (bluez_installed | default(false)) else (status_5 | default('FAILED'))) | trim }}"
          - "  Details: {{ ('Remediation not applicable - bluez is not installed on this server' if not (bluez_installed | default(false)) else ('Remediation applied successfully - bluetooth service stopped and either package removed or service masked' if status_5 | default('') | trim == 'APPLIED' else 'Remediation failed - system is not compliant with CIS 3.1.3')) | trim }}"
          - "========================================================"