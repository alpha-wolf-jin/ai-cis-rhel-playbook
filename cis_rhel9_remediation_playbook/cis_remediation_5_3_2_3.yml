---
- name: Remediation for CIS 5.3.2.3
  hosts: all
  become: yes
  gather_facts: false
  vars:
    checkpoint_id: "cis_5_3_2_3"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.3.2.3"
    req_1: "Run script to check for pam_pwquality.so lines and apply authselect changes"
    req_2: "VERIFY - Run CIS audit procedure to confirm pam_pwquality module is enabled"

  pre_tasks:
    # === STATE GUARD: Ensure pristine state for each remediation attempt ===
    - name: State Guard - Check for existing checkpoint
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag

    # RESTORE PHASE: If checkpoint exists, previous run left dirty state - restore originals
    - name: State Guard - Restore authselect configuration from backup
      shell: |
        if [ -d "{{ state_guard_dir }}/authselect" ]; then
          rm -rf /etc/authselect
          cp -r "{{ state_guard_dir }}/authselect" /etc/
        fi
        if [ -d "{{ state_guard_dir }}/pam.d" ]; then
          rm -rf /etc/pam.d
          cp -r "{{ state_guard_dir }}/pam.d" /etc/
        fi
      args:
        executable: /bin/bash
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: State Guard - Remove old checkpoint
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists

    # CAPTURE PHASE: Backup current pristine state before remediation
    - name: State Guard - Create checkpoint directory
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'

    - name: State Guard - Backup authselect configuration
      copy:
        src: /etc/authselect
        dest: "{{ state_guard_dir }}/authselect"
        remote_src: true
        directory_mode: yes
      ignore_errors: true

    - name: State Guard - Backup pam.d configuration
      copy:
        src: /etc/pam.d
        dest: "{{ state_guard_dir }}/pam.d"
        remote_src: true
        directory_mode: yes
      ignore_errors: true

    - name: State Guard - Create checkpoint flag
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Run the provided CIS remediation script to check for pam_pwquality.so lines
    # Then apply authselect changes based on the script output
    - name: Req 1 - Run CIS check script for pam_pwquality.so lines
      shell: |
        {% raw %}
        #!/usr/bin/env bash
        {
           l_module_name="pwquality"
           l_pam_profile="$(head -1 /etc/authselect/authselect.conf)"
           if grep -Pq -- '^custom\/' <<< "$l_pam_profile"; then
              l_pam_profile_path="/etc/authselect/$l_pam_profile"
           else
              l_pam_profile_path="/usr/share/authselect/default/$l_pam_profile"
           fi
           grep -P -- "\bpam_$l_module_name\.so\b" "$l_pam_profile_path"/{password,system}-auth
        }
        {% endraw %}
      args:
        executable: /bin/bash
      register: check_script_output
      ignore_errors: true

    - name: Req 1 - Set conditions for authselect commands
      set_fact:
        has_include_statement: |
          {{ '{include if \"with-pwquality\"}' in check_script_output.stdout }}
        has_lines_without_include: >-
          {% set output = check_script_output.stdout | default('') %}
          {% if output != '' and 'pam_pwquality.so' in output %}
            {% set lines = output.split('\n') %}
            {% set found = false %}
            {% for line in lines %}
              {% if 'pam_pwquality.so' in line and '{include if "with-pwquality"}' not in line %}
                {% set found = true %}
              {% endif %}
            {% endfor %}
            {{ found }}
          {% else %}
            false
          {% endif %}

    - name: Req 1 - Apply authselect enable-feature if needed
      shell: |
        authselect enable-feature with-pwquality
      args:
        executable: /bin/bash
      when: "has_include_statement | default(false)"
      register: enable_feature_result
      ignore_errors: true

    - name: Req 1 - Apply authselect apply-changes if needed
      shell: |
        authselect apply-changes
      args:
        executable: /bin/bash
      when: "has_lines_without_include | default(false)"
      register: apply_changes_result
      ignore_errors: true

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check pam_pwquality.so lines and apply authselect changes"
        task_1_cmd: "CIS check script + conditional authselect commands"
        task_1_rc: "{{ check_script_output.rc | default(-1) }}"
        data_1: |
          Check script output:
          {{ check_script_output.stdout | default('') | trim }}
          
          Has include statement: {{ has_include_statement | default(false) }}
          Has lines without include: {{ has_lines_without_include | default(false) }}
          
          Enable-feature command: 
          {% if enable_feature_result is defined and enable_feature_result.stdout is defined %}
            Exit code: {{ enable_feature_result.rc | default(-1) }}
            Output: {{ enable_feature_result.stdout | default('') | trim }}
          {% else %}
            Not executed
          {% endif %}
          
          Apply-changes command:
          {% if apply_changes_result is defined and apply_changes_result.stdout is defined %}
            Exit code: {{ apply_changes_result.rc | default(-1) }}
            Output: {{ apply_changes_result.stdout | default('') | trim }}
          {% else %}
            Not executed
          {% endif %}
        status_1: >-
          {% set check_output = check_script_output.stdout | default('') | trim %}
          {% if check_output == '' %}
            SKIPPED
          {% elif check_script_output.rc | default(-1) == 0 %}
            {% if has_include_statement | default(false) %}
              {% if enable_feature_result is defined and enable_feature_result.rc | default(-1) == 0 %}
                APPLIED
              {% else %}
                FAILED
              {% endif %}
            {% elif has_lines_without_include | default(false) %}
              {% if apply_changes_result is defined and apply_changes_result.rc | default(-1) == 0 %}
                APPLIED
              {% else %}
                FAILED
              {% endif %}
            {% else %}
              APPLIED
            {% endif %}
          {% else %}
            FAILED
          {% endif %}
        rationale_1: >-
          {% set check_output = check_script_output.stdout | default('') | trim %}
          {% if check_output == '' %}
            SKIPPED: pam_pwquality.so lines not found in authselect profile templates - manual update required
          {% elif check_script_output.rc | default(-1) == 0 %}
            {% if has_include_statement | default(false) %}
              {% if enable_feature_result is defined and enable_feature_result.rc | default(-1) == 0 %}
                APPLIED: Successfully enabled authselect with-pwquality feature
              {% else %}
                FAILED: authselect enable-feature with-pwquality command failed
              {% endif %}
            {% elif has_lines_without_include | default(false) %}
              {% if apply_changes_result is defined and apply_changes_result.rc | default(-1) == 0 %}
                APPLIED: Successfully applied authselect changes for pam_pwquality
              {% else %}
                FAILED: authselect apply-changes command failed
              {% endif %}
            {% else %}
              APPLIED: pam_pwquality.so already properly configured in authselect profile
            {% endif %}
          {% else %}
            FAILED: Check script failed with exit code {{ check_script_output.rc | default(-1) }}
          {% endif %}

    # Requirement 2: VERIFY - Run CIS audit procedure to confirm pam_pwquality module is enabled
    - name: Req 2 - Run CIS audit check for pam_pwquality module
      shell: |
        {% raw %}
        #!/usr/bin/env bash
        {
           l_module_name="pwquality"
           l_pam_profile="$(head -1 /etc/authselect/authselect.conf)"
           if grep -Pq -- '^custom\/' <<< "$l_pam_profile"; then
              l_pam_profile_path="/etc/authselect/$l_pam_profile"
           else
              l_pam_profile_path="/usr/share/authselect/default/$l_pam_profile"
           fi
           grep -P -- "\bpam_$l_module_name\.so\b" "$l_pam_profile_path"/{password,system}-auth
        }
        {% endraw %}
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Verify pam_pwquality module is enabled"
        task_2_cmd: "CIS audit check script"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% if output != '' and 'pam_pwquality.so' in output %}
            APPLIED
          {% elif output == '' and status_1 | trim == 'SKIPPED' %}
            SKIPPED
          {% else %}
            FAILED
          {% endif %}
        rationale_2: >-
          {% set output = result_2.stdout | default('') | trim %}
          {% if output != '' and 'pam_pwquality.so' in output %}
            APPLIED: pam_pwquality.so found in authselect profile templates
          {% elif output == '' and status_1 | trim == 'SKIPPED' %}
            SKIPPED: Not applicable - authselect profile does not contain pam_pwquality entries
          {% else %}
            FAILED: pam_pwquality.so not found in authselect profile templates
          {% endif %}

    # Final report
    - name: Generate remediation report
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 5.3.2.3"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Rationale: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: >-
              {% if status_1 | trim == 'APPLIED' and status_2 | trim == 'APPLIED' %}
                APPLIED
              {% elif status_1 | trim == 'SKIPPED' and status_2 | trim == 'SKIPPED' %}
                SKIPPED
              {% elif status_1 | trim == 'APPLIED' and status_2 | trim == 'FAILED' %}
                PARTIALLY APPLIED
              {% else %}
                FAILED
              {% endif %}"
          - "  Details: >-
              {% if status_1 | trim == 'APPLIED' and status_2 | trim == 'APPLIED' %}
                Successfully enabled pam_pwquality module using authselect commands
              {% elif status_1 | trim == 'SKIPPED' and status_2 | trim == 'SKIPPED' %}
                SKIPPED: Authselect profile does not contain pam_pwquality entries - manual update required
              {% elif status_1 | trim == 'APPLIED' and status_2 | trim == 'FAILED' %}
                PARTIALLY APPLIED: Remediation commands executed but verification failed
              {% else %}
                FAILED: Could not apply remediation for pam_pwquality module
              {% endif %}"
          - "========================================================"