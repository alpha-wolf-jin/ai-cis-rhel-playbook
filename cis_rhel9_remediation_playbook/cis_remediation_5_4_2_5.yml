---
- name: Remediation for CIS 5.4.2.5
  hosts: all
  become: yes
  become_method: sudo
  become_user: root
  gather_facts: no
  vars:
    checkpoint_id: "cis_5_4_2_5"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.4.2.5"
    req_1: "Check if root user exists"
    req_2: "Check for non-directory entries in root's PATH"
    req_3: "Check for empty directory entries (::) or trailing colon in root's PATH"
    req_4: "Check for current working directory (.) in root's PATH"
    req_5: "Check for directories not owned by root in root's PATH"
    req_6: "Check for directories with permissions less restrictive than 0755 in root's PATH"
    req_7: "VERIFY: Run audit check to confirm Ensure root path integrity is properly configured"
    safe_path: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

  pre_tasks:
    - name: "State Guard - Check for existing checkpoint"
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag
      ignore_errors: true

    - name: "State Guard - Restore /root/.bashrc from backup"
      copy:
        src: "{{ state_guard_dir }}/bashrc.present"
        dest: "/root/.bashrc"
        remote_src: true
      when: _sg_flag.stat.exists | default(false)
      ignore_errors: true

    - name: "State Guard - Restore /root/.profile from backup"
      copy:
        src: "{{ state_guard_dir }}/profile.present"
        dest: "/root/.profile"
        remote_src: true
      when: _sg_flag.stat.exists | default(false)
      ignore_errors: true

    - name: "State Guard - Remove old checkpoint"
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists | default(false)
      ignore_errors: true

    - name: "State Guard - Create checkpoint directory"
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'
      ignore_errors: true

    - name: "State Guard - Check if /root/.bashrc exists"
      stat:
        path: "/root/.bashrc"
      register: _sg_bashrc_stat
      ignore_errors: true

    - name: "State Guard - Check if /root/.profile exists"
      stat:
        path: "/root/.profile"
      register: _sg_profile_stat
      ignore_errors: true

    - name: "State Guard - Backup /root/.bashrc (present)"
      copy:
        src: "/root/.bashrc"
        dest: "{{ state_guard_dir }}/bashrc.present"
        remote_src: true
      when: _sg_bashrc_stat.stat.exists | default(false)
      ignore_errors: true

    - name: "State Guard - Mark /root/.bashrc as absent"
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/bashrc.absent"
      when: not (_sg_bashrc_stat.stat.exists | default(false))
      ignore_errors: true

    - name: "State Guard - Backup /root/.profile (present)"
      copy:
        src: "/root/.profile"
        dest: "{{ state_guard_dir }}/profile.present"
        remote_src: true
      when: _sg_profile_stat.stat.exists | default(false)
      ignore_errors: true

    - name: "State Guard - Mark /root/.profile as absent"
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/profile.absent"
      when: not (_sg_profile_stat.stat.exists | default(false))
      ignore_errors: true

    - name: "State Guard - Create checkpoint flag"
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"
      ignore_errors: true

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1
        task_6_name: "Not executed"
        task_6_cmd: "N/A"
        task_6_rc: -1
        task_7_name: "Not executed"
        task_7_cmd: "N/A"
        task_7_rc: -1
        path_issues_found: false
        remediation_applied: false
        root_user_exists: false
        data_1: ""
        data_2: ""
        data_3: ""
        data_4: ""
        data_5: ""
        data_6: ""
        data_7: ""
        status_1: "UNKNOWN"
        status_2: "SKIPPED"
        status_3: "SKIPPED"
        status_4: "SKIPPED"
        status_5: "SKIPPED"
        status_6: "SKIPPED"
        status_7: "SKIPPED"
        rationale_1: "Not evaluated"
        rationale_2: "Root user does not exist - remediation not applicable"
        rationale_3: "Root user does not exist - remediation not applicable"
        rationale_4: "Root user does not exist - remediation not applicable"
        rationale_5: "Root user does not exist - remediation not applicable"
        rationale_6: "Root user does not exist - remediation not applicable"
        rationale_7: "Root user does not exist - remediation not applicable"

    - name: "Req 1 - Check if root user exists"
      shell: id -u root
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        root_user_exists: "{{ result_1.rc | default(-1) == 0 }}"
        task_1_name: "Check root user ID"
        task_1_cmd: "id -u root"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('APPLIED' if result_1.rc is defined else 'FAILED') | trim }}"
        rationale_1: "{{ ('Root user exists (UID 0)' if result_1.rc | default(-1) == 0 else 'Root user does not exist' if result_1.rc is defined else 'Failed to execute the command') | trim }}"

    - name: "Req 2 - Check for non-directory entries in root's PATH"
      shell: |
        echo $PATH | tr ':' '\n' | while read dir; do
          if [ ! -d "$dir" ]; then
            echo "Non-directory found: $dir"
            exit 1
          fi
        done
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      changed_when: false
      when: "root_user_exists | default(false)"

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Check PATH for non-directory entries"
        task_2_cmd: |
          echo $PATH | tr ':' '\n' | while read dir; do if [ ! -d \"$dir\" ]; then echo \"Non-directory found: $dir\"; exit 1; fi; done
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: "{{ ('APPLIED' if result_2.rc | default(-1) == 0 else 'FAILED' if result_2.rc is defined else 'UNKNOWN') | trim }}"
        rationale_2: "{{ ('APPLIED: All PATH entries are directories' if result_2.rc | default(-1) == 0 else 'FAILED: Non-directory entries found in PATH' if result_2.rc is defined else 'Not executed') | trim }}"
        path_issues_found: "{{ result_2.rc | default(-1) != 0 }}"
      when: "root_user_exists | default(false)"

    - name: "Req 3 - Check for empty directory entries or trailing colon"
      shell: |
        if [[ "$PATH" == *::* ]] || [[ "$PATH" == *: ]] || [[ "$PATH" == ::* ]]; then
          echo "Empty or trailing colon found in PATH"
          exit 1
        fi
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      changed_when: false
      when: "root_user_exists | default(false)"

    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Check PATH for empty entries or trailing colon"
        task_3_cmd: |
          if [[ \"$PATH\" == *::* ]] || [[ \"$PATH\" == *: ]] || [[ \"$PATH\" == ::* ]]; then echo \"Empty or trailing colon found in PATH\"; exit 1; fi
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: "{{ ('APPLIED' if result_3.rc | default(-1) == 0 else 'FAILED' if result_3.rc is defined else 'UNKNOWN') | trim }}"
        rationale_3: "{{ ('APPLIED: No empty entries or trailing colon in PATH' if result_3.rc | default(-1) == 0 else 'FAILED: Empty entries or trailing colon found in PATH' if result_3.rc is defined else 'Not executed') | trim }}"
        path_issues_found: "{{ path_issues_found | default(false) or (result_3.rc | default(-1) != 0) }}"
      when: "root_user_exists | default(false)"

    - name: "Req 4 - Check for current working directory (.) in PATH"
      shell: |
        echo $PATH | tr ':' '\n' | grep -q '^\.$' && echo ". found in PATH" && exit 1
      args:
        executable: /bin/bash
      register: result_4
      ignore_errors: true
      changed_when: false
      when: "root_user_exists | default(false)"

    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Check PATH for current directory (.)"
        task_4_cmd: |
          echo $PATH | tr ':' '\n' | grep -q '^\.$' && echo \". found in PATH\" && exit 1
        task_4_rc: "{{ result_4.rc | default(-1) }}"
        data_4: "{{ result_4.stdout | default('') | trim }}"
        status_4: "{{ ('APPLIED' if result_4.rc | default(-1) == 0 else 'FAILED' if result_4.rc is defined else 'UNKNOWN') | trim }}"
        rationale_4: "{{ ('APPLIED: Current directory (.) not in PATH' if result_4.rc | default(-1) == 0 else 'FAILED: Current directory (.) found in PATH' if result_4.rc is defined else 'Not executed') | trim }}"
        path_issues_found: "{{ path_issues_found | default(false) or (result_4.rc | default(-1) != 0) }}"
      when: "root_user_exists | default(false)"

    - name: "Req 5 - Check for directories not owned by root"
      shell: |
        echo $PATH | tr ':' '\n' | while read dir; do
          if [ -d "$dir" ] && [ "$(stat -c '%U' "$dir")" != "root" ]; then
            echo "Non-root owned directory: $dir"
            exit 1
          fi
        done
      args:
        executable: /bin/bash
      register: result_5
      ignore_errors: true
      changed_when: false
      when: "root_user_exists | default(false)"

    - name: Store requirement 5 details
      set_fact:
        task_5_name: "Check PATH for non-root owned directories"
        task_5_cmd: |
          echo $PATH | tr ':' '\n' | while read dir; do if [ -d \"$dir\" ] && [ \"$(stat -c '%U' \"$dir\")\" != \"root\" ]; then echo \"Non-root owned directory: $dir\"; exit 1; fi; done
        task_5_rc: "{{ result_5.rc | default(-1) }}"
        data_5: "{{ result_5.stdout | default('') | trim }}"
        status_5: "{{ ('APPLIED' if result_5.rc | default(-1) == 0 else 'FAILED' if result_5.rc is defined else 'UNKNOWN') | trim }}"
        rationale_5: "{{ ('APPLIED: All PATH directories owned by root' if result_5.rc | default(-1) == 0 else 'FAILED: Non-root owned directories found in PATH' if result_5.rc is defined else 'Not executed') | trim }}"
        path_issues_found: "{{ path_issues_found | default(false) or (result_5.rc | default(-1) != 0) }}"
      when: "root_user_exists | default(false)"

    - name: "Req 6 - Check for directories with permissions less restrictive than 0755"
      shell: |
        echo $PATH | tr ':' '\n' | while read dir; do
          if [ -d "$dir" ] && [ "$(stat -c '%a' "$dir")" -lt 755 ]; then
            echo "Directory with perms less than 0755: $dir"
            exit 1
          fi
        done
      args:
        executable: /bin/bash
      register: result_6
      ignore_errors: true
      changed_when: false
      when: "root_user_exists | default(false)"

    - name: Store requirement 6 details
      set_fact:
        task_6_name: "Check PATH for directories with perms < 0755"
        task_6_cmd: |
          echo $PATH | tr ':' '\n' | while read dir; do if [ -d \"$dir\" ] && [ \"$(stat -c '%a' \"$dir\")\" -lt 755 ]; then echo \"Directory with perms less than 0755: $dir\"; exit 1; fi; done
        task_6_rc: "{{ result_6.rc | default(-1) }}"
        data_6: "{{ result_6.stdout | default('') | trim }}"
        status_6: "{{ ('APPLIED' if result_6.rc | default(-1) == 0 else 'FAILED' if result_6.rc is defined else 'UNKNOWN') | trim }}"
        rationale_6: "{{ ('APPLIED: All PATH directories have permissions >= 0755' if result_6.rc | default(-1) == 0 else 'FAILED: Directories with permissions < 0755 found in PATH' if result_6.rc is defined else 'Not executed') | trim }}"
        path_issues_found: "{{ path_issues_found | default(false) or (result_6.rc | default(-1) != 0) }}"
      when: "root_user_exists | default(false)"

    - name: Apply PATH remediation if issues found
      shell: |
        echo "=== BEFORE ==="
        echo "=== /root/.bashrc ==="
        cat /root/.bashrc 2>/dev/null || echo "File /root/.bashrc does not exist"
        echo ""
        echo "=== /root/.profile ==="
        cat /root/.profile 2>/dev/null || echo "File /root/.profile does not exist"
        echo ""
        echo "=== APPLYING CHANGE ==="
        # Remove existing PATH settings and add safe PATH
        if [ -f /root/.bashrc ]; then
          sed -i '/^\s*PATH=/d' /root/.bashrc
          echo "export PATH={{ safe_path }}" >> /root/.bashrc
        else
          echo "export PATH={{ safe_path }}" > /root/.bashrc
        fi
        
        if [ -f /root/.profile ]; then
          sed -i '/^\s*PATH=/d' /root/.profile
          echo "export PATH={{ safe_path }}" >> /root/.profile
        else
          echo "export PATH={{ safe_path }}" > /root/.profile
        fi
        echo ""
        echo "=== AFTER ==="
        echo "=== /root/.bashrc ==="
        cat /root/.bashrc 2>/dev/null || echo "File /root/.bashrc does not exist"
        echo ""
        echo "=== /root/.profile ==="
        cat /root/.profile 2>/dev/null || echo "File /root/.profile does not exist"
      args:
        executable: /bin/bash
      register: remediation_result
      ignore_errors: true
      when: 
        - "root_user_exists | default(false)"
        - "path_issues_found | default(false)"

    - name: Set remediation applied flag
      set_fact:
        remediation_applied: "{{ 'APPLYING CHANGE' in remediation_result.stdout | default('') }}"
      when: 
        - "root_user_exists | default(false)"
        - "path_issues_found | default(false)"

    - name: "Req 7 - Verify root path integrity"
      shell: |
        # Set the corrected PATH for verification
        export PATH={{ safe_path }}
        # Run all checks again with the corrected PATH
        issues=0
        echo "Verification with PATH: $PATH"
        
        # Check 1: Non-directory entries
        echo $PATH | tr ':' '\n' | while read dir; do
          if [ ! -d "$dir" ]; then
            echo "Non-directory found: $dir"
            exit 1
          fi
        done
        if [ $? -ne 0 ]; then
          issues=$((issues+1))
          echo "FAIL: Non-directory entries"
        fi
        
        # Check 2: Empty/trailing
        if [[ "$PATH" == *::* ]] || [[ "$PATH" == *: ]] || [[ "$PATH" == ::* ]]; then
          issues=$((issues+1))
          echo "FAIL: Empty or trailing colon"
        fi
        
        # Check 3: Current directory
        if echo $PATH | tr ':' '\n' | grep -q '^\.$'; then
          issues=$((issues+1))
          echo "FAIL: Current directory (.) found"
        fi
        
        # Check 4: Non-root owned
        echo $PATH | tr ':' '\n' | while read dir; do
          if [ -d "$dir" ] && [ "$(stat -c '%U' "$dir")" != "root" ]; then
            echo "Non-root owned directory: $dir"
            exit 1
          fi
        done
        if [ $? -ne 0 ]; then
          issues=$((issues+1))
          echo "FAIL: Non-root owned directories"
        fi
        
        # Check 5: Permissions < 0755
        echo $PATH | tr ':' '\n' | while read dir; do
          if [ -d "$dir" ] && [ "$(stat -c '%a' "$dir")" -lt 755 ]; then
            echo "Directory with perms less than 0755: $dir"
            exit 1
          fi
        done
        if [ $? -ne 0 ]; then
          issues=$((issues+1))
          echo "FAIL: Directories with permissions < 0755"
        fi
        
        if [ $issues -eq 0 ]; then
          echo "PASS: All checks passed"
          exit 0
        else
          echo "FAIL: $issues issue(s) found"
          exit 1
        fi
      args:
        executable: /bin/bash
      register: result_7
      ignore_errors: true
      when: "root_user_exists | default(false)"

    - name: Store requirement 7 details
      set_fact:
        task_7_name: "Verify root path integrity compliance"
        task_7_cmd: "Run all PATH integrity checks with corrected PATH"
        task_7_rc: "{{ result_7.rc | default(-1) }}"
        data_7: "{{ result_7.stdout | default('') | trim }}"
        status_7: "{{ ('APPLIED' if result_7.rc | default(-1) == 0 else 'FAILED' if result_7.rc is defined else 'UNKNOWN') | trim }}"
        rationale_7: "{{ ('APPLIED: System is now compliant' if result_7.rc | default(-1) == 0 else 'FAILED: Verification checks failed' if result_7.rc is defined else 'Not executed') | trim }}"
      when: "root_user_exists | default(false)"

    - name: Determine overall status
      set_fact:
        overall_status: >-
          {% if not (root_user_exists | default(false)) %}
            SKIPPED
          {% elif result_7.rc | default(-1) == 0 %}
            APPLIED
          {% elif path_issues_found | default(false) and remediation_applied | default(false) %}
            PARTIALLY APPLIED
          {% elif result_7.rc | default(-1) != 0 %}
            FAILED
          {% else %}
            UNKNOWN
          {% endif %}
        overall_details: >-
          {% if not (root_user_exists | default(false)) %}
            Root user does not exist - remediation not applicable
          {% elif result_7.rc | default(-1) == 0 %}
            Root path integrity has been verified and is compliant
          {% elif path_issues_found | default(false) and remediation_applied | default(false) %}
            PATH issues were detected and corrected, but verification failed
          {% elif result_7.rc | default(-1) != 0 %}
            Root path integrity verification failed
          {% else %}
            Could not determine remediation status
          {% endif %}

    - name: Generate remediation report
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 5.4.2.5"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Task: {{ task_4_name | default('Task not recorded') }}"
          - "  Command: {{ task_4_cmd | default('N/A') }}"
          - "  Exit code: {{ task_4_rc | default(-1) }}"
          - "  Data: {{ data_4 | default('') | trim }}"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 5 - {{ req_5 }}:"
          - "  Task: {{ task_5_name | default('Task not recorded') }}"
          - "  Command: {{ task_5_cmd | default('N/A') }}"
          - "  Exit code: {{ task_5_rc | default(-1) }}"
          - "  Data: {{ data_5 | default('') | trim }}"
          - "  Status: {{ status_5 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_5 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 6 - {{ req_6 }}:"
          - "  Task: {{ task_6_name | default('Task not recorded') }}"
          - "  Command: {{ task_6_cmd | default('N/A') }}"
          - "  Exit code: {{ task_6_rc | default(-1) }}"
          - "  Data: {{ data_6 | default('') | trim }}"
          - "  Status: {{ status_6 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_6 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 7 - {{ req_7 }}:"
          - "  Task: {{ task_7_name | default('Task not recorded') }}"
          - "  Command: {{ task_7_cmd | default('N/A') }}"
          - "  Exit code: {{ task_7_rc | default(-1) }}"
          - "  Data: {{ data_7 | default('') | trim }}"
          - "  Status: {{ status_7 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_7 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: {{ overall_status | trim }}"
          - "  Details: {{ overall_details | trim }}"
          - "========================================================"