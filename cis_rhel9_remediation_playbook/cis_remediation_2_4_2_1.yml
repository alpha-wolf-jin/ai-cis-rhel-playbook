---
- name: Remediation for CIS 2.4.2.1
  hosts: all
  become: yes
  gather_facts: false
  vars:
    checkpoint_id: "cis_2_4_2_1"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 2.4.2.1"
    
    # Requirements - copy EXACT text from requirements above
    req_1: "Run the provided CIS remediation script to fix Ensure at is restricted to authorized users. - IF - at is installed on the system: Run the following script to: • /etc/at.allow: o Create the file if it doesn't exist o Change owner or user root o If group daemon exists, change to group daemon, else change group to root o Change mode to 640 or more restrictive • - IF - /etc/at.deny exists: o Change owner or user root o If group daemon exists, change to group daemon, else change group to root o Change mode to 640 or more restrictive"
    req_2: "VERIFY: Run the CIS audit procedure to confirm Ensure at is restricted to authorized users is now properly configured."

  pre_tasks:
    # === STATE GUARD: Ensure pristine state for each remediation attempt ===
    - name: "State Guard - Check for existing checkpoint"
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag

    # RESTORE PHASE: If checkpoint exists, previous run left dirty state - restore originals
    # For .present backups: restore file from backup
    - name: "State Guard - Restore /etc/at.allow from backup"
      copy:
        src: "{{ state_guard_dir }}/at.allow.present"
        dest: "/etc/at.allow"
        remote_src: true
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Restore /etc/at.deny from backup"
      copy:
        src: "{{ state_guard_dir }}/at.deny.present"
        dest: "/etc/at.deny"
        remote_src: true
      when: _sg_flag.stat.exists
      ignore_errors: true

    # For .absent markers: delete the config file created by previous remediation
    - name: "State Guard - Delete /etc/at.allow (if created by remediation)"
      file:
        path: "/etc/at.allow"
        state: absent
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Delete /etc/at.deny (if created by remediation)"
      file:
        path: "/etc/at.deny"
        state: absent
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Remove old checkpoint"
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists

    # CAPTURE PHASE: Backup current pristine state before remediation
    - name: "State Guard - Create checkpoint directory"
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'

    # Check if each file exists before deciding backup suffix
    - name: "State Guard - Check if /etc/at.allow exists"
      stat:
        path: "/etc/at.allow"
      register: _sg_at_allow_stat

    - name: "State Guard - Check if /etc/at.deny exists"
      stat:
        path: "/etc/at.deny"
      register: _sg_at_deny_stat

    # Backup existing files with .present suffix
    - name: "State Guard - Backup /etc/at.allow (present)"
      copy:
        src: "/etc/at.allow"
        dest: "{{ state_guard_dir }}/at.allow.present"
        remote_src: true
      when: _sg_at_allow_stat.stat.exists

    - name: "State Guard - Backup /etc/at.deny (present)"
      copy:
        src: "/etc/at.deny"
        dest: "{{ state_guard_dir }}/at.deny.present"
        remote_src: true
      when: _sg_at_deny_stat.stat.exists

    # Mark non-existing files with .absent suffix (empty marker file)
    - name: "State Guard - Mark /etc/at.allow as absent"
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/at.allow.absent"
      when: not _sg_at_allow_stat.stat.exists

    - name: "State Guard - Mark /etc/at.deny as absent"
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/at.deny.absent"
      when: not _sg_at_deny_stat.stat.exists

    - name: "State Guard - Create checkpoint flag"
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    # Requirement 1: Check if at is installed and run remediation script
    - name: "Req 1 - Check if at package is installed"
      shell: |
        # Check if at package is installed - FIXED: removed dpkg check for RHEL compatibility
        if command -v atq >/dev/null 2>&1 || rpm -q at >/dev/null 2>&1; then
          echo "at package is installed"
        else
          echo "at package is NOT installed"
          exit 1
        fi
      args:
        executable: /bin/bash
      register: check_at_installed
      ignore_errors: true
      changed_when: false

    # Requirement 1: Execute CIS remediation script for at restriction
    - name: "Req 1 - Execute CIS remediation script for at restriction"
      block:
        - name: "Req 1 - Create remediation script"
          copy:
            dest: "/tmp/cis_remediation_2.4.2.1.sh"
            mode: '0700'
            content: |
              {% raw %}
              #!/usr/bin/env bash
              {
                 grep -Pq -- '^daemon\b' /etc/group && l_group="daemon" || l_group="root"
                 [ ! -e "/etc/at.allow" ] && touch /etc/at.allow
                 chown root:"$l_group" /etc/at.allow
                 chmod u-x,g-wx,o-rwx /etc/at.allow
                 [ -e "/etc/at.deny" ] && chown root:"$l_group" /etc/at.deny
                 [ -e "/etc/at.deny" ] && chmod u-x,g-wx,o-rwx /etc/at.deny
              }
              {% endraw %}
          register: script_create_1
          ignore_errors: true

        - name: "Req 1 - Execute the remediation script"
          shell: "/tmp/cis_remediation_2.4.2.1.sh"
          args:
            executable: /bin/bash
          register: result_1
          ignore_errors: true

        - name: "Req 1 - Remove temporary remediation script"
          file:
            path: "/tmp/cis_remediation_2.4.2.1.sh"
            state: absent
          ignore_errors: true
      when: check_at_installed.rc == 0
      run_once: true

    - name: "Store requirement 1 details"
      set_fact:
        task_1_name: "Execute CIS remediation script for at restriction"
        task_1_cmd: "Run provided bash script to configure /etc/at.allow and /etc/at.deny"
        task_1_rc: "{{ result_1.rc | default(-1) if check_at_installed.rc == 0 else -1 }}"
        data_1: >-
          {% if check_at_installed.rc != 0 %}
          at package is not installed - remediation not applicable
          {% else %}
          Script exit code: {{ result_1.rc | default(-1) }}
          Script stdout: {{ result_1.stdout | default('') | trim }}
          Script stderr: {{ result_1.stderr | default('') | trim }}
          {% endif %}
        status_1: >-
          {% if check_at_installed.rc != 0 %}
          SKIPPED
          {% else %}
          {{ ('APPLIED' if result_1.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_1: >-
          {% if check_at_installed.rc != 0 %}
          SKIPPED: at package is not installed on this system - remediation not applicable
          {% else %}
          {{ ('APPLIED: Script executed successfully and applied required configuration changes' if result_1.rc | default(-1) == 0 else 'FAILED: Script execution failed') | trim }}
          {% endif %}

    # Requirement 2: Verify remediation by running CIS audit procedure
    - name: "Req 2 - Run CIS audit procedure for at restriction"
      block:
        - name: "Req 2 - Create CIS audit script"
          copy:
            dest: "/tmp/cis_audit_2.4.2.1.sh"
            mode: '0700'
            content: |
              {% raw %}
              #!/usr/bin/env bash
              {
                l_output=""
                l_output2=""
                l_allow_owner="root"
                l_allow_group="daemon"
                l_allow_mode="640"
                l_deny_owner="root"
                l_deny_group="daemon"
                l_deny_mode="640"

                # Check if at is installed - FIXED: removed dpkg check for RHEL compatibility
                if rpm -q at &>/dev/null || command -v atq &>/dev/null; then
                  # Check /etc/at.allow
                  if [ -e "/etc/at.allow" ]; then
                    l_owner="$(stat -c '%U' /etc/at.allow)"
                    l_group="$(stat -c '%G' /etc/at.allow)"
                    l_mode="$(stat -c '%a' /etc/at.allow)"
                    if [ "$l_owner" != "$l_allow_owner" ]; then
                      l_output2="$l_output2\n  - /etc/at.allow owner is $l_owner (should be $l_allow_owner)"
                    fi
                    if [ "$l_group" != "$l_allow_group" ] && [ "$l_group" != "root" ]; then
                      l_output2="$l_output2\n  - /etc/at.allow group is $l_group (should be $l_allow_group or root)"
                    fi
                    if [ "$l_mode" -gt "$l_allow_mode" ]; then
                      l_output2="$l_output2\n  - /etc/at.allow permissions are $l_mode (should be $l_allow_mode or more restrictive)"
                    fi
                  else
                    l_output2="$l_output2\n  - /etc/at.allow does not exist"
                  fi

                  # Check /etc/at.deny if it exists
                  if [ -e "/etc/at.deny" ]; then
                    l_owner="$(stat -c '%U' /etc/at.deny)"
                    l_group="$(stat -c '%G' /etc/at.deny)"
                    l_mode="$(stat -c '%a' /etc/at.deny)"
                    if [ "$l_owner" != "$l_deny_owner" ]; then
                      l_output2="$l_output2\n  - /etc/at.deny owner is $l_owner (should be $l_deny_owner)"
                    fi
                    if [ "$l_group" != "$l_deny_group" ] && [ "$l_group" != "root" ]; then
                      l_output2="$l_output2\n  - /etc/at.deny group is $l_group (should be $l_deny_group or root)"
                    fi
                    if [ "$l_mode" -gt "$l_deny_mode" ]; then
                      l_output2="$l_output2\n  - /etc/at.deny permissions are $l_mode (should be $l_deny_mode or more restrictive)"
                    fi
                  fi
                else
                  l_output2="$l_output2\n  - at package is not installed"
                fi

                if [ -z "$l_output2" ]; then
                  echo -e "\n- Audit Result:\n  ** PASS **\n"
                  exit 0
                else
                  echo -e "\n- Audit Result:\n  ** FAIL **\n$l_output2\n"
                  exit 1
                fi
              }
              {% endraw %}
          register: audit_script_create
          ignore_errors: true

        - name: "Req 2 - Execute CIS audit script"
          shell: "/tmp/cis_audit_2.4.2.1.sh"
          args:
            executable: /bin/bash
          register: result_2
          ignore_errors: true
          changed_when: false

        - name: "Req 2 - Remove temporary audit script"
          file:
            path: "/tmp/cis_audit_2.4.2.1.sh"
            state: absent
          ignore_errors: true
      when: check_at_installed.rc == 0
      run_once: true

    - name: "Store requirement 2 details"
      set_fact:
        task_2_name: "Run CIS audit procedure for at restriction"
        task_2_cmd: "Execute CIS audit script to verify /etc/at.allow and /etc/at.deny configuration"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% if check_at_installed.rc != 0 %}
          SKIPPED
          {% else %}
          {{ ('APPLIED' if result_2.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_2: >-
          {% if check_at_installed.rc != 0 %}
          SKIPPED: at package is not installed on this system - verification not applicable
          {% else %}
          {{ ('APPLIED: CIS audit procedure passed - system is compliant' if result_2.rc | default(-1) == 0 else 'FAILED: CIS audit procedure failed - system is not compliant') | trim }}
          {% endif %}

    # Final report - MUST include Status and Details for each requirement
    - name: Generate remediation report
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 2.4.2.1"
          - "========================================================"
          - "Reference: CIS RHEL 9 Benchmark v2.0.0 checkpoint 2.4.2.1"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: {{ 'SKIPPED' if check_at_installed.rc != 0 else (status_2 | default('UNKNOWN') | trim) }}"
          - "  Details: {{ ('Remediation not applicable - at package is not installed on this system' if check_at_installed.rc != 0 else ('Remediation applied and verified successfully by CIS audit' if status_2 | trim == 'APPLIED' else 'Remediation may have failed or CIS audit indicates non-compliance')) | trim }}"
          - "========================================================"