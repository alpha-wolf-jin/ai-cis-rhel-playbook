---
- name: Remediation for CIS 1.8.3
  hosts: all
  become: yes
  gather_facts: false
  vars:
    checkpoint_id: "cis_1_8_3"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.8.3"
    req_1: "Run the provided CIS remediation script to fix Ensure GDM disable-user-list option is enabled"
    req_2: "VERIFY: Run the CIS audit procedure to confirm Ensure GDM disable-user-list option is enabled is now properly configured"

  pre_tasks:
    - name: "State Guard - Check for existing checkpoint"
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag

    - name: "State Guard - Restore /etc/dconf/profile/gdm from backup"
      copy:
        src: "{{ state_guard_dir }}/gdm_profile.present"
        dest: "/etc/dconf/profile/gdm"
        remote_src: true
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Delete /etc/dconf/profile/gdm (if created by remediation)"
      file:
        path: "/etc/dconf/profile/gdm"
        state: absent
      when: _sg_flag.stat.exists and (lookup('file', state_guard_dir ~ '/gdm_profile.absent') | trim == 'absent')
      ignore_errors: true

    - name: "State Guard - Restore dconf database files from backup"
      copy:
        src: "{{ state_guard_dir }}/{{ item }}.present"
        dest: "/etc/dconf/db/gdm.d/{{ item }}"
        remote_src: true
      loop: |
        {{ lookup('fileglob', state_guard_dir ~ '/*.present').split(' ') | map('basename') | map('regex_replace', '\\.present$', '') | list }}
      when: _sg_flag.stat.exists and item != 'gdm_profile'
      ignore_errors: true

    - name: "State Guard - Delete dconf database files (if created by remediation)"
      file:
        path: "/etc/dconf/db/gdm.d/{{ item }}"
        state: absent
      loop: |
        {{ lookup('fileglob', state_guard_dir ~ '/*.absent').split(' ') | map('basename') | map('regex_replace', '\\.absent$', '') | list }}
      when: _sg_flag.stat.exists and item != 'gdm_profile'
      ignore_errors: true

    - name: "State Guard - Remove old checkpoint"
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists

    - name: "State Guard - Create checkpoint directory"
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'

    - name: "State Guard - Check if /etc/dconf/profile/gdm exists"
      stat:
        path: "/etc/dconf/profile/gdm"
      register: _sg_gdm_profile_stat

    - name: "State Guard - Backup /etc/dconf/profile/gdm (present)"
      copy:
        src: "/etc/dconf/profile/gdm"
        dest: "{{ state_guard_dir }}/gdm_profile.present"
        remote_src: true
      when: _sg_gdm_profile_stat.stat.exists

    - name: "State Guard - Mark /etc/dconf/profile/gdm as absent"
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/gdm_profile.absent"
      when: not _sg_gdm_profile_stat.stat.exists

    - name: "State Guard - Check if dconf database files exist"
      find:
        paths: /etc/dconf/db/gdm.d
        patterns: "*"
      register: _sg_dconf_files
      ignore_errors: true

    - name: "State Guard - Backup dconf database files"
      copy:
        src: "{{ item.path }}"
        dest: "{{ state_guard_dir }}/{{ item.path | basename }}.present"
        remote_src: true
      loop: "{{ _sg_dconf_files.files }}"
      when: _sg_dconf_files.files | length > 0

    - name: "State Guard - Create checkpoint flag"
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        status_1: "SKIPPED"
        status_2: "SKIPPED"
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1

    - name: "Check if GDM is installed"
      shell: |
        rpm -q gdm
      args:
        executable: /bin/bash
      register: gdm_check
      ignore_errors: true
      changed_when: false

    - name: "Req 1 - Execute CIS remediation script for GDM disable-user-list"
      copy:
        dest: "/tmp/cis_remediation_1_8_3.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          
          {
             l_gdmprofile="gdm"
             if [ ! -f "/etc/dconf/profile/$l_gdmprofile" ]; then
                echo "Creating profile \"$l_gdmprofile\""
                echo -e "user-db:user\nsystem-db:$l_gdmprofile\nfile- db:/usr/share/$l_gdmprofile/greeter-dconf-defaults" > /etc/dconf/profile/$l_gdmprofile
             fi
             if [ ! -d "/etc/dconf/db/$l_gdmprofile.d/" ]; then
                echo "Creating dconf database directory \"/etc/dconf/db/$l_gdmprofile.d/\""
                mkdir /etc/dconf/db/$l_gdmprofile.d/
             fi
             if ! grep -Piq '^\h*disable-user-list\h*=\h*true\b' /etc/dconf/db/$l_gdmprofile.d/*; then
                echo "creating gdm keyfile for machine-wide settings"
                if ! grep -Piq -- '^\h*\[org\/gnome\/login-screen\]' /etc/dconf/db/$l_gdmprofile.d/*; then
                   echo -e "\n[org/gnome/login-screen]\n# Do not show the user list\ndisable-user-list=true" >> /etc/dconf/db/$l_gdmprofile.d/00-login- screen
                else
                   sed -ri '/^\s*\[org\/gnome\/login-screen\]/ a\# Do not show the user list\ndisable-user-list=true' $(grep -Pil -- '^\h*\[org\/gnome\/login- screen\]' /etc/dconf/db/$l_gdmprofile.d/*)
                fi
             fi
             dconf update
          }
          {% endraw %}
      register: script_create_1
      ignore_errors: true
      when: gdm_check.rc == 0

    - name: "Req 1 - Execute the remediation script"
      shell: |
        echo "=== BEFORE ==="
        cat /etc/dconf/profile/gdm 2>/dev/null || echo "File /etc/dconf/profile/gdm does not exist"
        echo "=== BEFORE dconf files ==="
        cat /etc/dconf/db/gdm.d/* 2>/dev/null || echo "No dconf db files found"
        echo "=== RUNNING SCRIPT ==="
        /tmp/cis_remediation_1_8_3.sh
        echo "=== AFTER ==="
        cat /etc/dconf/profile/gdm 2>/dev/null || echo "File /etc/dconf/profile/gdm does not exist"
        echo "=== AFTER dconf files ==="
        cat /etc/dconf/db/gdm.d/* 2>/dev/null || echo "No dconf db files found"
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      when: gdm_check.rc == 0

    - name: "Req 1 - Remove temporary remediation script"
      file:
        path: "/tmp/cis_remediation_1_8_3.sh"
        state: absent
      ignore_errors: true
      when: gdm_check.rc == 0

    - name: "Store requirement 1 details"
      set_fact:
        task_1_name: "Execute CIS remediation script for GDM disable-user-list"
        task_1_cmd: "Execute /tmp/cis_remediation_1_8_3.sh script"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% if gdm_check.rc != 0 %}
            SKIPPED
          {% elif result_1.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_1: >-
          {% if gdm_check.rc != 0 %}
            SKIPPED: GDM package is not installed, remediation not applicable
          {% elif result_1.rc | default(-1) == 0 %}
            APPLIED: Script executed successfully to enable disable-user-list option
          {% else %}
            FAILED: Script execution failed with exit code {{ result_1.rc | default(-1) }}
          {% endif %}
      when: gdm_check.rc == 0

    - name: "Req 2 - Run CIS audit procedure for GDM disable-user-list"
      shell: |
        {% raw %}
        # CIS audit procedure: Check if disable-user-list option is enabled in GDM
        if [ -d /etc/dconf/db/gdm.d/ ]; then
          if grep -Piq '^\h*disable-user-list\h*=\h*true\b' /etc/dconf/db/gdm.d/* 2>/dev/null; then
            echo "PASS: disable-user-list option is enabled"
            exit 0
          else
            echo "FAIL: disable-user-list option is not set to true"
            exit 1
          fi
        else
          echo "FAIL: GDM dconf database directory not found"
          exit 1
        fi
        {% endraw %}
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      when: gdm_check.rc == 0

    - name: "Store requirement 2 details"
      set_fact:
        task_2_name: "Run CIS audit procedure for GDM disable-user-list"
        task_2_cmd: "Check dconf database for disable-user-list=true using CIS audit pattern"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% if gdm_check.rc != 0 %}
            SKIPPED
          {% elif result_2.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_2: >-
          {% if gdm_check.rc != 0 %}
            SKIPPED: GDM package is not installed, verification not applicable
          {% elif result_2.rc | default(-1) == 0 %}
            APPLIED: CIS audit verification passed, disable-user-list option is enabled
          {% else %}
            FAILED: CIS audit verification failed, disable-user-list option is not properly configured
          {% endif %}
      when: gdm_check.rc == 0

    - name: "Set overall remediation status"
      set_fact:
        overall_status: >-
          {% if gdm_check.rc != 0 %}
            SKIPPED
          {% elif status_1 | trim == 'APPLIED' and status_2 | trim == 'APPLIED' %}
            APPLIED
          {% elif status_1 | trim == 'FAILED' or status_2 | trim == 'FAILED' %}
            FAILED
          {% else %}
            PARTIALLY APPLIED
          {% endif %}
        overall_details: >-
          {% if gdm_check.rc != 0 %}
            GDM package is not installed, remediation not applicable
          {% elif status_1 | trim == 'APPLIED' and status_2 | trim == 'APPLIED' %}
            Remediation successfully applied and verified. Note: Users will need to log out and log in for changes to take effect.
          {% elif status_1 | trim == 'FAILED' %}
            Remediation script failed to execute properly
          {% elif status_2 | trim == 'FAILED' %}
            Remediation script executed but CIS audit verification failed
          {% else %}
            Unexpected status combination
          {% endif %}

    - name: Generate remediation report
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 1.8.3"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: {{ overall_status | trim }}"
          - "  Details: {{ overall_details | trim }}"
          - "========================================================"