---
- name: Remediation for CIS 5.2.2 - Ensure sudo commands use pty
  hosts: all
  become: yes
  gather_facts: false
  vars:
    checkpoint_id: "cis_5_2_2"
    state_guard_dir: "/tmp/.cis_state_guard/{{ checkpoint_id }}"
    state_guard_flag: "{{ state_guard_dir }}/checkpoint.flag"
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 5.2.2"
    req_1: "Check if sudo is installed"
    req_2: "Apply 'Defaults use_pty' to main sudoers file"
    req_3: "Apply 'Defaults use_pty' to files in /etc/sudoers.d/"
    req_4: "Remove '!use_pty' from main sudoers file"
    req_5: "Remove '!use_pty' from files in /etc/sudoers.d/"
    req_6: "Verify sudo is configured to use pty"

  pre_tasks:
    - name: "State Guard - Check for existing checkpoint"
      stat:
        path: "{{ state_guard_flag }}"
      register: _sg_flag

    - name: "State Guard - Restore /etc/sudoers from backup"
      copy:
        src: "{{ state_guard_dir }}/sudoers.present"
        dest: "/etc/sudoers"
        remote_src: true
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Restore /etc/sudoers.d files from backup"
      copy:
        src: "{{ state_guard_dir }}/sudoers_d.tar.gz"
        dest: "/tmp/sudoers_d_backup.tar.gz"
        remote_src: true
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Extract sudoers.d backup"
      shell: |
        tar -xzf /tmp/sudoers_d_backup.tar.gz -C /etc/
      args:
        executable: /bin/bash
      when: _sg_flag.stat.exists
      ignore_errors: true

    - name: "State Guard - Remove old checkpoint"
      file:
        path: "{{ state_guard_dir }}"
        state: absent
      when: _sg_flag.stat.exists

    - name: "State Guard - Create checkpoint directory"
      file:
        path: "{{ state_guard_dir }}"
        state: directory
        mode: '0700'

    - name: "State Guard - Check if /etc/sudoers exists"
      stat:
        path: "/etc/sudoers"
      register: _sg_sudoers_stat

    - name: "State Guard - Backup /etc/sudoers if exists"
      copy:
        src: "/etc/sudoers"
        dest: "{{ state_guard_dir }}/sudoers.present"
        remote_src: true
      when: _sg_sudoers_stat.stat.exists

    - name: "State Guard - Mark /etc/sudoers as absent if not exists"
      copy:
        content: "absent"
        dest: "{{ state_guard_dir }}/sudoers.absent"
      when: not _sg_sudoers_stat.stat.exists

    - name: "State Guard - Backup /etc/sudoers.d directory"
      shell: |
        if [ -d /etc/sudoers.d ]; then
          tar -czf "{{ state_guard_dir }}/sudoers_d.tar.gz" -C /etc sudoers.d
        else
          echo "sudoers.d directory does not exist"
        fi
      args:
        executable: /bin/bash
      ignore_errors: true

    - name: "State Guard - Create checkpoint flag"
      copy:
        content: "checkpoint"
        dest: "{{ state_guard_flag }}"

  tasks:
    - name: Initialize data variables
      set_fact:
        data_1: ""
        data_2: ""
        data_3: ""
        data_4: ""
        data_5: ""
        data_6: ""
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1
        task_6_name: "Not executed"
        task_6_cmd: "N/A"
        task_6_rc: -1

    - name: "Req 1 - Check if sudo is installed"
      shell: |
        rpm -q sudo
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check sudo package installation"
        task_1_cmd: "rpm -q sudo"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: >-
          {% if result_1.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            SKIPPED
          {% endif %}
        rationale_1: >-
          {% if result_1.rc | default(-1) == 0 %}
            APPLIED: sudo package is installed, continuing with remediation
          {% else %}
            SKIPPED: sudo package not installed, skipping all subsequent steps
          {% endif %}
        sudo_installed: "{{ result_1.rc | default(-1) == 0 }}"

    - name: "Req 2 - Apply 'Defaults use_pty' to main sudoers file (correct placement)"
      shell: |
        echo "=== BEFORE ==="
        cat /etc/sudoers
        echo "=== APPLYING CHANGE ==="
        # Check if Defaults use_pty already exists
        if ! grep -q '^Defaults use_pty' /etc/sudoers; then
          # Create a temporary file with the line inserted BEFORE #includedir
          # We need to place Defaults use_pty before the #includedir directive
          # Using sed to insert before the line containing #includedir
          if grep -q '^#includedir' /etc/sudoers; then
            # Insert before #includedir line
            sed -i '/^#includedir/i Defaults use_pty' /etc/sudoers
          else
            # If no #includedir line, append to end (fallback)
            echo 'Defaults use_pty' | EDITOR='tee -a' visudo
          fi
          # Verify syntax
          visudo -c
        else
          echo "Defaults use_pty already exists in /etc/sudoers"
        fi
        echo "=== AFTER ==="
        cat /etc/sudoers
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      when: sudo_installed | default(false)

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Add Defaults use_pty to /etc/sudoers (before #includedir)"
        task_2_cmd: "Insert 'Defaults use_pty' before #includedir line using sed or append if #includedir not found"
        task_2_rc: "{{ result_2.rc | default(-1) }}"
        data_2: "{{ result_2.stdout | default('') | trim }}"
        status_2: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED
          {% elif result_2.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_2: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED: sudo not installed
          {% elif result_2.rc | default(-1) == 0 %}
            APPLIED: Defaults use_pty line added to /etc/sudoers before #includedir directive
          {% else %}
            FAILED: Could not modify /etc/sudoers or syntax check failed
          {% endif %}

    - name: "Req 3 - Apply 'Defaults use_pty' to files in /etc/sudoers.d/"
      shell: |
        echo "=== BEFORE ==="
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ]; then
            echo "File: $f"
            cat "$f"
          fi
        done
        echo "=== APPLYING CHANGE ==="
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ] && ! grep -q '^Defaults use_pty' "$f"; then
            echo 'Defaults use_pty' | EDITOR='tee -a' visudo -f "$f"
          fi
        done
        echo "=== AFTER ==="
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ]; then
            echo "File: $f"
            cat "$f"
          fi
        done
      args:
        executable: /bin/bash
      register: result_3
      ignore_errors: true
      when: sudo_installed | default(false)

    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Add Defaults use_pty to /etc/sudoers.d/* files"
        task_3_cmd: |
          for f in /etc/sudoers.d/*; do if [ -f \"$f\" ] && ! grep -q '^Defaults use_pty' \"$f\"; then echo 'Defaults use_pty' | EDITOR='tee -a' visudo -f \"$f\"; fi; done
        task_3_rc: "{{ result_3.rc | default(-1) }}"
        data_3: "{{ result_3.stdout | default('') | trim }}"
        status_3: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED
          {% elif result_3.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_3: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED: sudo not installed
          {% elif result_3.rc | default(-1) == 0 %}
            APPLIED: Defaults use_pty line added to any /etc/sudoers.d/ files that did not have it
          {% else %}
            FAILED: Could not modify /etc/sudoers.d/ files
          {% endif %}

    - name: "Req 4 - Remove '!use_pty' from main sudoers file"
      shell: |
        echo "=== BEFORE ==="
        cat /etc/sudoers
        echo "=== APPLYING CHANGE ==="
        sed -i '/^Defaults.*!use_pty/d' /etc/sudoers
        echo "=== AFTER ==="
        cat /etc/sudoers
      args:
        executable: /bin/bash
      register: result_4
      ignore_errors: true
      when: sudo_installed | default(false)

    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Remove !use_pty from /etc/sudoers"
        task_4_cmd: "sed -i '/^Defaults.*!use_pty/d' /etc/sudoers"
        task_4_rc: "{{ result_4.rc | default(-1) }}"
        data_4: "{{ result_4.stdout | default('') | trim }}"
        status_4: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED
          {% elif result_4.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_4: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED: sudo not installed
          {% elif result_4.rc | default(-1) == 0 %}
            APPLIED: Any line starting with Defaults and containing !use_pty removed from /etc/sudoers
          {% else %}
            FAILED: Could not remove !use_pty from /etc/sudoers
          {% endif %}

    - name: "Req 5 - Remove '!use_pty' from files in /etc/sudoers.d/"
      shell: |
        echo "=== BEFORE ==="
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ]; then
            echo "File: $f"
            cat "$f"
          fi
        done
        echo "=== APPLYING CHANGE ==="
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ]; then
            sed -i '/^Defaults.*!use_pty/d' "$f"
          fi
        done
        echo "=== AFTER ==="
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ]; then
            echo "File: $f"
            cat "$f"
          fi
        done
      args:
        executable: /bin/bash
      register: result_5
      ignore_errors: true
      when: sudo_installed | default(false)

    - name: Store requirement 5 details
      set_fact:
        task_5_name: "Remove !use_pty from /etc/sudoers.d/* files"
        task_5_cmd: |
          for f in /etc/sudoers.d/*; do if [ -f \"$f\" ]; then sed -i '/^Defaults.*!use_pty/d' \"$f\"; fi; done
        task_5_rc: "{{ result_5.rc | default(-1) }}"
        data_5: "{{ result_5.stdout | default('') | trim }}"
        status_5: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED
          {% elif result_5.rc | default(-1) == 0 %}
            APPLIED
          {% else %}
            FAILED
          {% endif %}
        rationale_5: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED: sudo not installed
          {% elif result_5.rc | default(-1) == 0 %}
            APPLIED: Any line starting with Defaults and containing !use_pty removed from all files in /etc/sudoers.d/
          {% else %}
            FAILED: Could not remove !use_pty from /etc/sudoers.d/ files
          {% endif %}

    - name: "Req 6 - Verify sudo is configured to use pty (fixed grep pattern)"
      shell: |
        echo "=== CHECKING SUDOERS SYNTAX ==="
        if ! visudo -c; then
          echo "ERROR: Syntax error in main sudoers file"
          exit 2
        fi
        
        for f in /etc/sudoers.d/*; do
          if [ -f "$f" ]; then
            if ! visudo -c -f "$f"; then
              echo "ERROR: Syntax error in $f"
              exit 3
            fi
          fi
        done
        
        echo "=== FULL SUDO -V OUTPUT ==="
        sudo -V 2>&1
        echo "=== CHECKING USE_PTY SETTING ==="
        # Look for 'pseudo-tty' in output instead of 'use_pty'
        sudo -V 2>&1 | grep -E 'pseudo-tty'
      args:
        executable: /bin/bash
      register: result_6
      ignore_errors: true
      when: sudo_installed | default(false)
      changed_when: false

    - name: Store requirement 6 details
      set_fact:
        task_6_name: "Verify sudo use_pty configuration"
        task_6_cmd: "sudo -V 2>&1 | grep -E 'pseudo-tty'"
        task_6_rc: "{{ result_6.rc | default(-1) }}"
        data_6: "{{ result_6.stdout | default('') | trim }}"
        status_6: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED
          {% elif result_6.rc | default(-1) == 0 %}
            APPLIED
          {% elif result_6.rc | default(-1) == 1 %}
            FAILED
          {% elif result_6.rc | default(-1) in [2, 3] %}
            FAILED
          {% else %}
            UNKNOWN
          {% endif %}
        rationale_6: >-
          {% if not (sudo_installed | default(false)) %}
            SKIPPED: sudo not installed
          {% elif result_6.rc | default(-1) == 0 %}
            APPLIED: sudoers files syntax is correct and pseudo-tty setting is active
          {% elif result_6.rc | default(-1) == 1 %}
            FAILED: pseudo-tty setting not found in sudo configuration
          {% elif result_6.rc | default(-1) == 2 %}
            FAILED: Syntax error in main sudoers file
          {% elif result_6.rc | default(-1) == 3 %}
            FAILED: Syntax error in /etc/sudoers.d/ file
          {% else %}
            UNKNOWN: Error during verification (exit code {{ result_6.rc | default(-1) }})
          {% endif %}

    - name: Generate remediation report
      debug:
        msg: |
          ========================================================
                  REMEDIATION REPORT - CIS 5.2.2
          ========================================================
          Reference: {{ kcs_article }}
          ========================================================

          REQUIREMENT 1 - {{ req_1 }}:
            Task: {{ task_1_name | default('Task not recorded') }}
            Command: {{ task_1_cmd | default('N/A') }}
            Exit code: {{ task_1_rc | default(-1) }}
            Data: {{ data_1 | default('') | trim }}
            Status: {{ status_1 | default('UNKNOWN') | trim }}
            Details: {{ rationale_1 | default('Not evaluated') | trim }}

          REQUIREMENT 2 - {{ req_2 }}:
            Task: {{ task_2_name | default('Task not recorded') }}
            Command: {{ task_2_cmd | default('N/A') }}
            Exit code: {{ task_2_rc | default(-1) }}
            Data: {{ data_2 | default('') | trim }}
            Status: {{ status_2 | default('UNKNOWN') | trim }}
            Details: {{ rationale_2 | default('Not evaluated') | trim }}

          REQUIREMENT 3 - {{ req_3 }}:
            Task: {{ task_3_name | default('Task not recorded') }}
            Command: {{ task_3_cmd | default('N/A') }}
            Exit code: {{ task_3_rc | default(-1) }}
            Data: {{ data_3 | default('') | trim }}
            Status: {{ status_3 | default('UNKNOWN') | trim }}
            Details: {{ rationale_3 | default('Not evaluated') | trim }}

          REQUIREMENT 4 - {{ req_4 }}:
            Task: {{ task_4_name | default('Task not recorded') }}
            Command: {{ task_4_cmd | default('N/A') }}
            Exit code: {{ task_4_rc | default(-1) }}
            Data: {{ data_4 | default('') | trim }}
            Status: {{ status_4 | default('UNKNOWN') | trim }}
            Details: {{ rationale_4 | default('Not evaluated') | trim }}

          REQUIREMENT 5 - {{ req_5 }}:
            Task: {{ task_5_name | default('Task not recorded') }}
            Command: {{ task_5_cmd | default('N/A') }}
            Exit code: {{ task_5_rc | default(-1) }}
            Data: {{ data_5 | default('') | trim }}
            Status: {{ status_5 | default('UNKNOWN') | trim }}
            Details: {{ rationale_5 | default('Not evaluated') | trim }}

          REQUIREMENT 6 - {{ req_6 }}:
            Task: {{ task_6_name | default('Task not recorded') }}
            Command: {{ task_6_cmd | default('N/A') }}
            Exit code: {{ task_6_rc | default(-1) }}
            Data: {{ data_6 | default('') | trim }}
            Status: {{ status_6 | default('UNKNOWN') | trim }}
            Details: {{ rationale_6 | default('Not evaluated') | trim }}

          ========================================================
          OVERALL REMEDIATION:
            Result: {{ ('SKIPPED' if status_1 | trim == 'SKIPPED' else ('APPLIED' if status_2 | trim == 'APPLIED' and status_3 | trim == 'APPLIED' and status_4 | trim == 'APPLIED' and status_5 | trim == 'APPLIED' and status_6 | trim == 'APPLIED' else 'FAILED')) | trim }}
            Details: {{ ('SKIPPED: sudo package not installed, remediation not applicable' if status_1 | trim == 'SKIPPED' else ('APPLIED: sudo is configured to use a pseudo-tty for all commands' if status_2 | trim == 'APPLIED' and status_3 | trim == 'APPLIED' and status_4 | trim == 'APPLIED' and status_5 | trim == 'APPLIED' and status_6 | trim == 'APPLIED' else 'FAILED: One or more remediation steps failed. Check individual requirement statuses for details.')) | trim }}
          ========================================================