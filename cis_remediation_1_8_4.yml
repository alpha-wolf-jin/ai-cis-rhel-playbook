---
- name: Remediation for CIS 1.8.4 - Ensure GDM screen locks when the user is idle
  hosts: all
  become: yes
  gather_facts: false
  vars:
    kcs_article: "CIS RHEL 9 Benchmark v2.0.0 checkpoint 1.8.4"
    req_1: "Check if GDM is installed"
    req_2: "Create or edit /etc/dconf/profile/user with required entries"
    req_3: "Create /etc/dconf/db/local.d directory if it doesn't exist"
    req_4: "Execute CIS remediation script to configure idle and lock delays"
    req_5: "Run dconf update to update system databases"
    req_6: "Verify GDM screen lock configuration is compliant"

  tasks:
    - name: Initialize data variables
      set_fact:
        task_1_name: "Not executed"
        task_1_cmd: "N/A"
        task_1_rc: -1
        task_2_name: "Not executed"
        task_2_cmd: "N/A"
        task_2_rc: -1
        task_3_name: "Not executed"
        task_3_cmd: "N/A"
        task_3_rc: -1
        task_4_name: "Not executed"
        task_4_cmd: "N/A"
        task_4_rc: -1
        task_5_name: "Not executed"
        task_5_cmd: "N/A"
        task_5_rc: -1
        task_6_name: "Not executed"
        task_6_cmd: "N/A"
        task_6_rc: -1

    # Requirement 1: Check if GDM is installed
    - name: Req 1 - Check if GDM is installed
      shell: |
        rpm -q gdm
      args:
        executable: /bin/bash
      register: result_1
      ignore_errors: true
      changed_when: false

    - name: Store requirement 1 details
      set_fact:
        task_1_name: "Check GDM package installation"
        task_1_cmd: "rpm -q gdm"
        task_1_rc: "{{ result_1.rc | default(-1) }}"
        data_1: "{{ result_1.stdout | default('') | trim }}"
        status_1: "{{ ('SKIPPED' if (result_1.rc | default(-1) != 0) else 'APPLIED') | trim }}"
        rationale_1: "{{ ('SKIPPED: GDM package not installed - remediation not applicable' if (result_1.rc | default(-1) != 0) else 'APPLIED: GDM is installed') | trim }}"
        gdm_installed: "{{ result_1.rc | default(-1) == 0 }}"

    # Requirement 2: Create or edit /etc/dconf/profile/user with required entries
    - name: Req 2 - Create or edit /etc/dconf/profile/user with required entries
      shell: |
        if ! grep -q "system-db:local" /etc/dconf/profile/user 2>/dev/null; then
          echo -e '\nuser-db:user\nsystem-db:local' >> /etc/dconf/profile/user
        fi
      args:
        executable: /bin/bash
      register: result_2
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Store requirement 2 details
      set_fact:
        task_2_name: "Ensure dconf profile includes system-db:local"
        task_2_cmd: "Add user-db:user and system-db:local to /etc/dconf/profile/user"
        task_2_rc: "{{ result_2.rc | default(-1) if gdm_installed | default(false) else -1 }}"
        data_2: "{{ result_2.stdout | default('') | trim if gdm_installed | default(false) else '' }}"
        status_2: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED
          {% else %}
            {{ ('APPLIED' if result_2.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_2: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED: GDM not installed, remediation not applicable
          {% else %}
            {{ ('APPLIED: dconf profile configured' if result_2.rc | default(-1) == 0 else 'FAILED: Could not configure dconf profile') | trim }}
          {% endif %}

    # Requirement 3: Create /etc/dconf/db/local.d directory if it doesn't exist
    - name: Req 3 - Create /etc/dconf/db/local.d directory if it doesn't exist
      file:
        path: /etc/dconf/db/local.d
        state: directory
        mode: '0755'
      register: result_3
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Store requirement 3 details
      set_fact:
        task_3_name: "Create dconf database directory"
        task_3_cmd: "mkdir -p /etc/dconf/db/local.d"
        task_3_rc: "{{ result_3.rc | default(-1) if gdm_installed | default(false) else -1 }}"
        data_3: "{{ ('Directory created' if result_3.changed else 'Directory already exists') if gdm_installed | default(false) else '' }}"
        status_3: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED
          {% else %}
            {{ ('APPLIED' if result_3.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_3: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED: GDM not installed, remediation not applicable
          {% else %}
            {{ ('APPLIED: dconf database directory created' if result_3.rc | default(-1) == 0 else 'FAILED: Could not create dconf database directory') | trim }}
          {% endif %}

    # Requirement 4: Execute CIS remediation script to configure idle and lock delays
    - name: Req 4 - Execute CIS remediation script to configure idle and lock delays
      copy:
        dest: "/tmp/cis_remediation_1.8.4.sh"
        mode: '0700'
        content: |
          {% raw %}
          #!/usr/bin/env bash
          {
             l_key_file="/etc/dconf/db/local.d/00-screensaver"
             l_idmv="900" # Set max value for idle-delay in seconds (between 1 and 900)
             l_ldmv="5" # Set max value for lock-delay in seconds (between 0 and 5)
             {
                echo '# Specify the dconf path'
                echo '[org/gnome/desktop/session]'
                echo ''
                echo '# Number of seconds of inactivity before the screen goes blank'
                echo '# Set to 0 seconds if you want to deactivate the screensaver.'
                echo "idle-delay=uint32 $l_idmv"
                echo ''
                echo '# Specify the dconf path'
                echo '[org/gnome/desktop/screensaver]'
                echo ''
                echo '# Number of seconds after the screen is blank before locking the screen'
                echo "lock-delay=uint32 $l_ldmv"
             } > "$l_key_file"
          }
          {% endraw %}
      register: script_create_4
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Req 4 - Execute the remediation script
      shell: "/tmp/cis_remediation_1.8.4.sh"
      args:
        executable: /bin/bash
      register: result_4
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Req 4 - Remove temporary remediation script
      file:
        path: "/tmp/cis_remediation_1.8.4.sh"
        state: absent
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Store requirement 4 details
      set_fact:
        task_4_name: "Run CIS remediation script to configure screen lock settings"
        task_4_cmd: "Execute /tmp/cis_remediation_1.8.4.sh"
        task_4_rc: "{{ result_4.rc | default(-1) if gdm_installed | default(false) else -1 }}"
        data_4: "{{ result_4.stdout | default('') | trim if gdm_installed | default(false) else '' }}"
        status_4: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED
          {% else %}
            {{ ('APPLIED' if result_4.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_4: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED: GDM not installed, remediation not applicable
          {% else %}
            {{ ('APPLIED: Screen lock configuration applied via CIS script' if result_4.rc | default(-1) == 0 else 'FAILED: Could not apply screen lock configuration') | trim }}
          {% endif %}

    # Requirement 5: Run dconf update to update system databases
    - name: Req 5 - Run dconf update to update system databases
      shell: |
        dconf update
      args:
        executable: /bin/bash
      register: result_5
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Store requirement 5 details
      set_fact:
        task_5_name: "Update dconf system databases"
        task_5_cmd: "dconf update"
        task_5_rc: "{{ result_5.rc | default(-1) if gdm_installed | default(false) else -1 }}"
        data_5: "{{ result_5.stdout | default('') | trim if gdm_installed | default(false) else '' }}"
        status_5: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED
          {% else %}
            {{ ('APPLIED' if result_5.rc | default(-1) == 0 else 'FAILED') | trim }}
          {% endif %}
        rationale_5: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED: GDM not installed, remediation not applicable
          {% else %}
            {{ ('APPLIED: dconf databases updated' if result_5.rc | default(-1) == 0 else 'FAILED: Could not update dconf databases') | trim }}
          {% endif %}

    # Requirement 6: Verify GDM screen lock configuration is compliant
    - name: Req 6 - Verify GDM screen lock configuration is compliant
      shell: |
        # Check if the configuration file exists and has correct values
        if [ -f /etc/dconf/db/local.d/00-screensaver ]; then
          grep -q "idle-delay=uint32 900" /etc/dconf/db/local.d/00-screensaver && \
          grep -q "lock-delay=uint32 5" /etc/dconf/db/local.d/00-screensaver
          if [ $? -eq 0 ]; then
            echo "COMPLIANT: Screen lock configuration is correctly set"
          else
            echo "NON-COMPLIANT: Screen lock configuration is incorrect"
          fi
        else
          echo "NON-COMPLIANT: Configuration file not found"
        fi
      args:
        executable: /bin/bash
      register: result_6
      ignore_errors: true
      when: gdm_installed | default(false)

    - name: Store requirement 6 details
      set_fact:
        task_6_name: "Verify screen lock configuration compliance"
        task_6_cmd: "Check /etc/dconf/db/local.d/00-screensaver for correct idle-delay and lock-delay values"
        task_6_rc: "{{ result_6.rc | default(-1) if gdm_installed | default(false) else -1 }}"
        data_6: "{{ result_6.stdout | default('') | trim if gdm_installed | default(false) else '' }}"
        status_6: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED
          {% else %}
            {% set output = result_6.stdout | default('') | trim %}
            {% if 'COMPLIANT' in output %}
              APPLIED
            {% else %}
              FAILED
            {% endif %}
          {% endif %}
        rationale_6: >-
          {% if not gdm_installed | default(false) %}
            SKIPPED: GDM not installed, remediation not applicable
          {% else %}
            {% set output = result_6.stdout | default('') | trim %}
            {% if 'COMPLIANT' in output %}
              APPLIED: System is compliant with CIS 1.8.4 after remediation
            {% else %}
              FAILED: System is not compliant with CIS 1.8.4
            {% endif %}
          {% endif %}

    # Final report
    - name: Generate remediation report
      debug:
        msg:
          - "========================================================"
          - "        REMEDIATION REPORT - CIS 1.8.4"
          - "========================================================"
          - "Reference: {{ kcs_article }}"
          - "========================================================"
          - ""
          - "REQUIREMENT 1 - {{ req_1 }}:"
          - "  Task: {{ task_1_name | default('Task not recorded') }}"
          - "  Command: {{ task_1_cmd | default('N/A') }}"
          - "  Exit code: {{ task_1_rc | default(-1) }}"
          - "  Data: {{ data_1 | default('') | trim }}"
          - "  Status: {{ status_1 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_1 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 2 - {{ req_2 }}:"
          - "  Task: {{ task_2_name | default('Task not recorded') }}"
          - "  Command: {{ task_2_cmd | default('N/A') }}"
          - "  Exit code: {{ task_2_rc | default(-1) }}"
          - "  Data: {{ data_2 | default('') | trim }}"
          - "  Status: {{ status_2 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_2 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 3 - {{ req_3 }}:"
          - "  Task: {{ task_3_name | default('Task not recorded') }}"
          - "  Command: {{ task_3_cmd | default('N/A') }}"
          - "  Exit code: {{ task_3_rc | default(-1) }}"
          - "  Data: {{ data_3 | default('') | trim }}"
          - "  Status: {{ status_3 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_3 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 4 - {{ req_4 }}:"
          - "  Task: {{ task_4_name | default('Task not recorded') }}"
          - "  Command: {{ task_4_cmd | default('N/A') }}"
          - "  Exit code: {{ task_4_rc | default(-1) }}"
          - "  Data: {{ data_4 | default('') | trim }}"
          - "  Status: {{ status_4 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_4 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 5 - {{ req_5 }}:"
          - "  Task: {{ task_5_name | default('Task not recorded') }}"
          - "  Command: {{ task_5_cmd | default('N/A') }}"
          - "  Exit code: {{ task_5_rc | default(-1) }}"
          - "  Data: {{ data_5 | default('') | trim }}"
          - "  Status: {{ status_5 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_5 | default('Not evaluated') | trim }}"
          - ""
          - "REQUIREMENT 6 - {{ req_6 }}:"
          - "  Task: {{ task_6_name | default('Task not recorded') }}"
          - "  Command: {{ task_6_cmd | default('N/A') }}"
          - "  Exit code: {{ task_6_rc | default(-1) }}"
          - "  Data: {{ data_6 | default('') | trim }}"
          - "  Status: {{ status_6 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_6 | default('Not evaluated') | trim }}"
          - ""
          - "========================================================"
          - "OVERALL REMEDIATION:"
          - "  Result: {{ status_6 | default('UNKNOWN') | trim }}"
          - "  Details: {{ rationale_6 | default('Not evaluated') | trim }}"
          - "========================================================"